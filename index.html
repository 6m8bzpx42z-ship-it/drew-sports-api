<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>NFL Scores</title>
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;NFL Scores&quot;,&quot;short_name&quot;:&quot;NFL&quot;,&quot;display&quot;:&quot;standalone&quot;}">
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #2d3748;
            --bg-card-hover: #3d4a5c;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --text-muted: #718096;
            --accent-primary: #ff6b6b;
            --accent-secondary: #feca57;
            --accent-success: #68d391;
            --accent-danger: #fc8181;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --bottom-nav-height: 70px;
        }

        [data-theme="light"] {
            --bg-primary: #f7fafc;
            --bg-secondary: #edf2f7;
            --bg-card: #ffffff;
            --bg-card-hover: #f0f0f0;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            min-height: 100dvh;
            color: var(--text-primary);
            padding: 0;
            padding-top: var(--safe-area-top);
            padding-bottom: calc(var(--bottom-nav-height) + var(--safe-area-bottom));
            transition: background 0.3s, color 0.3s;
            overscroll-behavior-y: contain;
        }

        [data-theme="light"] body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 15px;
            padding-bottom: 20px;
        }

        /* Header */
        header {
            position: sticky;
            top: 0;
            background: linear-gradient(180deg, var(--bg-primary) 0%, rgba(26, 26, 46, 0.95) 100%);
            z-index: 100;
            padding: 15px 15px 10px;
            margin: -15px -15px 15px -15px;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-color);
        }

        [data-theme="light"] header {
            background: linear-gradient(180deg, var(--bg-primary) 0%, rgba(247, 250, 252, 0.95) 100%);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        h1 {
            font-size: 1.8rem;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .theme-toggle {
            background: var(--bg-card);
            border: none;
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: var(--bg-card-hover);
            transform: scale(1.1);
        }

        /* Date Navigation */
        .date-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .date-nav button {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 14px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            min-width: 48px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .date-nav button:hover {
            background: var(--bg-card-hover);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .date-nav button:active {
            transform: scale(0.95);
        }

        .current-date {
            font-size: 1rem;
            color: var(--text-secondary);
            text-align: center;
            min-width: 180px;
        }

        /* Swipe indicator */
        .swipe-hint {
            text-align: center;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 5px;
            opacity: 0.7;
        }

        /* Pull to refresh indicator */
        .pull-indicator {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            background: var(--accent-success);
            color: var(--bg-primary);
            padding: 10px 20px;
            border-radius: 0 0 15px 15px;
            font-size: 0.85rem;
            font-weight: 500;
            z-index: 1000;
            transition: transform 0.3s;
        }

        .pull-indicator.visible {
            transform: translateX(-50%) translateY(0);
        }

        /* Quick settings bar */
        .quick-settings {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding: 5px 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .quick-settings::-webkit-scrollbar {
            display: none;
        }

        .quick-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 10px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.8rem;
            white-space: nowrap;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .quick-btn:hover {
            background: var(--bg-card-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .quick-btn.active {
            background: var(--accent-success);
            color: var(--bg-primary);
            border-color: var(--accent-success);
        }

        .quick-btn .icon {
            font-size: 1rem;
        }

        /* Team selector - mobile optimized */
        .favorite-team-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .favorite-team-section label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: block;
            margin-bottom: 8px;
        }

        .favorite-team-select {
            width: 100%;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }

        .favorite-team-select:focus {
            outline: none;
            border-color: var(--accent-success);
            box-shadow: 0 0 0 3px rgba(104, 211, 145, 0.2);
        }

        /* Games Container */
        .games-container {
            display: grid;
            gap: 12px;
        }

        /* Game Card - Mobile First */
        .game-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 15px;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            touch-action: pan-y;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
        }

        .game-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .game-card:active {
            transform: scale(0.98);
        }

        .game-card.favorite-team {
            border: 2px solid var(--accent-success);
            box-shadow: 0 0 20px rgba(104, 211, 145, 0.2);
        }

        .game-card.team-colored {
            border-left: 4px solid var(--away-color, #666);
            border-right: 4px solid var(--home-color, #666);
            background: linear-gradient(
                135deg,
                color-mix(in srgb, var(--away-color, #666) 8%, var(--bg-card)) 0%,
                var(--bg-card) 50%,
                color-mix(in srgb, var(--home-color, #666) 8%, var(--bg-card)) 100%
            );
        }

        .game-card.team-colored.favorite-team {
            border: 2px solid var(--accent-success);
            border-left: 4px solid var(--away-color, #666);
            border-right: 4px solid var(--home-color, #666);
        }

        .favorite-badge {
            position: absolute;
            top: -8px;
            left: 15px;
            background: var(--accent-success);
            color: var(--bg-primary);
            font-size: 0.65rem;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Mobile-first game layout */
        .game-layout {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .teams-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .team-block {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            text-align: center;
        }

        .team-block.away {
            align-items: flex-start;
            text-align: left;
        }

        .team-block.home {
            align-items: flex-end;
            text-align: right;
        }

        .team-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .team-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .team-record {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .score-block {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
        }

        .scores-display {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 2rem;
            font-weight: 700;
        }

        .score {
            min-width: 40px;
            text-align: center;
        }

        .score.winner {
            color: var(--accent-success);
        }

        .score.loser {
            color: var(--text-muted);
        }

        .score-divider {
            color: var(--text-muted);
            font-weight: 400;
        }

        .game-status {
            font-size: 0.8rem;
            color: var(--accent-secondary);
            margin-top: 3px;
            font-weight: 500;
        }

        .game-status.final {
            color: var(--text-muted);
        }

        .game-status.live {
            color: var(--accent-danger);
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .live-dot {
            width: 10px;
            height: 10px;
            background: var(--accent-danger);
            border-radius: 50%;
            animation: livePulse 1.5s infinite;
            box-shadow: 0 0 8px var(--accent-danger);
        }

        @keyframes livePulse {
            0%, 100% { opacity: 1; transform: scale(1); box-shadow: 0 0 8px var(--accent-danger); }
            50% { opacity: 0.7; transform: scale(0.85); box-shadow: 0 0 15px var(--accent-danger); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        /* Countdown timer */
        .countdown {
            font-size: 0.75rem;
            color: var(--accent-secondary);
            margin-top: 5px;
            font-weight: 500;
        }

        /* Game details section */
        .game-details {
            border-top: 1px solid var(--border-color);
            padding-top: 12px;
            margin-top: 5px;
        }

        .detail-row {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 8px;
        }

        .detail-chip {
            background: rgba(0, 0, 0, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        [data-theme="light"] .detail-chip {
            background: rgba(0, 0, 0, 0.05);
        }

        .detail-chip .icon {
            font-size: 0.9rem;
        }

        .detail-chip .label {
            color: var(--text-muted);
            font-size: 0.65rem;
            text-transform: uppercase;
        }

        .detail-chip .value {
            color: var(--text-secondary);
        }

        /* Weather */
        .weather-chip {
            background: rgba(0, 0, 0, 0.3);
        }

        .weather-chip.dome {
            background: rgba(100, 100, 255, 0.2);
        }

        /* Odds */
        .odds-row {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .odds-item {
            text-align: center;
        }

        .odds-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .odds-value {
            font-size: 0.85rem;
            color: var(--accent-success);
            font-weight: 600;
        }

        /* Expandable sections */
        .expand-btn {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border: none;
            color: var(--text-secondary);
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        [data-theme="light"] .expand-btn {
            background: rgba(0, 0, 0, 0.05);
        }

        .expand-btn:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .expand-btn .arrow {
            transition: transform 0.3s;
        }

        .expand-btn.expanded .arrow {
            transform: rotate(180deg);
        }

        .expandable-content {
            display: none;
            margin-top: 12px;
            animation: slideDown 0.3s ease;
        }

        .expandable-content.show {
            display: block;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Quarter scores */
        .quarter-scores {
            overflow-x: auto;
            margin-bottom: 15px;
        }

        .quarter-table {
            width: 100%;
            font-size: 0.75rem;
            border-collapse: collapse;
            min-width: 280px;
        }

        .quarter-table th,
        .quarter-table td {
            padding: 6px 8px;
            text-align: center;
        }

        .quarter-table th {
            color: var(--text-muted);
            font-weight: 500;
        }

        .quarter-table td {
            color: var(--text-secondary);
        }

        .quarter-table .team-col {
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
        }

        .quarter-table .total-col {
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Player stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }

        [data-theme="light"] .stat-card {
            background: rgba(0, 0, 0, 0.05);
        }

        .stat-type {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .stat-player {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .stat-headshot {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--bg-primary);
        }

        .stat-name {
            font-size: 0.7rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .stat-value {
            font-size: 0.65rem;
            color: var(--accent-success);
        }

        /* Box Score Styles */
        .boxscore-container {
            margin-top: 15px;
        }

        .boxscore-team-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .boxscore-team-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.2);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
        }

        [data-theme="light"] .boxscore-team-tab {
            background: rgba(0, 0, 0, 0.05);
        }

        .boxscore-team-tab.active {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--team-color, var(--accent-secondary));
            color: var(--text-primary);
        }

        [data-theme="light"] .boxscore-team-tab.active {
            background: rgba(0, 0, 0, 0.08);
        }

        .boxscore-team-tab img {
            width: 24px;
            height: 24px;
        }

        .boxscore-team-content {
            display: none;
        }

        .boxscore-team-content.active {
            display: block;
        }

        .boxscore-category {
            margin-bottom: 12px;
        }

        .boxscore-category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: background 0.2s;
        }

        [data-theme="light"] .boxscore-category-header {
            background: rgba(0, 0, 0, 0.08);
        }

        .boxscore-category-header:hover {
            background: rgba(0, 0, 0, 0.4);
        }

        [data-theme="light"] .boxscore-category-header:hover {
            background: rgba(0, 0, 0, 0.12);
        }

        .boxscore-category-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .boxscore-category-arrow {
            color: var(--text-muted);
            font-size: 0.7rem;
            transition: transform 0.3s;
        }

        .boxscore-category.expanded .boxscore-category-arrow {
            transform: rotate(180deg);
        }

        .boxscore-players {
            background: rgba(0, 0, 0, 0.15);
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }

        [data-theme="light"] .boxscore-players {
            background: rgba(0, 0, 0, 0.03);
        }

        .boxscore-player-row {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
        }

        [data-theme="light"] .boxscore-player-row {
            border-bottom-color: rgba(0, 0, 0, 0.05);
        }

        .boxscore-player-row:last-child {
            border-bottom: none;
        }

        .boxscore-player-row:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        [data-theme="light"] .boxscore-player-row:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .boxscore-player-main {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .boxscore-player-headshot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--bg-primary);
            flex-shrink: 0;
        }

        .boxscore-player-info {
            flex: 1;
            min-width: 0;
        }

        .boxscore-player-name {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .boxscore-player-position {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .boxscore-player-compact-stats {
            display: flex;
            gap: 12px;
            flex-shrink: 0;
        }

        .boxscore-compact-stat {
            text-align: center;
        }

        .boxscore-compact-stat-value {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-success);
        }

        .boxscore-compact-stat-label {
            font-size: 0.55rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .boxscore-player-expand-icon {
            color: var(--text-muted);
            font-size: 0.7rem;
            transition: transform 0.3s;
            margin-left: 8px;
        }

        .boxscore-player-row.expanded .boxscore-player-expand-icon {
            transform: rotate(180deg);
        }

        .boxscore-player-details {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        [data-theme="light"] .boxscore-player-details {
            border-top-color: rgba(0, 0, 0, 0.1);
        }

        .boxscore-player-row.expanded .boxscore-player-details {
            display: block;
        }

        .boxscore-detail-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .boxscore-detail-stat {
            text-align: center;
            padding: 6px 4px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        [data-theme="light"] .boxscore-detail-stat {
            background: rgba(0, 0, 0, 0.05);
        }

        .boxscore-detail-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .boxscore-detail-label {
            font-size: 0.55rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 2px;
        }

        .boxscore-loading {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
        }

        .boxscore-no-stats {
            text-align: center;
            padding: 15px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Live game situation */
        .live-situation {
            background: rgba(252, 129, 129, 0.1);
            border: 1px solid rgba(252, 129, 129, 0.3);
            border-radius: 12px;
            padding: 12px;
            margin-top: 10px;
        }

        .situation-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .possession-info {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--accent-secondary);
        }

        .down-distance {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            text-align: center;
        }

        .field-position {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .red-zone-badge {
            background: rgba(252, 129, 129, 0.3);
            color: var(--accent-danger);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            animation: pulse 1.5s infinite;
        }

        /* Mini field position graphic */
        .field-graphic {
            position: relative;
            width: 100%;
            height: 40px;
            background: linear-gradient(90deg,
                var(--away-endzone, #333) 0%,
                var(--away-endzone, #333) 9%,
                #2d5a27 9%,
                #2d5a27 91%,
                var(--home-endzone, #333) 91%,
                var(--home-endzone, #333) 100%
            );
            border-radius: 6px;
            margin: 10px 0;
            overflow: hidden;
        }

        .field-lines {
            position: absolute;
            top: 0;
            left: 9%;
            right: 9%;
            height: 100%;
            display: flex;
            justify-content: space-between;
        }

        .yard-line {
            width: 1px;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
        }

        .yard-line.major {
            background: rgba(255, 255, 255, 0.6);
        }

        .field-50 {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.6rem;
            color: rgba(255, 255, 255, 0.5);
            font-weight: bold;
        }

        .ball-marker {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background: #8B4513;
            border-radius: 40% 40% 40% 40%;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            z-index: 10;
            transition: left 0.5s ease;
        }

        .ball-marker::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1px;
            height: 8px;
            background: #fff;
        }

        .first-down-marker {
            position: absolute;
            top: 0;
            height: 100%;
            width: 3px;
            background: #FFD700;
            transform: translateX(-50%);
            z-index: 5;
        }

        .endzone-label {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.5rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .endzone-label.away { left: 1%; }
        .endzone-label.home { right: 1%; }

        /* Scoring plays timeline */
        .scoring-timeline {
            margin-top: 15px;
        }

        .scoring-header {
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
            margin-bottom: 10px;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .scoring-play {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            margin-bottom: 8px;
            position: relative;
        }

        [data-theme="light"] .scoring-play {
            background: rgba(0, 0, 0, 0.05);
        }

        .scoring-play::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 10px 0 0 10px;
            background: var(--team-color, var(--accent-secondary));
        }

        .scoring-quarter {
            background: var(--bg-primary);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-muted);
            min-width: 35px;
            text-align: center;
        }

        .scoring-team-logo {
            width: 28px;
            height: 28px;
            object-fit: contain;
        }

        .scoring-info {
            flex: 1;
            min-width: 0;
        }

        .scoring-type {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .scoring-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .scoring-score {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent-success);
            white-space: nowrap;
        }

        .scoring-time {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        /* Team comparison stats */
        .team-comparison {
            padding: 15px 0;
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 10px;
        }

        .comparison-team {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .comparison-team img {
            width: 24px;
            height: 24px;
        }

        .comparison-vs {
            color: var(--text-muted);
            font-size: 0.7rem;
        }

        .stat-comparison {
            margin-bottom: 12px;
        }

        .stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            text-align: center;
            margin-bottom: 5px;
        }

        .stat-bars {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-bar-container {
            flex: 1;
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
        }

        .stat-bar-container.left {
            direction: rtl;
        }

        .stat-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .stat-bar.away { background: linear-gradient(90deg, var(--away-color, #666), var(--away-color, #666)); }
        .stat-bar.home { background: linear-gradient(90deg, var(--home-color, #666), var(--home-color, #666)); }

        .stat-value {
            font-size: 0.7rem;
            font-weight: 600;
            min-width: 35px;
            text-align: center;
        }

        .stat-value.away { color: var(--away-color, var(--text-secondary)); }
        .stat-value.home { color: var(--home-color, var(--text-secondary)); }

        .stat-value.better { font-weight: 700; }

        .rank-badge {
            font-size: 0.55rem;
            padding: 1px 4px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            margin-left: 3px;
        }

        /* Share button */
        .share-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        .share-btn:hover {
            background: var(--accent-success);
            color: var(--bg-primary);
            transform: scale(1.1);
        }

        .share-btn:active {
            transform: scale(0.95);
        }

        .share-toast {
            position: fixed;
            bottom: calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 20px);
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--accent-success);
            color: var(--bg-primary);
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .share-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Head to head history */
        .h2h-container {
            padding: 10px 0;
        }

        .h2h-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 12px;
        }

        [data-theme="light"] .h2h-summary {
            background: rgba(0, 0, 0, 0.05);
        }

        .h2h-team-record {
            text-align: center;
        }

        .h2h-team-record img {
            width: 32px;
            height: 32px;
            margin-bottom: 4px;
        }

        .h2h-wins {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-success);
        }

        .h2h-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .h2h-vs {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .h2h-game {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin-bottom: 6px;
            border-left: 3px solid var(--winner-color, #666);
        }

        [data-theme="light"] .h2h-game {
            background: rgba(0, 0, 0, 0.03);
        }

        .h2h-date {
            font-size: 0.7rem;
            color: var(--text-muted);
            min-width: 70px;
        }

        .h2h-matchup {
            flex: 1;
            font-size: 0.8rem;
        }

        .h2h-winner {
            font-weight: 600;
            color: var(--text-primary);
        }

        .h2h-loser {
            color: var(--text-muted);
        }

        .h2h-score {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-secondary);
        }

        /* Playoff indicators */
        .playoff-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
        }

        .playoff-indicator.clinched-div {
            background: rgba(104, 211, 145, 0.2);
            color: var(--accent-success);
        }

        .playoff-indicator.clinched-playoff {
            background: rgba(104, 211, 145, 0.15);
            color: var(--accent-success);
        }

        .playoff-indicator.wild-card {
            background: rgba(59, 130, 246, 0.2);
            color: #60A5FA;
        }

        .playoff-indicator.in-hunt {
            background: rgba(251, 191, 36, 0.2);
            color: #FBBF24;
        }

        .playoff-indicator.eliminated {
            background: rgba(252, 129, 129, 0.2);
            color: var(--accent-danger);
        }

        .wild-card-race {
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 12px;
        }

        .wild-card-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .wild-card-team {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .wild-card-team:last-child {
            border-bottom: none;
        }

        .wild-card-seed {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 50%;
            background: var(--bg-primary);
        }

        .wild-card-seed.in-playoff { background: rgba(104, 211, 145, 0.2); color: var(--accent-success); }
        .wild-card-seed.chasing { background: rgba(251, 191, 36, 0.2); color: #FBBF24; }

        .wild-card-team-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wild-card-team-info img {
            width: 24px;
            height: 24px;
        }

        .wild-card-record {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Player spotlight modal */
        .player-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 20px;
        }

        .player-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .player-modal {
            background: var(--bg-card);
            border-radius: 20px;
            max-width: 380px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(30px) scale(0.95);
            transition: transform 0.3s ease;
        }

        .player-modal-overlay.show .player-modal {
            transform: translateY(0) scale(1);
        }

        .player-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: linear-gradient(135deg, var(--team-color, #333) 0%, rgba(0,0,0,0.3) 100%);
            border-radius: 20px 20px 0 0;
        }

        .player-headshot {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--bg-primary);
            border: 3px solid rgba(255,255,255,0.3);
        }

        .player-info h3 {
            color: #fff;
            font-size: 1.2rem;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .player-meta {
            color: rgba(255,255,255,0.8);
            font-size: 0.8rem;
            margin-top: 4px;
        }

        .player-team-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            margin-top: 8px;
        }

        .player-team-badge img {
            width: 18px;
            height: 18px;
        }

        .player-team-badge span {
            color: #fff;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .player-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: var(--border-color);
            margin: 15px;
            border-radius: 12px;
            overflow: hidden;
        }

        .player-stat-box {
            background: var(--bg-primary);
            padding: 15px 10px;
            text-align: center;
        }

        .player-stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .player-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .player-section {
            padding: 0 15px 15px;
        }

        .player-section-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 10px;
            padding-left: 5px;
        }

        .player-recent-games {
            background: var(--bg-primary);
            border-radius: 12px;
            overflow: hidden;
        }

        .player-game-row {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .player-game-row:last-child {
            border-bottom: none;
        }

        .player-game-opp {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
        }

        .player-game-opp img {
            width: 20px;
            height: 20px;
        }

        .player-game-stat {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-secondary);
        }

        .player-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0,0,0,0.3);
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .clickable-player {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 2px;
        }

        .clickable-player:hover {
            color: var(--accent-secondary);
        }

        /* Game highlights */
        .highlights-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 10px 0;
        }

        .highlight-card {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
        }

        .highlight-thumbnail {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            display: block;
        }

        .highlight-play-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .highlight-card:hover .highlight-play-btn {
            background: var(--accent-danger);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .highlight-title {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 8px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: #fff;
            font-size: 0.65rem;
            line-height: 1.3;
        }

        .highlight-duration {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.6rem;
        }

        /* YouTube single video card */
        .yt-single-video {
            display: block;
            text-decoration: none;
            border-radius: 12px;
            overflow: hidden;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            margin: 10px 0;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .yt-single-video:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .yt-single-thumb {
            position: relative;
            aspect-ratio: 16/9;
            overflow: hidden;
        }

        .yt-single-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .yt-play-icon-lg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: rgba(255,0,0,0.9);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 1.5rem;
            transition: transform 0.2s;
        }

        .yt-single-video:hover .yt-play-icon-lg {
            transform: translate(-50%, -50%) scale(1.1);
        }

        .yt-single-info {
            padding: 12px;
        }

        .yt-single-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.3;
            margin-bottom: 4px;
        }

        .yt-single-channel {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .last-play {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        .last-play-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .last-play-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Win probability */
        .win-prob {
            margin-top: 12px;
        }

        .win-prob-bar {
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
            display: flex;
        }

        .win-prob-away {
            background: linear-gradient(90deg, var(--accent-danger), #f56565);
            transition: width 0.5s ease;
        }

        .win-prob-home {
            background: linear-gradient(90deg, var(--accent-success), #48bb78);
            transition: width 0.5s ease;
        }

        .win-prob-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            margin-top: 5px;
        }

        .prob-label {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .prob-label.away { color: var(--accent-danger); }
        .prob-label.home { color: var(--accent-success); }

        /* Injuries section */
        .injuries-btn {
            background: rgba(252, 129, 129, 0.15);
            border: 1px solid rgba(252, 129, 129, 0.3);
            color: var(--accent-danger);
        }

        .injuries-content {
            margin-top: 10px;
        }

        .injuries-team {
            margin-bottom: 12px;
        }

        .injuries-team-name {
            font-size: 0.8rem;
            color: var(--accent-secondary);
            font-weight: 600;
            margin-bottom: 6px;
        }

        .injury-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .injury-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.75rem;
        }

        [data-theme="light"] .injury-item {
            background: rgba(0, 0, 0, 0.05);
        }

        .injury-status {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .injury-status.out { background: var(--accent-danger); color: var(--bg-primary); }
        .injury-status.doubtful { background: #f6ad55; color: var(--bg-primary); }
        .injury-status.questionable { background: var(--accent-secondary); color: var(--bg-primary); }

        .injury-player { flex: 1; color: var(--text-primary); }
        .injury-position { color: var(--text-muted); font-size: 0.7rem; }

        .no-injuries {
            color: var(--accent-success);
            font-size: 0.8rem;
            padding: 8px;
        }

        /* Standings Section */
        .standings-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 1.2rem;
            color: var(--accent-secondary);
        }

        .section-toggle {
            background: var(--bg-card);
            border: none;
            color: var(--text-secondary);
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .section-toggle:hover, .section-toggle.active {
            background: var(--accent-success);
            color: var(--bg-primary);
        }

        .standings-content {
            display: none;
        }

        .standings-content.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .conference-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .conf-tab {
            flex: 1;
            background: var(--bg-card);
            border: none;
            color: var(--text-secondary);
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .conf-tab:hover {
            background: var(--bg-card-hover);
        }

        .conf-tab.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-primary);
        }

        .division-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .division-name {
            font-size: 0.9rem;
            color: var(--accent-secondary);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .standings-table {
            width: 100%;
            font-size: 0.8rem;
            border-collapse: collapse;
        }

        .standings-table th {
            color: var(--text-muted);
            font-weight: 500;
            padding: 6px;
            text-align: center;
        }

        .standings-table th:first-child {
            text-align: left;
        }

        .standings-table td {
            padding: 8px 6px;
            text-align: center;
            border-top: 1px solid var(--border-color);
        }

        .standings-table td:first-child {
            text-align: left;
        }

        .standings-team {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .standings-logo {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .standings-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .playoff-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .playoff-dot.clinched { background: var(--accent-success); }
        .playoff-dot.wildcard { background: var(--accent-secondary); }
        .playoff-dot.eliminated { background: var(--accent-danger); }

        .standings-legend {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            font-size: 0.75rem;
            color: var(--text-muted);
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .diff-positive { color: var(--accent-success); }
        .diff-negative { color: var(--accent-danger); }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--bottom-nav-height);
            padding-bottom: var(--safe-area-bottom);
            background: linear-gradient(180deg, rgba(45, 55, 72, 0.95) 0%, var(--bg-card) 100%);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.2);
        }

        [data-theme="light"] .bottom-nav {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.95) 0%, var(--bg-card) 100%);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 18px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.7rem;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            background: none;
            border-radius: 12px;
        }

        .nav-item .icon {
            font-size: 1.5rem;
            transition: transform 0.3s;
        }

        .nav-item:hover .icon {
            transform: translateY(-2px);
        }

        .nav-item.active {
            color: var(--accent-success);
            background: rgba(104, 211, 145, 0.1);
        }

        .nav-item.active .icon {
            transform: scale(1.1);
        }

        .nav-item:active {
            transform: scale(0.9);
        }

        /* Loading & States */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-success);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .no-games, .error {
            text-align: center;
            padding: 40px 20px;
            background: var(--bg-card);
            border-radius: 16px;
        }

        .no-games { color: var(--text-secondary); }
        .error { color: var(--accent-danger); }

        /* Score change animation */
        @keyframes scoreFlash {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); color: var(--accent-success); }
            100% { transform: scale(1); }
        }

        .score-changed {
            animation: scoreFlash 0.5s ease;
        }

        @keyframes scorePop {
            0% { transform: scale(1); }
            20% { transform: scale(1.4); color: var(--accent-success); }
            40% { transform: scale(0.9); }
            60% { transform: scale(1.2); }
            80% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        .score-updated {
            animation: scorePop 0.6s ease;
        }

        @keyframes touchdownCelebrate {
            0% { transform: scale(1); }
            25% { transform: scale(1.5) rotate(-5deg); color: #FFD700; text-shadow: 0 0 20px #FFD700; }
            50% { transform: scale(1.3) rotate(5deg); }
            75% { transform: scale(1.1) rotate(-2deg); }
            100% { transform: scale(1) rotate(0); }
        }

        .touchdown-score {
            animation: touchdownCelebrate 0.8s ease;
        }

        /* Confetti canvas */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        /* Page views with transitions */
        .page-view {
            display: none;
            opacity: 0;
            transform: translateY(10px);
        }

        .page-view.active {
            display: block;
            animation: pageEnter 0.3s ease forwards;
        }

        @keyframes pageEnter {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Staggered card entrance */
        .game-card {
            animation: cardEnter 0.4s ease backwards;
        }

        @keyframes cardEnter {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .game-card:nth-child(1) { animation-delay: 0.05s; }
        .game-card:nth-child(2) { animation-delay: 0.1s; }
        .game-card:nth-child(3) { animation-delay: 0.15s; }
        .game-card:nth-child(4) { animation-delay: 0.2s; }
        .game-card:nth-child(5) { animation-delay: 0.25s; }
        .game-card:nth-child(6) { animation-delay: 0.3s; }
        .game-card:nth-child(7) { animation-delay: 0.35s; }
        .game-card:nth-child(8) { animation-delay: 0.4s; }

        /* Date change slide animation */
        .games-container.slide-left {
            animation: slideLeft 0.3s ease;
        }

        .games-container.slide-right {
            animation: slideRight 0.3s ease;
        }

        @keyframes slideLeft {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideRight {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Division card staggered entrance */
        .division-card {
            animation: cardEnter 0.4s ease backwards;
        }

        .division-card:nth-child(1) { animation-delay: 0.05s; }
        .division-card:nth-child(2) { animation-delay: 0.1s; }
        .division-card:nth-child(3) { animation-delay: 0.15s; }
        .division-card:nth-child(4) { animation-delay: 0.2s; }

        /* Desktop styles */
        @media (min-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2.2rem;
            }

            .game-card {
                padding: 20px;
            }

            .teams-row {
                gap: 20px;
            }

            .team-logo {
                width: 60px;
                height: 60px;
            }

            .team-name {
                font-size: 1rem;
            }

            .scores-display {
                font-size: 2.5rem;
            }

            .score-block {
                min-width: 140px;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
            }

            .stat-headshot {
                width: 44px;
                height: 44px;
            }

            .bottom-nav {
                display: none;
            }

            body {
                padding-bottom: 20px;
            }

            .swipe-hint {
                display: none;
            }
        }

        /* Small phones */
        @media (max-width: 380px) {
            .team-name {
                font-size: 0.8rem;
            }

            .team-logo {
                width: 40px;
                height: 40px;
            }

            .scores-display {
                font-size: 1.8rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-card {
                display: flex;
                align-items: center;
                gap: 10px;
                text-align: left;
            }

            .stat-player {
                flex-direction: row;
            }

            .boxscore-detail-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .boxscore-player-compact-stats {
                gap: 8px;
            }

            .boxscore-compact-stat-value {
                font-size: 0.75rem;
            }

            .boxscore-team-tab {
                font-size: 0.75rem;
                padding: 8px 10px;
            }

            .boxscore-team-tab img {
                width: 20px;
                height: 20px;
            }
        }

        /* Refresh indicator */
        .refresh-status {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 10px;
        }

        /* Haptic feedback simulation */
        .haptic {
            transition: transform 0.1s;
        }

        .haptic:active {
            transform: scale(0.97);
        }

        /* ============================================
           FEATURE 1: PLAYOFF BRACKET VISUALIZATION
           ============================================ */
        .playoff-bracket-container {
            padding: 15px 0;
        }

        .bracket-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .bracket-header h2 {
            font-size: 1.3rem;
            color: var(--accent-secondary);
            margin-bottom: 5px;
        }

        .bracket-header .bracket-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .brackets-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .brackets-wrapper {
                grid-template-columns: 1fr;
            }
        }

        .conference-bracket {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
        }

        .conference-bracket-title {
            text-align: center;
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 15px;
            padding: 8px;
            border-radius: 8px;
        }

        .conference-bracket-title.afc {
            background: linear-gradient(135deg, #D50A0A22, #D50A0A44);
            color: #FF6B6B;
        }

        .conference-bracket-title.nfc {
            background: linear-gradient(135deg, #003594, #00359444);
            color: #60A5FA;
        }

        .bracket-round {
            margin-bottom: 20px;
        }

        .bracket-round-title {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            text-align: center;
        }

        .bracket-matchup {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            position: relative;
        }

        .bracket-matchup.completed {
            opacity: 0.9;
        }

        .bracket-team {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
        }

        .bracket-team.winner {
            color: var(--accent-success);
        }

        .bracket-team.loser {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .bracket-seed {
            width: 20px;
            height: 20px;
            background: var(--bg-card);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-muted);
        }

        .bracket-team-logo {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .bracket-team-name {
            flex: 1;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .bracket-score {
            font-size: 0.9rem;
            font-weight: 700;
            min-width: 25px;
            text-align: right;
        }

        .bracket-vs {
            text-align: center;
            font-size: 0.65rem;
            color: var(--text-muted);
            padding: 2px 0;
        }

        .bracket-matchup-status {
            text-align: center;
            font-size: 0.7rem;
            color: var(--accent-secondary);
            margin-top: 5px;
        }

        .bracket-bye {
            background: linear-gradient(135deg, rgba(104, 211, 145, 0.1), rgba(104, 211, 145, 0.05));
            border: 1px dashed var(--accent-success);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 10px;
        }

        .bracket-bye-label {
            font-size: 0.7rem;
            color: var(--accent-success);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .bracket-bye-team {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* ============================================
           FEATURE 2: ELIMINATION TRACKER
           ============================================ */
        .elimination-badge {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            background: rgba(252, 129, 129, 0.9);
            color: #fff;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 5;
            box-shadow: 0 2px 8px rgba(252, 129, 129, 0.4);
        }

        .team-eliminated {
            position: relative;
        }

        .team-eliminated::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }

        .team-eliminated .team-name,
        .team-eliminated .team-record {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .playoff-alive-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
            vertical-align: middle;
        }

        .playoff-alive-indicator.alive {
            background: rgba(104, 211, 145, 0.2);
            color: var(--accent-success);
        }

        .playoff-alive-indicator.eliminated {
            background: rgba(252, 129, 129, 0.2);
            color: var(--accent-danger);
        }

        /* ============================================
           FEATURE 3: WIN PROBABILITY DISPLAY (Enhanced)
           ============================================ */
        .win-prob-container {
            margin-top: 12px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        [data-theme="light"] .win-prob-container {
            background: rgba(0, 0, 0, 0.05);
        }

        .win-prob-title {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            text-align: center;
        }

        .win-prob-bar-enhanced {
            height: 24px;
            background: var(--bg-primary);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            position: relative;
        }

        .win-prob-away-fill {
            background: linear-gradient(90deg, var(--away-color, #f56565), var(--away-color, #f56565));
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: 8px;
        }

        .win-prob-home-fill {
            background: linear-gradient(90deg, var(--home-color, #48bb78), var(--home-color, #48bb78));
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
        }

        .win-prob-percent {
            font-size: 0.75rem;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .win-prob-team-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.7rem;
        }

        .win-prob-team-labels span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .win-prob-team-labels img {
            width: 16px;
            height: 16px;
        }

        /* ============================================
           FEATURE 4: DRIVE TRACKER (Enhanced)
           ============================================ */
        .drive-tracker {
            background: rgba(0, 0, 0, 0.25);
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
        }

        [data-theme="light"] .drive-tracker {
            background: rgba(0, 0, 0, 0.08);
        }

        .drive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .drive-title {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .drive-stats {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
        }

        .drive-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .drive-stat-value {
            font-weight: 700;
            color: var(--text-primary);
        }

        .drive-stat-label {
            font-size: 0.6rem;
            color: var(--text-muted);
        }

        .drive-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .drive-team-logo {
            width: 24px;
            height: 24px;
        }

        .drive-summary {
            display: flex;
            gap: 15px;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        .drive-summary-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .drive-summary-item strong {
            color: var(--accent-secondary);
        }

        /* ============================================
           FEATURE 5: RED ZONE ALERT (Enhanced)
           ============================================ */
        .game-card.red-zone-active {
            animation: redZonePulse 1.5s ease-in-out infinite;
            border: 2px solid rgba(252, 129, 129, 0.6) !important;
        }

        @keyframes redZonePulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(252, 129, 129, 0.4);
            }
            50% {
                box-shadow: 0 0 20px 5px rgba(252, 129, 129, 0.3);
            }
        }

        .red-zone-banner {
            background: linear-gradient(90deg, #fc8181, #f56565);
            color: #fff;
            text-align: center;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: 700;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            animation: redZoneBannerPulse 1s ease-in-out infinite;
        }

        @keyframes redZoneBannerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .red-zone-banner-icon {
            font-size: 1.2rem;
        }

        .red-zone-field-marker {
            position: absolute;
            right: 9%;
            width: 16.4%;
            height: 100%;
            background: rgba(252, 129, 129, 0.3);
            top: 0;
            border-radius: 0 6px 6px 0;
        }

        .red-zone-field-marker.away-side {
            right: auto;
            left: 9%;
            border-radius: 6px 0 0 6px;
        }

        /* ============================================
           FEATURE 7: SHAREABLE SCORE CARDS
           ============================================ */
        .share-btn-enhanced {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            z-index: 10;
        }

        .share-btn-enhanced:hover {
            background: var(--accent-success);
            color: var(--bg-primary);
            border-color: var(--accent-success);
        }

        .share-menu {
            position: absolute;
            top: 50px;
            right: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px 0;
            z-index: 100;
            min-width: 150px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none;
        }

        .share-menu.show {
            display: block;
            animation: slideDown 0.2s ease;
        }

        .share-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.8rem;
            color: var(--text-primary);
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .share-menu-item:hover {
            background: var(--bg-primary);
        }

        .share-menu-item .icon {
            font-size: 1rem;
        }

        #share-canvas-container {
            position: fixed;
            top: -9999px;
            left: -9999px;
        }

        /* ============================================
           FEATURE 8: PLAYER COMPARISON TOOL
           ============================================ */
        .player-comparison-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 20px;
        }

        .player-comparison-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .comparison-content {
            background: var(--bg-card);
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            transform: translateY(30px) scale(0.95);
            transition: transform 0.3s ease;
        }

        .player-comparison-modal.show .comparison-content {
            transform: translateY(0) scale(1);
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .comparison-header h3 {
            font-size: 1rem;
            color: var(--text-primary);
        }

        .comparison-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        .comparison-players {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 20px;
        }

        .comparison-player-card {
            text-align: center;
        }

        .comparison-player-card img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 3px solid var(--team-color, #666);
        }

        .comparison-player-card h4 {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .comparison-player-card .position {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .comparison-stats {
            padding: 0 20px 20px;
        }

        .comparison-stat-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
        }

        .comparison-stat-row:last-child {
            border-bottom: none;
        }

        .comparison-stat-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .comparison-stat-value.left {
            text-align: right;
        }

        .comparison-stat-value.right {
            text-align: left;
        }

        .comparison-stat-value.better {
            color: var(--accent-success);
        }

        .comparison-stat-label {
            text-align: center;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .compare-players-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            margin: 10px 15px;
            transition: all 0.2s;
        }

        .compare-players-btn:hover {
            background: var(--accent-secondary);
            color: var(--bg-primary);
        }

        .player-select-mode .boxscore-player-row {
            cursor: pointer;
            border: 2px solid transparent;
        }

        .player-select-mode .boxscore-player-row:hover {
            border-color: var(--accent-secondary);
        }

        .player-select-mode .boxscore-player-row.selected {
            border-color: var(--accent-success);
            background: rgba(104, 211, 145, 0.1);
        }

        /* ============================================
           FEATURE 9: BETTING ODDS/SPREADS DISPLAY (Enhanced)
           ============================================ */
        .odds-display {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
        }

        [data-theme="light"] .odds-display {
            background: rgba(0, 0, 0, 0.05);
        }

        .odds-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .odds-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .odds-card {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .odds-card-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .odds-card-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-success);
        }

        .odds-card-team {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .moneyline-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .moneyline-team {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 8px 12px;
        }

        .moneyline-team-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .moneyline-team-info img {
            width: 20px;
            height: 20px;
        }

        .moneyline-team-info span {
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .moneyline-value {
            font-size: 0.85rem;
            font-weight: 700;
        }

        .moneyline-value.favorite {
            color: var(--accent-danger);
        }

        .moneyline-value.underdog {
            color: var(--accent-success);
        }

        /* ============================================
           FEATURE: PLAY-BY-PLAY FEED
           ============================================ */
        .play-by-play-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px 0;
        }

        .pbp-play {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 0.8rem;
            border-left: 3px solid var(--play-color, var(--text-muted));
        }

        [data-theme="light"] .pbp-play {
            background: rgba(0, 0, 0, 0.05);
        }

        .pbp-play.scoring {
            background: rgba(104, 211, 145, 0.15);
            border-left-color: var(--accent-success);
        }

        .pbp-play.turnover {
            background: rgba(252, 129, 129, 0.15);
            border-left-color: var(--accent-danger);
        }

        .pbp-time {
            min-width: 55px;
            color: var(--text-muted);
            font-size: 0.7rem;
        }

        .pbp-team-logo {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .pbp-text {
            flex: 1;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .pbp-down {
            font-weight: 600;
            color: var(--text-primary);
            margin-right: 5px;
        }

        .pbp-yards {
            color: var(--accent-success);
            font-weight: 600;
        }

        .pbp-yards.negative {
            color: var(--accent-danger);
        }

        .pbp-quarter-header {
            text-align: center;
            padding: 8px;
            background: var(--bg-primary);
            border-radius: 8px;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--accent-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .pbp-live-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.7rem;
            color: var(--accent-danger);
            margin-bottom: 10px;
        }

        /* ============================================
           FEATURE: GAME CAST MINI-VIEW (Floating Widget)
           ============================================ */
        .game-cast-mini {
            position: fixed;
            bottom: calc(var(--bottom-nav-height) + var(--safe-area-bottom) + 10px);
            left: 10px;
            right: 10px;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 12px 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            z-index: 900;
            display: none;
            border: 1px solid var(--border-color);
            max-width: 400px;
            margin: 0 auto;
        }

        .game-cast-mini.visible {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .game-cast-mini-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .game-cast-mini-teams {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .game-cast-mini-teams img {
            width: 24px;
            height: 24px;
        }

        .game-cast-mini-score {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-success);
        }

        .game-cast-mini-status {
            font-size: 0.7rem;
            color: var(--accent-danger);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .game-cast-mini-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px;
        }

        .game-cast-mini-play {
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 10px;
            border-radius: 8px;
            line-height: 1.4;
        }

        [data-theme="light"] .game-cast-mini-play {
            background: rgba(0, 0, 0, 0.05);
        }

        /* ============================================
           FEATURE: SEASON STATS DASHBOARD
           ============================================ */
        .season-stats-section {
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 12px;
        }

        .season-stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .season-stats-title {
            font-size: 1rem;
            color: var(--accent-secondary);
            font-weight: 600;
        }

        .season-stats-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .season-stat-tab {
            background: var(--bg-primary);
            border: none;
            color: var(--text-secondary);
            padding: 8px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.75rem;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .season-stat-tab.active {
            background: var(--accent-success);
            color: var(--bg-primary);
        }

        .season-stat-category {
            display: none;
        }

        .season-stat-category.active {
            display: block;
        }

        .season-stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .season-stat-item:last-child {
            border-bottom: none;
        }

        .season-stat-rank {
            width: 24px;
            height: 24px;
            background: var(--bg-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-muted);
        }

        .season-stat-rank.top-3 {
            background: var(--accent-secondary);
            color: var(--bg-primary);
        }

        .season-stat-player {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .season-stat-headshot {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--bg-primary);
        }

        .season-stat-info {
            flex: 1;
        }

        .season-stat-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .season-stat-team {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .season-stat-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-success);
        }

        /* ============================================
           FEATURE: GAME PREDICTIONS
           ============================================ */
        .prediction-section {
            margin-top: 10px;
            padding: 12px;
            background: rgba(254, 202, 87, 0.1);
            border: 1px solid rgba(254, 202, 87, 0.3);
            border-radius: 10px;
        }

        .prediction-title {
            font-size: 0.75rem;
            color: var(--accent-secondary);
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .prediction-buttons {
            display: flex;
            gap: 10px;
        }

        .prediction-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 10px;
            background: var(--bg-primary);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .prediction-btn:hover {
            background: var(--bg-card-hover);
        }

        .prediction-btn.selected {
            border-color: var(--accent-success);
            background: rgba(104, 211, 145, 0.15);
        }

        .prediction-btn img {
            width: 32px;
            height: 32px;
        }

        .prediction-btn span {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .prediction-btn.selected span {
            color: var(--accent-success);
            font-weight: 600;
        }

        .prediction-result {
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .prediction-result.correct {
            background: rgba(104, 211, 145, 0.2);
            color: var(--accent-success);
        }

        .prediction-result.incorrect {
            background: rgba(252, 129, 129, 0.2);
            color: var(--accent-danger);
        }

        .prediction-locked {
            text-align: center;
            padding: 12px;
            background: rgba(104, 211, 145, 0.1);
            border: 1px solid rgba(104, 211, 145, 0.3);
            border-radius: 10px;
        }

        .prediction-locked-header {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .prediction-locked-team {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .prediction-locked-team img {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        .prediction-locked-team span {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .prediction-locked-status {
            font-size: 0.75rem;
            color: var(--accent-success);
            font-weight: 600;
        }

        .prediction-stats {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 12px;
        }

        .prediction-stats-title {
            font-size: 0.9rem;
            color: var(--accent-secondary);
            margin-bottom: 10px;
        }

        .prediction-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .prediction-stat-box {
            text-align: center;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: 8px;
        }

        .prediction-stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .prediction-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* ============================================
           FEATURE: FAVORITES/WATCHLIST (Multi-team)
           ============================================ */
        .watchlist-section {
            margin-bottom: 15px;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 12px;
        }

        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .watchlist-title {
            font-size: 0.85rem;
            color: var(--accent-secondary);
            font-weight: 600;
        }

        .watchlist-edit-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.75rem;
            padding: 5px 10px;
        }

        .watchlist-teams {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .watchlist-team {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 10px;
            background: var(--bg-primary);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--text-primary);
        }

        .watchlist-team img {
            width: 18px;
            height: 18px;
        }

        .watchlist-team .remove-btn {
            background: none;
            border: none;
            color: var(--accent-danger);
            cursor: pointer;
            font-size: 1rem;
            padding: 0 0 0 5px;
            display: none;
        }

        .watchlist-section.editing .watchlist-team .remove-btn {
            display: inline;
        }

        .watchlist-add-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 10px;
            background: rgba(104, 211, 145, 0.2);
            border: 1px dashed var(--accent-success);
            border-radius: 20px;
            color: var(--accent-success);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .watchlist-add-btn:hover {
            background: rgba(104, 211, 145, 0.3);
        }

        .watchlist-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 20px;
        }

        .watchlist-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .watchlist-modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(30px) scale(0.95);
            transition: transform 0.3s ease;
        }

        .watchlist-modal.show .watchlist-modal-content {
            transform: translateY(0) scale(1);
        }

        .watchlist-modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .watchlist-modal-header h3 {
            font-size: 1rem;
            color: var(--text-primary);
        }

        .watchlist-modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .watchlist-modal-teams {
            padding: 10px 15px;
        }

        .watchlist-modal-team {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .watchlist-modal-team:hover {
            background: var(--bg-primary);
        }

        .watchlist-modal-team img {
            width: 28px;
            height: 28px;
        }

        .watchlist-modal-team span {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .watchlist-modal-team .check {
            color: var(--accent-success);
            font-size: 1.2rem;
            display: none;
        }

        .watchlist-modal-team.selected .check {
            display: block;
        }

        /* ============================================
           FEATURE: SETTINGS MODAL
           ============================================ */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .settings-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .settings-modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(20px) scale(0.95);
            transition: transform 0.3s;
        }

        .settings-modal.show .settings-modal-content {
            transform: translateY(0) scale(1);
        }

        .settings-modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-modal-header h3 {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin: 0;
        }

        .settings-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .settings-modal-body {
            padding: 15px;
        }

        .settings-group {
            background: var(--bg-primary);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item.column {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }

        .settings-item-info {
            flex: 1;
        }

        .settings-item-title {
            font-size: 0.95rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .settings-item-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .settings-toggle {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 28px;
            flex-shrink: 0;
            cursor: pointer;
        }

        .settings-toggle input {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
            margin: 0;
        }

        .settings-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--text-muted);
            border-radius: 28px;
            transition: 0.3s;
        }

        .settings-toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .settings-toggle input:checked + .settings-toggle-slider {
            background-color: var(--accent-success);
        }

        .settings-toggle input:checked + .settings-toggle-slider:before {
            transform: translateX(20px);
        }

        .settings-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .settings-btn {
            width: 100%;
            padding: 10px 12px;
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60A5FA;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .settings-btn:hover {
            background: rgba(59, 130, 246, 0.25);
        }

        .settings-notice {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 15px;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 10px;
            font-size: 0.8rem;
            color: #FBBF24;
        }

        .settings-notice a {
            color: #60A5FA;
            text-decoration: underline;
        }

        /* ============================================
           FEATURE: GAME CALENDAR EXPORT
           ============================================ */
        .calendar-export-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60A5FA;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .calendar-export-btn:hover {
            background: rgba(59, 130, 246, 0.25);
        }

        /* ============================================
           FEATURE: NOTIFICATION PERMISSION BUTTON
           ============================================ */
        .notification-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg-card);
            border: none;
            color: var(--text-secondary);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .notification-btn:hover {
            background: var(--bg-card-hover);
        }

        .notification-btn.enabled {
            background: rgba(104, 211, 145, 0.2);
            color: var(--accent-success);
        }

        .notification-btn .icon {
            font-size: 1rem;
        }

        /* Stats View */
        .stats-view-container {
            padding: 0;
        }

        @media (min-width: 768px) {
            .game-cast-mini {
                left: 50%;
                transform: translateX(-50%);
                right: auto;
            }
        }
    </style>
</head>
<body>
    <canvas id="confetti-canvas"></canvas>
    <div class="share-toast" id="share-toast">Copied to clipboard!</div>

    <!-- Hidden canvas for share image generation -->
    <div id="share-canvas-container">
        <canvas id="share-canvas" width="600" height="400"></canvas>
    </div>

    <!-- Player Comparison Modal -->
    <div class="player-comparison-modal" id="player-comparison-modal" onclick="closeComparisonModal(event)">
        <div class="comparison-content" onclick="event.stopPropagation()">
            <div class="comparison-header">
                <h3>Player Comparison</h3>
                <button class="comparison-close" onclick="closeComparisonModal()">&times;</button>
            </div>
            <div id="comparison-modal-content">
                <div style="padding: 40px; text-align: center; color: var(--text-muted);">Select two players to compare</div>
            </div>
        </div>
    </div>

    <div class="player-modal-overlay" id="player-modal" onclick="closePlayerModal(event)">
        <div class="player-modal" onclick="event.stopPropagation()">
            <button class="player-close" onclick="closePlayerModal()">&times;</button>
            <div id="player-modal-content">
                <div style="padding: 40px; text-align: center; color: var(--text-muted);">Loading...</div>
            </div>
        </div>
    </div>
    <div class="pull-indicator" id="pull-indicator">Release to refresh</div>

    <!-- Game Cast Mini Widget (Floating) -->
    <div class="game-cast-mini" id="game-cast-mini">
        <button class="game-cast-mini-close" onclick="closeGameCastMini()">&times;</button>
        <div class="game-cast-mini-header">
            <div class="game-cast-mini-teams" id="mini-teams">
                <!-- Populated dynamically -->
            </div>
            <div class="game-cast-mini-status" id="mini-status">
                <span class="live-dot"></span>
                <span id="mini-quarter">Q1</span>
            </div>
        </div>
        <div class="game-cast-mini-play" id="mini-play">
            Waiting for play data...
        </div>
    </div>

    <!-- Watchlist Modal -->
    <div class="watchlist-modal" id="watchlist-modal" onclick="closeWatchlistModal(event)">
        <div class="watchlist-modal-content" onclick="event.stopPropagation()">
            <div class="watchlist-modal-header">
                <h3>Add Teams to Watchlist</h3>
                <button class="watchlist-modal-close" onclick="closeWatchlistModal()">&times;</button>
            </div>
            <div class="watchlist-modal-teams" id="watchlist-modal-teams">
                <!-- Teams populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settings-modal" onclick="closeSettingsModal(event)">
        <div class="settings-modal-content" onclick="event.stopPropagation()">
            <div class="settings-modal-header">
                <h3>Settings</h3>
                <button class="settings-modal-close" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="settings-modal-body">
                <div class="settings-group">
                    <div class="settings-item" id="notifications-setting-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Score Alerts</div>
                            <div class="settings-item-desc" id="notifications-desc">Get notified when your teams score</div>
                        </div>
                        <div id="notifications-control">
                            <!-- Will be populated by JS: either toggle or button -->
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Auto-refresh</div>
                            <div class="settings-item-desc">Automatically update scores every 30 seconds</div>
                        </div>
                        <label class="settings-toggle">
                            <input type="checkbox" id="settings-autorefresh">
                            <span class="settings-toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-group">
                    <div class="settings-item column">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Favorite Team</div>
                            <div class="settings-item-desc">Your favorite team appears first and gets alerts</div>
                        </div>
                        <select id="settings-favorite-team" class="settings-select">
                            <option value="">None</option>
                        </select>
                    </div>
                </div>
                <div class="settings-group">
                    <div class="settings-item column">
                        <div class="settings-item-info">
                            <div class="settings-item-title">Watchlist</div>
                            <div class="settings-item-desc">Track multiple teams for alerts</div>
                        </div>
                        <button class="settings-btn" onclick="closeSettingsModal(); openWatchlistModal();">
                            Edit Watchlist
                        </button>
                    </div>
                </div>
                <div id="notification-permission-notice" class="settings-notice" style="display: none;">
                    <span class="settings-notice-icon"></span>
                    <div style="flex: 1;">
                        <div style="margin-bottom: 6px;"><strong>Notifications blocked</strong></div>
                        <div style="font-size: 0.75rem; line-height: 1.4;">
                            To enable: Click the <strong>lock icon</strong> (or info icon) in your browser's address bar, find <strong>Notifications</strong>, and set to <strong>Allow</strong>. Then refresh the page.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="header-top">
                <h1>NFL Scores</h1>
                <div class="header-controls">
                    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                        <span class="icon"></span>
                    </button>
                </div>
            </div>

            <div class="date-nav">
                <button id="prev-day" class="haptic" aria-label="Previous day"></button>
                <span class="current-date" id="current-date"></span>
                <button id="next-day" class="haptic" aria-label="Next day"></button>
            </div>
            <div class="swipe-hint">Swipe left/right to change date</div>
        </header>

        <div class="quick-settings">
            <button class="quick-btn" id="refresh-btn">
                <span class="icon"></span>
                <span>Refresh</span>
            </button>
            <button class="quick-btn" id="live-only-btn">
                <span class="icon"></span>
                <span>Live Only</span>
            </button>
            <button class="quick-btn active" id="auto-refresh-btn">
                <span class="icon"></span>
                <span>Auto-refresh</span>
            </button>
            <button class="quick-btn" id="notifications-btn">
                <span class="icon"></span>
                <span>Alerts</span>
            </button>
            <button class="quick-btn" id="settings-btn">
                <span class="icon"></span>
                <span>Settings</span>
            </button>
        </div>

        <div class="refresh-status" id="refresh-status"></div>

        <!-- Scores View -->
        <div class="page-view active" id="scores-view">
            <!-- Watchlist Section -->
            <div class="watchlist-section" id="watchlist-section" style="display: none;">
                <div class="watchlist-header">
                    <span class="watchlist-title">My Watchlist</span>
                    <button class="watchlist-edit-btn" onclick="toggleWatchlistEdit()">Edit</button>
                </div>
                <div class="watchlist-teams" id="watchlist-teams">
                    <!-- Populated dynamically -->
                </div>
            </div>

            <!-- Prediction Stats -->
            <div class="prediction-stats" id="prediction-stats-section" style="display: none;">
                <div class="prediction-stats-title">Your Prediction Record</div>
                <div class="prediction-stats-grid">
                    <div class="prediction-stat-box">
                        <div class="prediction-stat-value" id="pred-correct">0</div>
                        <div class="prediction-stat-label">Correct</div>
                    </div>
                    <div class="prediction-stat-box">
                        <div class="prediction-stat-value" id="pred-total">0</div>
                        <div class="prediction-stat-label">Total</div>
                    </div>
                    <div class="prediction-stat-box">
                        <div class="prediction-stat-value" id="pred-pct">0%</div>
                        <div class="prediction-stat-label">Accuracy</div>
                    </div>
                </div>
            </div>

            <div class="favorite-team-section">
                <label for="favorite-team">Your favorite team (shown first):</label>
                <select id="favorite-team" class="favorite-team-select">
                    <option value="">-- Select a team --</option>
                    <optgroup label="AFC East">
                        <option value="Buffalo Bills">Buffalo Bills</option>
                        <option value="Miami Dolphins">Miami Dolphins</option>
                        <option value="New England Patriots">New England Patriots</option>
                        <option value="New York Jets">New York Jets</option>
                    </optgroup>
                    <optgroup label="AFC North">
                        <option value="Baltimore Ravens">Baltimore Ravens</option>
                        <option value="Cincinnati Bengals">Cincinnati Bengals</option>
                        <option value="Cleveland Browns">Cleveland Browns</option>
                        <option value="Pittsburgh Steelers">Pittsburgh Steelers</option>
                    </optgroup>
                    <optgroup label="AFC South">
                        <option value="Houston Texans">Houston Texans</option>
                        <option value="Indianapolis Colts">Indianapolis Colts</option>
                        <option value="Jacksonville Jaguars">Jacksonville Jaguars</option>
                        <option value="Tennessee Titans">Tennessee Titans</option>
                    </optgroup>
                    <optgroup label="AFC West">
                        <option value="Denver Broncos">Denver Broncos</option>
                        <option value="Kansas City Chiefs">Kansas City Chiefs</option>
                        <option value="Las Vegas Raiders">Las Vegas Raiders</option>
                        <option value="Los Angeles Chargers">Los Angeles Chargers</option>
                    </optgroup>
                    <optgroup label="NFC East">
                        <option value="Dallas Cowboys">Dallas Cowboys</option>
                        <option value="New York Giants">New York Giants</option>
                        <option value="Philadelphia Eagles">Philadelphia Eagles</option>
                        <option value="Washington Commanders">Washington Commanders</option>
                    </optgroup>
                    <optgroup label="NFC North">
                        <option value="Chicago Bears">Chicago Bears</option>
                        <option value="Detroit Lions">Detroit Lions</option>
                        <option value="Green Bay Packers">Green Bay Packers</option>
                        <option value="Minnesota Vikings">Minnesota Vikings</option>
                    </optgroup>
                    <optgroup label="NFC South">
                        <option value="Atlanta Falcons">Atlanta Falcons</option>
                        <option value="Carolina Panthers">Carolina Panthers</option>
                        <option value="New Orleans Saints">New Orleans Saints</option>
                        <option value="Tampa Bay Buccaneers">Tampa Bay Buccaneers</option>
                    </optgroup>
                    <optgroup label="NFC West">
                        <option value="Arizona Cardinals">Arizona Cardinals</option>
                        <option value="Los Angeles Rams">Los Angeles Rams</option>
                        <option value="San Francisco 49ers">San Francisco 49ers</option>
                        <option value="Seattle Seahawks">Seattle Seahawks</option>
                    </optgroup>
                </select>
            </div>

            <div class="games-container" id="games-container">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Loading scores...
                </div>
            </div>
        </div>

        <!-- Standings View -->
        <div class="page-view" id="standings-view">
            <div class="conference-tabs">
                <button class="conf-tab active" data-conference="AFC">AFC</button>
                <button class="conf-tab" data-conference="NFC">NFC</button>
            </div>
            <div id="standings-container">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Loading standings...
                </div>
            </div>
            <div class="standings-legend">
                <div class="legend-item"><span class="playoff-dot clinched"></span> Clinched</div>
                <div class="legend-item"><span class="playoff-dot wildcard"></span> Wild Card</div>
                <div class="legend-item"><span class="playoff-dot eliminated"></span> Eliminated</div>
            </div>
        </div>

        <!-- Playoff Bracket View -->
        <div class="page-view" id="bracket-view">
            <div id="bracket-container">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Loading playoff bracket...
                </div>
            </div>
        </div>

        <!-- Season Stats View -->
        <div class="page-view" id="stats-view">
            <div class="season-stats-section">
                <div class="season-stats-header">
                    <span class="season-stats-title">Season Leaders</span>
                </div>
                <div class="season-stats-tabs">
                    <button class="season-stat-tab active" onclick="switchStatCategory('passing')">Passing</button>
                    <button class="season-stat-tab" onclick="switchStatCategory('rushing')">Rushing</button>
                    <button class="season-stat-tab" onclick="switchStatCategory('receiving')">Receiving</button>
                    <button class="season-stat-tab" onclick="switchStatCategory('defense')">Defense</button>
                </div>
                <div id="season-stats-content">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading stats...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-view="scores">
            <span class="icon"></span>
            <span>Scores</span>
        </button>
        <button class="nav-item" data-view="standings">
            <span class="icon"></span>
            <span>Standings</span>
        </button>
        <button class="nav-item" data-view="stats">
            <span class="icon"></span>
            <span>Stats</span>
        </button>
        <button class="nav-item" data-view="bracket">
            <span class="icon"></span>
            <span>Bracket</span>
        </button>
    </nav>

    <script>
        // State
        let currentDate = new Date();
        let refreshInterval = null;
        let hasLiveGames = false;
        let favoriteTeam = localStorage.getItem('favoriteTeam') || '';
        let autoRefresh = localStorage.getItem('autoRefresh') !== 'false';
        let showLiveOnly = false;
        let currentView = 'scores';
        let previousScores = {};
        let countdownIntervals = [];
        let gameDatesCache = [];
        let isNavigating = false;

        // Confetti system
        const confettiCanvas = document.getElementById('confetti-canvas');
        const confettiCtx = confettiCanvas.getContext('2d');
        let confettiParticles = [];
        let confettiAnimating = false;

        function resizeConfettiCanvas() {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
        }
        resizeConfettiCanvas();
        window.addEventListener('resize', resizeConfettiCanvas);

        class ConfettiParticle {
            constructor(teamColorsList = null) {
                this.x = Math.random() * confettiCanvas.width;
                this.y = -20;
                this.size = Math.random() * 10 + 5;
                this.speedY = Math.random() * 3 + 2;
                this.speedX = Math.random() * 4 - 2;
                this.rotation = Math.random() * 360;
                this.rotationSpeed = Math.random() * 10 - 5;
                // FEATURE 6: Team-colored confetti - use team colors if provided
                const defaultColors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
                const colors = teamColorsList && teamColorsList.length > 0 ? teamColorsList : defaultColors;
                this.color = colors[Math.floor(Math.random() * colors.length)];
                this.opacity = 1;
            }

            update() {
                this.y += this.speedY;
                this.x += this.speedX;
                this.rotation += this.rotationSpeed;
                this.speedY += 0.1; // gravity
                this.opacity -= 0.005;
                return this.y < confettiCanvas.height && this.opacity > 0;
            }

            draw() {
                confettiCtx.save();
                confettiCtx.translate(this.x, this.y);
                confettiCtx.rotate(this.rotation * Math.PI / 180);
                confettiCtx.fillStyle = this.color;
                confettiCtx.globalAlpha = this.opacity;
                confettiCtx.fillRect(-this.size / 2, -this.size / 4, this.size, this.size / 2);
                confettiCtx.restore();
            }
        }

        // FEATURE 6: Enhanced confetti launcher with team colors
        function launchConfetti(count = 100, teamName = null) {
            let teamColorsList = null;
            if (teamName && teamColors[teamName]) {
                const tc = teamColors[teamName];
                teamColorsList = [tc.primary, tc.secondary, tc.primary, tc.secondary, '#FFD700', '#FFFFFF'];
            }

            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    confettiParticles.push(new ConfettiParticle(teamColorsList));
                }, i * 10);
            }

            if (!confettiAnimating) {
                confettiAnimating = true;
                animateConfetti();
            }
        }

        function animateConfetti() {
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);

            confettiParticles = confettiParticles.filter(p => {
                p.draw();
                return p.update();
            });

            if (confettiParticles.length > 0) {
                requestAnimationFrame(animateConfetti);
            } else {
                confettiAnimating = false;
            }
        }

        // Score change detection with team-colored confetti (FEATURE 6)
        function checkScoreChanges(events) {
            events.forEach((event, index) => {
                const eventId = event.id;
                const comp = event.competitions[0];
                const home = comp.competitors.find(c => c.homeAway === 'home');
                const away = comp.competitors.find(c => c.homeAway === 'away');
                const homeScore = parseInt(home.score) || 0;
                const awayScore = parseInt(away.score) || 0;
                const homeTeamName = home.team.displayName;
                const awayTeamName = away.team.displayName;

                const prevScores = previousScores[eventId];
                if (prevScores) {
                    const homeDiff = homeScore - prevScores.home;
                    const awayDiff = awayScore - prevScores.away;

                    // Animate if scores changed
                    if (homeDiff > 0) {
                        const scoreEl = document.getElementById(`score-home-${index}`);
                        if (scoreEl) {
                            scoreEl.classList.remove('score-updated', 'touchdown-score');
                            void scoreEl.offsetWidth; // Force reflow
                            scoreEl.classList.add(homeDiff >= 6 ? 'touchdown-score' : 'score-updated');

                            // FEATURE 6: Launch team-colored confetti for touchdowns
                            if (homeDiff >= 6) {
                                launchConfetti(150, homeTeamName);
                            }
                        }
                    }

                    if (awayDiff > 0) {
                        const scoreEl = document.getElementById(`score-away-${index}`);
                        if (scoreEl) {
                            scoreEl.classList.remove('score-updated', 'touchdown-score');
                            void scoreEl.offsetWidth; // Force reflow
                            scoreEl.classList.add(awayDiff >= 6 ? 'touchdown-score' : 'score-updated');

                            // FEATURE 6: Launch team-colored confetti for touchdowns
                            if (awayDiff >= 6) {
                                launchConfetti(150, awayTeamName);
                            }
                        }
                    }
                }

                // Store current scores for next comparison
                previousScores[eventId] = { home: homeScore, away: awayScore };
            });
        }

        // Theme
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon();

        function updateThemeIcon() {
            const icon = document.querySelector('#theme-toggle .icon');
            icon.textContent = document.documentElement.getAttribute('data-theme') === 'dark' ? '' : '';
        }

        document.getElementById('theme-toggle').addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeIcon();
        });

        // Stadium data
        const stadiums = {
            'Buffalo Bills': { lat: 42.7738, lon: -78.7870, dome: false, name: 'Highmark Stadium', capacity: 71608 },
            'Miami Dolphins': { lat: 25.9580, lon: -80.2389, dome: false, name: 'Hard Rock Stadium', capacity: 64767 },
            'New England Patriots': { lat: 42.0909, lon: -71.2643, dome: false, name: 'Gillette Stadium', capacity: 65878 },
            'New York Jets': { lat: 40.8135, lon: -74.0745, dome: false, name: 'MetLife Stadium', capacity: 82500 },
            'Baltimore Ravens': { lat: 39.2780, lon: -76.6227, dome: false, name: 'M&T Bank Stadium', capacity: 71008 },
            'Cincinnati Bengals': { lat: 39.0955, lon: -84.5161, dome: false, name: 'Paycor Stadium', capacity: 65515 },
            'Cleveland Browns': { lat: 41.5061, lon: -81.6995, dome: false, name: 'Huntington Bank Field', capacity: 67431 },
            'Pittsburgh Steelers': { lat: 40.4468, lon: -80.0158, dome: false, name: 'Acrisure Stadium', capacity: 68400 },
            'Houston Texans': { lat: 29.6847, lon: -95.4107, dome: true, name: 'NRG Stadium', capacity: 72220 },
            'Indianapolis Colts': { lat: 39.7601, lon: -86.1639, dome: true, name: 'Lucas Oil Stadium', capacity: 67000 },
            'Jacksonville Jaguars': { lat: 30.3240, lon: -81.6373, dome: false, name: 'EverBank Stadium', capacity: 67814 },
            'Tennessee Titans': { lat: 36.1665, lon: -86.7713, dome: false, name: 'Nissan Stadium', capacity: 69143 },
            'Denver Broncos': { lat: 39.7439, lon: -105.0201, dome: false, name: 'Empower Field at Mile High', capacity: 76125 },
            'Kansas City Chiefs': { lat: 39.0489, lon: -94.4839, dome: false, name: 'GEHA Field at Arrowhead Stadium', capacity: 76416 },
            'Las Vegas Raiders': { lat: 36.0909, lon: -115.1833, dome: true, name: 'Allegiant Stadium', capacity: 65000 },
            'Los Angeles Chargers': { lat: 33.9535, lon: -118.3392, dome: true, name: 'SoFi Stadium', capacity: 70240 },
            'Dallas Cowboys': { lat: 32.7473, lon: -97.0945, dome: true, name: 'AT&T Stadium', capacity: 80000 },
            'New York Giants': { lat: 40.8135, lon: -74.0745, dome: false, name: 'MetLife Stadium', capacity: 82500 },
            'Philadelphia Eagles': { lat: 39.9008, lon: -75.1675, dome: false, name: 'Lincoln Financial Field', capacity: 69796 },
            'Washington Commanders': { lat: 38.9076, lon: -76.8645, dome: false, name: 'Northwest Stadium', capacity: 67617 },
            'Chicago Bears': { lat: 41.8623, lon: -87.6167, dome: false, name: 'Soldier Field', capacity: 61500 },
            'Detroit Lions': { lat: 42.3400, lon: -83.0456, dome: true, name: 'Ford Field', capacity: 65000 },
            'Green Bay Packers': { lat: 44.5013, lon: -88.0622, dome: false, name: 'Lambeau Field', capacity: 81441 },
            'Minnesota Vikings': { lat: 44.9737, lon: -93.2577, dome: true, name: 'U.S. Bank Stadium', capacity: 66860 },
            'Atlanta Falcons': { lat: 33.7554, lon: -84.4010, dome: true, name: 'Mercedes-Benz Stadium', capacity: 71000 },
            'Carolina Panthers': { lat: 35.2258, lon: -80.8528, dome: false, name: 'Bank of America Stadium', capacity: 74867 },
            'New Orleans Saints': { lat: 29.9511, lon: -90.0812, dome: true, name: 'Caesars Superdome', capacity: 73208 },
            'Tampa Bay Buccaneers': { lat: 27.9759, lon: -82.5033, dome: false, name: 'Raymond James Stadium', capacity: 65890 },
            'Arizona Cardinals': { lat: 33.5276, lon: -112.2626, dome: true, name: 'State Farm Stadium', capacity: 63400 },
            'Los Angeles Rams': { lat: 33.9535, lon: -118.3392, dome: true, name: 'SoFi Stadium', capacity: 70240 },
            'San Francisco 49ers': { lat: 37.4033, lon: -121.9694, dome: false, name: "Levi's Stadium", capacity: 68500 },
            'Seattle Seahawks': { lat: 47.5952, lon: -122.3316, dome: false, name: 'Lumen Field', capacity: 68740 }
        };

        // YouTube API handled securely by backend server

        // Team colors
        const teamColors = {
            'Arizona Cardinals': { primary: '#97233F', secondary: '#000000' },
            'Atlanta Falcons': { primary: '#A71930', secondary: '#000000' },
            'Baltimore Ravens': { primary: '#241773', secondary: '#9E7C0C' },
            'Buffalo Bills': { primary: '#00338D', secondary: '#C60C30' },
            'Carolina Panthers': { primary: '#0085CA', secondary: '#000000' },
            'Chicago Bears': { primary: '#C83803', secondary: '#0B162A' },
            'Cincinnati Bengals': { primary: '#FB4F14', secondary: '#000000' },
            'Cleveland Browns': { primary: '#FF3C00', secondary: '#311D00' },
            'Dallas Cowboys': { primary: '#003594', secondary: '#869397' },
            'Denver Broncos': { primary: '#FB4F14', secondary: '#002244' },
            'Detroit Lions': { primary: '#0076B6', secondary: '#B0B7BC' },
            'Green Bay Packers': { primary: '#203731', secondary: '#FFB612' },
            'Houston Texans': { primary: '#A71930', secondary: '#03202F' },
            'Indianapolis Colts': { primary: '#002C5F', secondary: '#A2AAAD' },
            'Jacksonville Jaguars': { primary: '#006778', secondary: '#D7A22A' },
            'Kansas City Chiefs': { primary: '#E31837', secondary: '#FFB81C' },
            'Las Vegas Raiders': { primary: '#A5ACAF', secondary: '#000000' },
            'Los Angeles Chargers': { primary: '#0080C6', secondary: '#FFC20E' },
            'Los Angeles Rams': { primary: '#003594', secondary: '#FFA300' },
            'Miami Dolphins': { primary: '#008E97', secondary: '#FC4C02' },
            'Minnesota Vikings': { primary: '#4F2683', secondary: '#FFC62F' },
            'New England Patriots': { primary: '#C60C30', secondary: '#002244' },
            'New Orleans Saints': { primary: '#D3BC8D', secondary: '#101820' },
            'New York Giants': { primary: '#0B2265', secondary: '#A71930' },
            'New York Jets': { primary: '#125740', secondary: '#000000' },
            'Philadelphia Eagles': { primary: '#004C54', secondary: '#A5ACAF' },
            'Pittsburgh Steelers': { primary: '#FFB612', secondary: '#101820' },
            'San Francisco 49ers': { primary: '#AA0000', secondary: '#B3995D' },
            'Seattle Seahawks': { primary: '#69BE28', secondary: '#002244' },
            'Tampa Bay Buccaneers': { primary: '#D50A0A', secondary: '#FF7900' },
            'Tennessee Titans': { primary: '#0C2340', secondary: '#4B92DB' },
            'Washington Commanders': { primary: '#5A1414', secondary: '#FFB612' }
        };

        // Weather
        function getWeatherInfo(code, isDay = true) {
            const weatherMap = {
                0: { icon: isDay ? '' : '', desc: 'Clear' },
                1: { icon: isDay ? '' : '', desc: 'Mostly Clear' },
                2: { icon: '', desc: 'Partly Cloudy' },
                3: { icon: '', desc: 'Cloudy' },
                45: { icon: '', desc: 'Foggy' },
                48: { icon: '', desc: 'Icy Fog' },
                51: { icon: '', desc: 'Light Drizzle' },
                53: { icon: '', desc: 'Drizzle' },
                55: { icon: '', desc: 'Heavy Drizzle' },
                61: { icon: '', desc: 'Light Rain' },
                63: { icon: '', desc: 'Rain' },
                65: { icon: '', desc: 'Heavy Rain' },
                71: { icon: '', desc: 'Light Snow' },
                73: { icon: '', desc: 'Snow' },
                75: { icon: '', desc: 'Heavy Snow' },
                80: { icon: '', desc: 'Showers' },
                95: { icon: '', desc: 'Thunderstorm' }
            };
            return weatherMap[code] || { icon: '', desc: 'Unknown' };
        }

        function celsiusToFahrenheit(c) { return Math.round((c * 9/5) + 32); }

        // Weather cache to reduce API calls
        const weatherCache = {};
        const gridPointCache = {};
        const WEATHER_CACHE_DURATION = 30 * 60 * 1000; // 30 minutes

        // Get NWS grid point for a location (cached)
        async function getNWSGridPoint(lat, lon) {
            const key = `${lat.toFixed(2)}_${lon.toFixed(2)}`;
            if (gridPointCache[key]) return gridPointCache[key];

            const response = await fetch(`https://api.weather.gov/points/${lat},${lon}`, {
                headers: { 'User-Agent': 'NFLScores/1.0' }
            });
            if (!response.ok) throw new Error(`NWS points API error: ${response.status}`);
            const data = await response.json();
            const result = {
                forecastHourly: data.properties.forecastHourly,
                gridId: data.properties.gridId,
                gridX: data.properties.gridX,
                gridY: data.properties.gridY
            };
            gridPointCache[key] = result;
            return result;
        }

        // Parse NWS weather icon to get conditions
        function parseNWSConditions(shortForecast) {
            const lower = shortForecast.toLowerCase();
            if (lower.includes('snow')) return { icon: '', desc: 'Snow' };
            if (lower.includes('thunder') || lower.includes('storm')) return { icon: '', desc: 'Storms' };
            if (lower.includes('rain') || lower.includes('shower')) return { icon: '', desc: 'Rain' };
            if (lower.includes('fog')) return { icon: '', desc: 'Fog' };
            if (lower.includes('cloud') || lower.includes('overcast')) return { icon: '', desc: 'Cloudy' };
            if (lower.includes('partly')) return { icon: '', desc: 'Partly Cloudy' };
            if (lower.includes('sun') || lower.includes('clear')) return { icon: '', desc: 'Clear' };
            return { icon: '', desc: shortForecast.split(' ').slice(0, 2).join(' ') };
        }

        async function fetchWeather(lat, lon, gameDate) {
            const gameHour = gameDate.getHours();
            const cacheKey = `${lat.toFixed(2)}_${lon.toFixed(2)}_${gameDate.toDateString()}_${gameHour}`;

            // Check cache first
            const cached = weatherCache[cacheKey];
            if (cached && (Date.now() - cached.timestamp) < WEATHER_CACHE_DURATION) {
                return cached.data;
            }

            try {
                // Use National Weather Service API (free, no rate limits)
                const gridPoint = await getNWSGridPoint(lat, lon);
                const forecastResponse = await fetch(gridPoint.forecastHourly, {
                    headers: { 'User-Agent': 'NFLScores/1.0' }
                });
                if (!forecastResponse.ok) throw new Error(`NWS forecast API error: ${forecastResponse.status}`);
                const forecastData = await forecastResponse.json();

                // Find the forecast period closest to game time
                const periods = forecastData.properties.periods;
                let bestPeriod = periods[0];
                const gameTime = gameDate.getTime();

                for (const period of periods) {
                    const periodTime = new Date(period.startTime).getTime();
                    if (Math.abs(periodTime - gameTime) < Math.abs(new Date(bestPeriod.startTime).getTime() - gameTime)) {
                        bestPeriod = period;
                    }
                }

                const result = {
                    temp: bestPeriod.temperature,
                    ...parseNWSConditions(bestPeriod.shortForecast)
                };

                // Cache the result
                weatherCache[cacheKey] = { data: result, timestamp: Date.now() };
                return result;

            } catch (e) {
                console.error('NWS Weather fetch error:', e);
                // Fallback to Open-Meteo if NWS fails
                return await fetchWeatherOpenMeteo(lat, lon, gameDate);
            }
        }

        // Fallback to Open-Meteo API
        async function fetchWeatherOpenMeteo(lat, lon, gameDate) {
            try {
                const year = gameDate.getFullYear();
                const month = String(gameDate.getMonth() + 1).padStart(2, '0');
                const day = String(gameDate.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                const gameHour = gameDate.getHours();

                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,weather_code&start_date=${dateStr}&end_date=${dateStr}&timezone=auto`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                if (data.error) throw new Error(data.reason);

                if (data.hourly?.time && data.hourly.temperature_2m) {
                    const hourIndex = Math.min(Math.max(gameHour, 0), data.hourly.time.length - 1);
                    const temp = data.hourly.temperature_2m[hourIndex];
                    const code = data.hourly.weather_code[hourIndex];
                    if (temp !== null && temp !== undefined) {
                        return {
                            temp: celsiusToFahrenheit(temp),
                            ...getWeatherInfo(code, gameHour >= 6 && gameHour < 20)
                        };
                    }
                }
            } catch (e) {
                console.error('Open-Meteo fallback error:', e);
            }
            return null;
        }

        // Date helpers
        function formatDate(date) {
            const today = new Date();
            const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
            const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);

            const isToday = date.toDateString() === today.toDateString();
            const isYesterday = date.toDateString() === yesterday.toDateString();
            const isTomorrow = date.toDateString() === tomorrow.toDateString();

            if (isToday) return 'Today';
            if (isYesterday) return 'Yesterday';
            if (isTomorrow) return 'Tomorrow';

            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }

        function formatApiDate(date) {
            return `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}`;
        }

        function updateDateDisplay() {
            document.getElementById('current-date').textContent = formatDate(currentDate);
        }

        // Countdown
        function getCountdown(gameDate) {
            const now = new Date();
            const diff = gameDate - now;
            if (diff <= 0) return null;

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${mins}m`;
            return `${mins}m`;
        }

        function updateCountdowns() {
            document.querySelectorAll('.countdown').forEach(el => {
                const gameDate = new Date(el.dataset.gameDate);
                const countdown = getCountdown(gameDate);
                if (countdown) {
                    el.textContent = `Starts in ${countdown}`;
                } else {
                    el.style.display = 'none';
                }
            });
        }

        // Smart date navigation - fetch game dates
        async function fetchGameDates() {
            if (gameDatesCache.length > 0) return gameDatesCache;

            try {
                // Get current NFL season dates (Sep-Feb range)
                const now = new Date();
                const year = now.getMonth() >= 8 ? now.getFullYear() : now.getFullYear() - 1;
                const startDate = `${year}0901`;
                const endDate = `${year + 1}0215`;

                const url = `https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard?dates=${startDate}-${endDate}&limit=500`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.events) {
                    const dates = new Set();
                    data.events.forEach(event => {
                        const eventDate = new Date(event.date);
                        const dateStr = eventDate.toDateString();
                        dates.add(dateStr);
                    });
                    gameDatesCache = Array.from(dates).map(d => new Date(d)).sort((a, b) => a - b);
                }
            } catch (e) {
                console.error('Failed to fetch game dates:', e);
            }
            return gameDatesCache;
        }

        async function navigateToGameDay(direction) {
            if (isNavigating) return;
            isNavigating = true;

            const navBtn = document.getElementById(direction > 0 ? 'next-day' : 'prev-day');
            navBtn.innerHTML = '<span class="loading-dots">...</span>';

            const gameDates = await fetchGameDates();

            if (gameDates.length === 0) {
                // Fallback to regular navigation if no cache
                currentDate.setDate(currentDate.getDate() + direction);
            } else {
                const currentTime = currentDate.setHours(0, 0, 0, 0);

                if (direction > 0) {
                    // Find next game day
                    const nextGame = gameDates.find(d => d.getTime() > currentTime);
                    if (nextGame) {
                        currentDate = new Date(nextGame);
                    } else {
                        // No more games, go to last game day
                        currentDate = new Date(gameDates[gameDates.length - 1]);
                    }
                } else {
                    // Find previous game day
                    const prevGames = gameDates.filter(d => d.getTime() < currentTime);
                    if (prevGames.length > 0) {
                        currentDate = new Date(prevGames[prevGames.length - 1]);
                    } else {
                        // No previous games, go to first game day
                        currentDate = new Date(gameDates[0]);
                    }
                }
            }

            navBtn.textContent = direction > 0 ? '' : '';
            updateDateDisplay();

            // Add slide animation
            const container = document.getElementById('games-container');
            container.classList.remove('slide-left', 'slide-right');
            container.classList.add(direction > 0 ? 'slide-left' : 'slide-right');

            await fetchScores();

            // Clean up animation class after it completes
            setTimeout(() => {
                container.classList.remove('slide-left', 'slide-right');
            }, 300);

            isNavigating = false;
        }

        // Main fetch
        async function fetchScores() {
            const container = document.getElementById('games-container');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading scores...</div>';

            // Clear countdown intervals
            countdownIntervals.forEach(clearInterval);
            countdownIntervals = [];

            const dateStr = formatApiDate(currentDate);
            const url = `https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard?dates=${dateStr}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (!data.events || data.events.length === 0) {
                    container.innerHTML = '<div class="no-games">No games scheduled for this date</div>';
                    return;
                }

                let events = [...data.events];

                // Filter live only
                if (showLiveOnly) {
                    events = events.filter(e => e.status.type.state === 'in');
                    if (events.length === 0) {
                        container.innerHTML = '<div class="no-games">No live games right now</div>';
                        return;
                    }
                }

                // Sort: favorite team first
                if (favoriteTeam) {
                    events.sort((a, b) => {
                        const aFav = a.competitions[0].competitors.some(c => c.team.displayName === favoriteTeam);
                        const bFav = b.competitions[0].competitors.some(c => c.team.displayName === favoriteTeam);
                        return bFav - aFav;
                    });
                }

                const gameCards = events.map((event, index) => {
                    const comp = event.competitions[0];
                    const home = comp.competitors.find(c => c.homeAway === 'home');
                    const away = comp.competitors.find(c => c.homeAway === 'away');
                    const status = event.status.type;
                    const gameDate = new Date(event.date);

                    const homeScore = parseInt(home.score) || 0;
                    const awayScore = parseInt(away.score) || 0;
                    const homeWinner = status.completed && homeScore > awayScore;
                    const awayWinner = status.completed && awayScore > homeScore;

                    const isFavorite = favoriteTeam && (home.team.displayName === favoriteTeam || away.team.displayName === favoriteTeam);
                    const isLive = status.state === 'in';
                    const isUpcoming = status.state === 'pre';

                    const stadium = stadiums[home.team.displayName];
                    const odds = comp.odds?.[0];

                    // Get team colors
                    const homeColors = teamColors[home.team.displayName] || { primary: '#666', secondary: '#444' };
                    const awayColors = teamColors[away.team.displayName] || { primary: '#666', secondary: '#444' };

                    // Build card HTML
                    let html = `
                        <div class="game-card team-colored${isFavorite ? ' favorite-team' : ''}" style="--home-color: ${homeColors.primary}; --away-color: ${awayColors.primary};" data-event-id="${event.id}" data-index="${index}">
                            ${isFavorite ? '<span class="favorite-badge">Your Team</span>' : ''}
                            <div class="game-layout">
                                <div class="teams-row">
                                    <div class="team-block away">
                                        <img src="${away.team.logo}" alt="${away.team.displayName}" class="team-logo">
                                        <div class="team-name">${away.team.shortDisplayName || away.team.displayName}</div>
                                        <div class="team-record">${away.records?.[0]?.summary || ''}</div>
                                    </div>
                                    <div class="score-block">
                                        <div class="scores-display">
                                            <span class="score ${awayWinner ? 'winner' : ''}" id="score-away-${index}">${away.score || '-'}</span>
                                            <span class="score-divider">-</span>
                                            <span class="score ${homeWinner ? 'winner' : ''}" id="score-home-${index}">${home.score || '-'}</span>
                                        </div>
                                        <div class="game-status ${status.completed ? 'final' : ''} ${isLive ? 'live' : ''}">
                                            ${isLive ? '<span class="live-dot"></span>' : ''}
                                            ${status.shortDetail}
                                        </div>
                                        ${isUpcoming ? `<div class="countdown" data-game-date="${gameDate.toISOString()}"></div>` : ''}
                                    </div>
                                    <div class="team-block home">
                                        <img src="${home.team.logo}" alt="${home.team.displayName}" class="team-logo">
                                        <div class="team-name">${home.team.shortDisplayName || home.team.displayName}</div>
                                        <div class="team-record">${home.records?.[0]?.summary || ''}</div>
                                    </div>
                                </div>

                                <div class="game-details">
                                    <div class="detail-row">
                                        <div class="detail-chip weather-chip${stadium?.dome ? ' dome' : ''}" id="weather-${index}">
                                            <span class="icon"></span>
                                            <span class="value">Loading...</span>
                                        </div>
                                        <div class="detail-chip">
                                            <span class="icon"></span>
                                            <span class="value">${stadium?.name || 'Stadium'}</span>
                                        </div>
                                    </div>
                    `;

                    // FEATURE 9: Enhanced Odds/Spreads Display
                    if (odds && !status.completed) {
                        // Parse spread to get favorite team
                        let favoriteTeam = '';
                        let spreadValue = '';
                        if (odds.details) {
                            const spreadMatch = odds.details.match(/([A-Z]+)\s*([-+]?[\d.]+)/);
                            if (spreadMatch) {
                                favoriteTeam = spreadMatch[1];
                                spreadValue = spreadMatch[2];
                            }
                        }

                        // Get moneyline values
                        const awayML = odds.awayTeamOdds?.moneyLine || '';
                        const homeML = odds.homeTeamOdds?.moneyLine || '';

                        html += `
                            <div class="odds-display">
                                <div class="odds-header">
                                    <span></span> Betting Lines
                                </div>
                                <div class="odds-grid">
                                    ${odds.details ? `
                                    <div class="odds-card">
                                        <div class="odds-card-label">Spread</div>
                                        <div class="odds-card-value">${odds.details}</div>
                                    </div>` : ''}
                                    ${odds.overUnder ? `
                                    <div class="odds-card">
                                        <div class="odds-card-label">Over/Under</div>
                                        <div class="odds-card-value">${odds.overUnder}</div>
                                    </div>` : ''}
                                    ${odds.provider?.name ? `
                                    <div class="odds-card">
                                        <div class="odds-card-label">Provider</div>
                                        <div class="odds-card-value" style="font-size: 0.75rem; color: var(--text-secondary);">${odds.provider.name}</div>
                                    </div>` : ''}
                                </div>
                                ${(awayML || homeML) ? `
                                <div class="moneyline-display">
                                    <div class="moneyline-team">
                                        <div class="moneyline-team-info">
                                            <img src="${away.team.logo}" alt="">
                                            <span>${away.team.abbreviation}</span>
                                        </div>
                                        <span class="moneyline-value ${parseInt(awayML) < 0 ? 'favorite' : 'underdog'}">${awayML > 0 ? '+' : ''}${awayML}</span>
                                    </div>
                                    <div class="moneyline-team">
                                        <div class="moneyline-team-info">
                                            <img src="${home.team.logo}" alt="">
                                            <span>${home.team.abbreviation}</span>
                                        </div>
                                        <span class="moneyline-value ${parseInt(homeML) < 0 ? 'favorite' : 'underdog'}">${homeML > 0 ? '+' : ''}${homeML}</span>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        `;
                    }

                    // Live situation placeholder
                    if (isLive) {
                        html += `<div class="live-situation" id="situation-${index}"><div class="loading">Loading live data...</div></div>`;

                        // NEW FEATURE: Game Cast Mini button for live games
                        html += `
                            <button class="expand-btn" style="background: rgba(252, 129, 129, 0.15); border: 1px solid rgba(252, 129, 129, 0.3);" onclick="showGameCastMini('${event.id}', '${away.team.displayName.replace(/'/g, "\\'")}', '${home.team.displayName.replace(/'/g, "\\'")}', '${away.team.logo}', '${home.team.logo}', '${away.score || 0}', '${home.score || 0}', '${status.shortDetail.replace(/'/g, "\\'")}')">
                                <span> Pin Live Score</span>
                            </button>
                        `;

                        // NEW FEATURE: Play-by-Play for live games
                        html += `
                            <button class="expand-btn" onclick="togglePlayByPlay(${index}, '${event.id}')">
                                <span>Play-by-Play</span>
                                <span class="arrow"></span>
                            </button>
                            <div class="expandable-content" id="pbp-${index}"></div>
                        `;
                    }

                    // Upcoming game buttons
                    if (isUpcoming) {
                        // NEW FEATURE: Game Predictions
                        html += renderPredictionSection(event.id, away, home, isUpcoming, status.completed);

                        html += `
                            <button class="expand-btn" onclick="toggleTeamComparison(${index}, '${away.team.id}', '${home.team.id}', '${away.team.displayName}', '${home.team.displayName}', '${away.team.logo}', '${home.team.logo}')">
                                <span> Team Comparison</span>
                                <span class="arrow"></span>
                            </button>
                            <div class="expandable-content" id="comparison-${index}"></div>
                            <button class="expand-btn" onclick="toggleH2H(${index}, '${away.team.id}', '${home.team.id}', '${away.team.displayName}', '${home.team.displayName}', '${away.team.logo}', '${home.team.logo}')">
                                <span> Head to Head</span>
                                <span class="arrow"></span>
                            </button>
                            <div class="expandable-content" id="h2h-${index}"></div>
                            <button class="expand-btn injuries-btn" onclick="toggleInjuries(${index}, '${away.team.id}', '${home.team.id}')">
                                <span> View Injuries</span>
                                <span class="arrow"></span>
                            </button>
                            <div class="expandable-content" id="injuries-${index}"></div>
                        `;

                        // NEW FEATURE: Calendar Export
                        const venueName = stadium?.name || 'Stadium';
                        html += `
                            <button class="calendar-export-btn" onclick="exportToCalendar('${event.id}', '${away.team.displayName.replace(/'/g, "\\'")}', '${home.team.displayName.replace(/'/g, "\\'")}', '${gameDate.toISOString()}', '${venueName.replace(/'/g, "\\'")}')">
                                <span></span> Add to Calendar
                            </button>
                        `;
                    }

                    // Stats for completed/live games
                    const leaders = comp.leaders || [];
                    const linescores = away.linescores?.length > 0 || home.linescores?.length > 0;
                    if ((leaders.length > 0 || linescores) && (isLive || status.completed)) {
                        html += `
                            <button class="expand-btn" onclick="toggleStats(${index})">
                                <span> Game Stats</span>
                                <span class="arrow"></span>
                            </button>
                            <div class="expandable-content" id="stats-${index}">
                        `;

                        // Quarter scores
                        if (linescores) {
                            const awayLS = away.linescores || [];
                            const homeLS = home.linescores || [];
                            const qtrs = Math.max(awayLS.length, homeLS.length);
                            let headers = '<th class="team-col">Team</th>';
                            for (let q = 1; q <= qtrs; q++) headers += `<th>${q <= 4 ? 'Q' + q : 'OT'}</th>`;
                            headers += '<th class="total-col">T</th>';

                            let awayRow = `<td class="team-col">${away.team.abbreviation}</td>`;
                            let homeRow = `<td class="team-col">${home.team.abbreviation}</td>`;
                            for (let q = 0; q < qtrs; q++) {
                                awayRow += `<td>${awayLS[q]?.displayValue || '-'}</td>`;
                                homeRow += `<td>${homeLS[q]?.displayValue || '-'}</td>`;
                            }
                            awayRow += `<td class="total-col">${away.score || '-'}</td>`;
                            homeRow += `<td class="total-col">${home.score || '-'}</td>`;

                            html += `
                                <div class="quarter-scores">
                                    <table class="quarter-table">
                                        <tr>${headers}</tr>
                                        <tr>${awayRow}</tr>
                                        <tr>${homeRow}</tr>
                                    </table>
                                </div>
                            `;
                        }

                        // Full box score container (loaded async)
                        // FEATURE 8: Add compare players button
                        html += `
                        <button class="compare-players-btn" onclick="startPlayerComparison(${index})">
                            <span></span> Compare Players
                        </button>
                        <div id="boxscore-${index}" class="boxscore-container">
                            <div class="boxscore-loading">Loading full box score...</div>
                        </div>`;

                        html += '</div>';
                    }

                    // Scoring plays timeline (for live and completed games)
                    if (isLive || status.completed) {
                        html += `
                            <button class="expand-btn" onclick="toggleScoringPlays(${index}, '${event.id}')">
                                <span> Scoring Plays</span>
                                <span class="arrow"></span>
                            </button>
                            <div class="expandable-content" id="scoring-${index}"></div>
                        `;

                        // NEW FEATURE: Play-by-Play for completed games
                        if (status.completed) {
                            html += `
                                <button class="expand-btn" onclick="togglePlayByPlay(${index}, '${event.id}')">
                                    <span>Play-by-Play</span>
                                    <span class="arrow"></span>
                                </button>
                                <div class="expandable-content" id="pbp-${index}"></div>
                            `;
                        }
                    }

                    // NEW FEATURE: Prediction result for completed games
                    if (status.completed) {
                        html += renderPredictionSection(event.id, away, home, false, status.completed);
                    }

                    // Highlights for completed games
                    if (status.completed) {
                        const awayShort = (away.team.shortDisplayName || away.team.displayName).replace(/'/g, "\\'");
                        const homeShort = (home.team.shortDisplayName || home.team.displayName).replace(/'/g, "\\'");
                        const awayFull = away.team.displayName.replace(/'/g, "\\'");
                        const homeFull = home.team.displayName.replace(/'/g, "\\'");
                        const gameDate = event.date ? event.date.split('T')[0] : '';

                        // FEATURE 7: Share button for completed games
                        html += `
                            <button class="share-btn-enhanced" onclick="toggleShareMenu(${index})">
                                <span></span> Share
                            </button>
                            <div class="share-menu" id="share-menu-${index}">
                                <button class="share-menu-item" onclick="shareScoreCard(${index}, '${awayFull}', '${homeFull}', '${awayScore}', '${homeScore}', '${away.team.logo}', '${home.team.logo}', '${status.shortDetail.replace(/'/g, "\\'")}')">
                                    <span class="icon"></span> Share Score
                                </button>
                                <button class="share-menu-item" onclick="downloadScoreCard(${index}, '${awayFull}', '${homeFull}', '${awayScore}', '${homeScore}', '${away.team.logo}', '${home.team.logo}', '${status.shortDetail.replace(/'/g, "\\'")}')">
                                    <span class="icon"></span> Download Image
                                </button>
                            </div>
                        `;

                        html += `
                            <button class="expand-btn" onclick="toggleHighlights(${index}, '${event.id}', '${awayShort}', '${homeShort}', '${gameDate}')">
                                <span> Highlights</span>
                                <span class="arrow"></span>
                            </button>
                            <div class="expandable-content" id="highlights-${index}"></div>
                        `;
                    }

                    // Preview for upcoming games
                    if (!status.completed && !isLive) {
                        const awayShort = (away.team.shortDisplayName || away.team.displayName).replace(/'/g, "\\'");
                        const homeShort = (home.team.shortDisplayName || home.team.displayName).replace(/'/g, "\\'");
                        html += `
                            <button class="expand-btn" onclick="togglePreview(${index}, '${awayShort}', '${homeShort}')">
                                <span> Game Preview</span>
                                <span class="arrow"></span>
                            </button>
                            <div class="expandable-content" id="preview-${index}"></div>
                        `;
                    }

                    html += '</div></div></div>';
                    return html;
                }).join('');

                container.innerHTML = gameCards;

                // Check for score changes and animate
                checkScoreChanges(events);

                // NEW FEATURE: Check and send score notifications
                checkAndNotifyScores(events);

                // Update live games status
                hasLiveGames = events.some(e => e.status.type.state === 'in');
                setupRefreshInterval();

                // Fetch live game details
                events.forEach((event, index) => {
                    if (event.status.type.state === 'in') {
                        fetchLiveGameDetails(event.id, index);
                    }
                });

                // Fetch weather
                events.forEach(async (event, index) => {
                    const home = event.competitions[0].competitors.find(c => c.homeAway === 'home');
                    const stadium = stadiums[home.team.displayName];
                    const weatherEl = document.getElementById(`weather-${index}`);
                    if (!weatherEl) return;

                    if (!stadium) {
                        weatherEl.innerHTML = '<span class="icon"></span><span class="value">Unknown</span>';
                        return;
                    }

                    if (stadium.dome) {
                        weatherEl.classList.add('dome');
                        weatherEl.innerHTML = '<span class="icon"></span><span class="value">Dome  72F</span>';
                        return;
                    }

                    const gameDate = new Date(event.date);
                    const weather = await fetchWeather(stadium.lat, stadium.lon, gameDate);
                    if (weather) {
                        weatherEl.innerHTML = `<span class="icon">${weather.icon}</span><span class="value">${weather.temp}F  ${weather.desc}</span>`;
                    } else {
                        weatherEl.innerHTML = '<span class="icon"></span><span class="value">N/A</span>';
                    }
                });

                // Fetch box scores for completed/live games
                events.forEach((event, index) => {
                    const status = event.status.type;
                    const isLive = status.state === 'in';
                    const isCompleted = status.completed;
                    if (isLive || isCompleted) {
                        const comp = event.competitions[0];
                        const away = comp.competitors.find(c => c.homeAway === 'away');
                        const home = comp.competitors.find(c => c.homeAway === 'home');
                        fetchBoxScore(event.id, index, away, home);
                    }
                });

                // Start countdown updates
                updateCountdowns();
                countdownIntervals.push(setInterval(updateCountdowns, 60000));

            } catch (error) {
                console.error('Error:', error);
                container.innerHTML = '<div class="error">Error loading scores. Pull down to refresh.</div>';
            }
        }

        // Live game details - Enhanced with Features 3, 4, 5
        async function fetchLiveGameDetails(eventId, index) {
            try {
                const response = await fetch(`https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=${eventId}`);
                const data = await response.json();
                const el = document.getElementById(`situation-${index}`);
                if (!el) return;

                const situation = data.situation;
                const header = data.header;
                const drives = data.drives;

                if (!situation) {
                    el.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:0.8rem;">Waiting for play data...</div>';
                    return;
                }

                let possTeam = '', possTeamName = '', possTeamLogo = '';
                let awayAbbr = 'AWAY', homeAbbr = 'HOME';
                let awayTeamName = '', homeTeamName = '';
                let awayLogo = '', homeLogo = '';
                if (header?.competitions?.[0]) {
                    const comp = header.competitions[0];
                    const team = comp.competitors.find(c => c.id === situation.possession);
                    if (team) {
                        possTeam = team.team.abbreviation;
                        possTeamName = team.team.displayName;
                        possTeamLogo = team.team.logos?.[0]?.href || '';
                    }
                    const awayTeam = comp.competitors.find(c => c.homeAway === 'away');
                    const homeTeam = comp.competitors.find(c => c.homeAway === 'home');
                    awayAbbr = awayTeam?.team.abbreviation || 'AWAY';
                    homeAbbr = homeTeam?.team.abbreviation || 'HOME';
                    awayTeamName = awayTeam?.team.displayName || '';
                    homeTeamName = homeTeam?.team.displayName || '';
                    awayLogo = awayTeam?.team.logos?.[0]?.href || '';
                    homeLogo = homeTeam?.team.logos?.[0]?.href || '';
                }

                // Get team colors for field graphic
                const homeColors = teamColors[homeTeamName] || { primary: '#333' };
                const awayColors = teamColors[awayTeamName] || { primary: '#333' };

                // FEATURE 5: Enhanced Red Zone Alert - Add class to game card
                const gameCard = document.querySelector(`[data-event-id="${eventId}"]`);
                if (gameCard) {
                    if (situation.isRedZone) {
                        gameCard.classList.add('red-zone-active');
                    } else {
                        gameCard.classList.remove('red-zone-active');
                    }
                }

                let html = '';

                // FEATURE 5: Red Zone Banner (if in red zone)
                if (situation.isRedZone) {
                    html += `
                        <div class="red-zone-banner">
                            <span class="red-zone-banner-icon"></span>
                            RED ZONE - ${possTeam} inside the 20!
                        </div>
                    `;
                }

                html += `
                    <div class="situation-row">
                        <div class="possession-info"> ${possTeam}</div>
                        ${situation.isRedZone ? '<span class="red-zone-badge">Red Zone</span>' : ''}
                    </div>
                `;

                if (situation.down && situation.distance) {
                    html += `<div class="down-distance">${situation.down}${getOrdinal(situation.down)} & ${situation.distance}</div>`;
                }

                if (situation.possessionText) {
                    html += `<div class="field-position">${situation.possessionText}</div>`;
                }

                // Add field position graphic
                if (situation.yardLine !== undefined) {
                    // Calculate ball position (0-100 where 0=away endzone, 100=home endzone)
                    // yardLine is the yard line number (1-50)
                    // We need homeTeamId to know which side of the field
                    let ballPosition = 50; // Default to midfield

                    if (situation.yardLine) {
                        // If possession team is going towards home endzone, high yardLine means closer to home endzone
                        const isPossessionHome = header?.competitions?.[0]?.competitors?.find(c => c.id === situation.possession)?.homeAway === 'home';

                        if (situation.yardLine <= 50) {
                            // On their own side or past midfield
                            if (isPossessionHome) {
                                // Home team on their own side: yardLine from home endzone
                                ballPosition = 100 - (situation.yardLine * 0.82); // Scale to 9%-91% range
                            } else {
                                // Away team on their own side
                                ballPosition = (situation.yardLine * 0.82) + 9;
                            }
                        } else {
                            ballPosition = 50; // Midfield
                        }
                    }

                    // Calculate first down marker position
                    let firstDownPosition = ballPosition;
                    if (situation.distance && situation.yardLine) {
                        const distancePercent = (situation.distance / 100) * 82;
                        const isPossessionHome = header?.competitions?.[0]?.competitors?.find(c => c.id === situation.possession)?.homeAway === 'home';
                        firstDownPosition = isPossessionHome ? ballPosition - distancePercent : ballPosition + distancePercent;
                    }

                    // Generate yard line dividers
                    let yardLines = '';
                    for (let i = 0; i <= 10; i++) {
                        const isMajor = i === 0 || i === 5 || i === 10;
                        yardLines += `<div class="yard-line${isMajor ? ' major' : ''}"></div>`;
                    }

                    html += `
                        <div class="field-graphic" style="--away-endzone: ${awayColors.primary}; --home-endzone: ${homeColors.primary};">
                            <span class="endzone-label away">${awayAbbr}</span>
                            <span class="endzone-label home">${homeAbbr}</span>
                            <div class="field-lines">${yardLines}</div>
                            <span class="field-50">50</span>
                            ${situation.distance ? `<div class="first-down-marker" style="left: ${Math.max(9, Math.min(91, firstDownPosition))}%;"></div>` : ''}
                            <div class="ball-marker" style="left: ${Math.max(9, Math.min(91, ballPosition))}%;"></div>
                        </div>
                    `;
                }

                if (situation.lastPlay?.text) {
                    html += `
                        <div class="last-play">
                            <div class="last-play-label">Last Play</div>
                            <div class="last-play-text">${situation.lastPlay.text}</div>
                        </div>
                    `;
                }

                // FEATURE 4: Enhanced Drive Tracker
                if (drives?.current) {
                    const currentDrive = drives.current;
                    const driveTeamLogo = possTeamLogo;
                    const plays = currentDrive.plays?.length || 0;
                    const yards = currentDrive.yards || 0;
                    const startText = currentDrive.start?.text || '';
                    const timeOfPoss = currentDrive.timeOfPossession || '';

                    html += `
                        <div class="drive-tracker">
                            <div class="drive-header">
                                <span class="drive-title">Current Drive</span>
                                <div class="drive-stats">
                                    <div class="drive-stat">
                                        <span class="drive-stat-value">${plays}</span>
                                        <span class="drive-stat-label">Plays</span>
                                    </div>
                                    <div class="drive-stat">
                                        <span class="drive-stat-value">${yards}</span>
                                        <span class="drive-stat-label">Yards</span>
                                    </div>
                                    ${timeOfPoss ? `
                                    <div class="drive-stat">
                                        <span class="drive-stat-value">${timeOfPoss}</span>
                                        <span class="drive-stat-label">Time</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="drive-info">
                                <img src="${driveTeamLogo}" class="drive-team-logo" alt="">
                                <span>Started at ${startText}</span>
                            </div>
                        </div>
                    `;
                }

                // FEATURE 3: Enhanced Win Probability Display
                if (data.winprobability?.length > 0) {
                    const latest = data.winprobability[data.winprobability.length - 1];
                    const homeProb = Math.round(latest.homeWinPercentage * 100);
                    const awayProb = 100 - homeProb;

                    html += `
                        <div class="win-prob-container" style="--away-color: ${awayColors.primary}; --home-color: ${homeColors.primary};">
                            <div class="win-prob-title">Win Probability</div>
                            <div class="win-prob-bar-enhanced">
                                <div class="win-prob-away-fill" style="width:${awayProb}%">
                                    ${awayProb >= 15 ? `<span class="win-prob-percent">${awayProb}%</span>` : ''}
                                </div>
                                <div class="win-prob-home-fill" style="width:${homeProb}%">
                                    ${homeProb >= 15 ? `<span class="win-prob-percent">${homeProb}%</span>` : ''}
                                </div>
                            </div>
                            <div class="win-prob-team-labels">
                                <span><img src="${awayLogo}" alt="">${awayAbbr}</span>
                                <span>${homeAbbr}<img src="${homeLogo}" alt=""></span>
                            </div>
                        </div>
                    `;
                }

                el.innerHTML = html;
            } catch (e) {
                console.error('Live details error:', e);
            }
        }

        function getOrdinal(n) {
            const s = ['th', 'st', 'nd', 'rd'];
            const v = n % 100;
            return s[(v - 20) % 10] || s[v] || s[0];
        }

        // Toggle functions
        function toggleStats(index) {
            const content = document.getElementById(`stats-${index}`);
            const btn = content.previousElementSibling;
            content.classList.toggle('show');
            btn.classList.toggle('expanded');
        }

        // Scoring plays cache
        const scoringPlaysCache = {};

        async function toggleScoringPlays(index, eventId) {
            const content = document.getElementById(`scoring-${index}`);
            const btn = content.previousElementSibling;

            if (content.classList.contains('show')) {
                content.classList.remove('show');
                btn.classList.remove('expanded');
                return;
            }

            btn.querySelector('span:first-child').textContent = ' Loading...';

            try {
                let data = scoringPlaysCache[eventId];
                if (!data) {
                    const response = await fetch(`https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=${eventId}`);
                    data = await response.json();
                    scoringPlaysCache[eventId] = data;
                }

                const scoringPlays = data.scoringPlays || [];
                const header = data.header;

                if (scoringPlays.length === 0) {
                    content.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:15px;">No scoring plays yet</div>';
                } else {
                    // Get team info
                    const teams = {};
                    if (header?.competitions?.[0]) {
                        header.competitions[0].competitors.forEach(c => {
                            teams[c.id] = {
                                abbr: c.team.abbreviation,
                                name: c.team.displayName,
                                logo: c.team.logos?.[0]?.href || '',
                                color: teamColors[c.team.displayName]?.primary || '#666'
                            };
                        });
                    }

                    const playsHtml = scoringPlays.map(play => {
                        const team = teams[play.team?.id] || { abbr: '?', logo: '', color: '#666' };
                        const quarter = play.period?.number <= 4 ? `Q${play.period.number}` : 'OT';

                        return `
                            <div class="scoring-play" style="--team-color: ${team.color}">
                                <span class="scoring-quarter">${quarter}</span>
                                <img src="${team.logo}" class="scoring-team-logo" alt="${team.abbr}">
                                <div class="scoring-info">
                                    <div class="scoring-type">${play.type?.text || play.scoringType?.displayName || 'Score'}</div>
                                    <div class="scoring-desc">${play.text || ''}</div>
                                </div>
                                <div style="text-align:right;">
                                    <div class="scoring-score">${play.awayScore}-${play.homeScore}</div>
                                    <div class="scoring-time">${play.clock?.displayValue || ''}</div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    content.innerHTML = `<div class="scoring-timeline">${playsHtml}</div>`;
                }

                content.classList.add('show');
                btn.classList.add('expanded');
            } catch (e) {
                console.error('Scoring plays error:', e);
                content.innerHTML = '<div style="text-align:center;color:var(--accent-danger);padding:15px;">Failed to load scoring plays</div>';
                content.classList.add('show');
                btn.classList.add('expanded');
            }

            btn.querySelector('span:first-child').textContent = ' Scoring Plays';
        }

        // Team comparison stats
        const teamStatsCache = {};

        async function toggleTeamComparison(index, awayId, homeId, awayName, homeName, awayLogo, homeLogo) {
            const content = document.getElementById(`comparison-${index}`);
            const btn = content.previousElementSibling;

            if (content.classList.contains('show')) {
                content.classList.remove('show');
                btn.classList.remove('expanded');
                return;
            }

            btn.querySelector('span:first-child').textContent = ' Loading...';

            try {
                // Fetch stats for both teams
                const fetchTeamStats = async (teamId) => {
                    if (teamStatsCache[teamId]) return teamStatsCache[teamId];
                    const response = await fetch(`https://site.api.espn.com/apis/site/v2/sports/football/nfl/teams/${teamId}/statistics`);
                    const data = await response.json();
                    teamStatsCache[teamId] = data;
                    return data;
                };

                const [awayStats, homeStats] = await Promise.all([
                    fetchTeamStats(awayId),
                    fetchTeamStats(homeId)
                ]);

                const getStat = (data, category, name) => {
                    const cats = data.results?.stats?.categories || [];
                    const cat = cats.find(c => c.name === category);
                    const stat = cat?.stats?.find(s => s.name === name);
                    return stat ? parseFloat(stat.value) : 0;
                };

                const awayColor = teamColors[awayName]?.primary || '#666';
                const homeColor = teamColors[homeName]?.primary || '#666';

                // Get takeaways (interceptions + fumbles recovered)
                const awayTakeaways = getStat(awayStats, 'defensiveInterceptions', 'interceptions') + getStat(awayStats, 'general', 'fumblesRecovered');
                const homeTakeaways = getStat(homeStats, 'defensiveInterceptions', 'interceptions') + getStat(homeStats, 'general', 'fumblesRecovered');

                // Get turnovers (interceptions thrown + fumbles lost)
                const awayTurnovers = getStat(awayStats, 'passing', 'interceptions') + getStat(awayStats, 'general', 'fumblesLost') || getStat(awayStats, 'rushing', 'rushingFumblesLost');
                const homeTurnovers = getStat(homeStats, 'passing', 'interceptions') + getStat(homeStats, 'general', 'fumblesLost') || getStat(homeStats, 'rushing', 'rushingFumblesLost');

                const stats = [
                    { label: 'Points/Game', away: getStat(awayStats, 'scoring', 'totalPointsPerGame'), home: getStat(homeStats, 'scoring', 'totalPointsPerGame'), higherBetter: true, format: 1 },
                    { label: 'Pass Yds/Game', away: getStat(awayStats, 'passing', 'netPassingYardsPerGame'), home: getStat(homeStats, 'passing', 'netPassingYardsPerGame'), higherBetter: true, format: 1 },
                    { label: 'Rush Yds/Game', away: getStat(awayStats, 'rushing', 'rushingYardsPerGame'), home: getStat(homeStats, 'rushing', 'rushingYardsPerGame'), higherBetter: true, format: 1 },
                    { label: '3rd Down %', away: getStat(awayStats, 'miscellaneous', 'thirdDownConvPct'), home: getStat(homeStats, 'miscellaneous', 'thirdDownConvPct'), higherBetter: true, format: 1, suffix: '%' },
                    { label: 'Red Zone %', away: getStat(awayStats, 'miscellaneous', 'redzoneScoringPct'), home: getStat(homeStats, 'miscellaneous', 'redzoneScoringPct'), higherBetter: true, format: 1, suffix: '%' },
                    { label: 'Sacks (Def)', away: getStat(awayStats, 'defensive', 'sacks'), home: getStat(homeStats, 'defensive', 'sacks'), higherBetter: true, format: 0 },
                    { label: 'Takeaways', away: awayTakeaways, home: homeTakeaways, higherBetter: true, format: 0 },
                    { label: 'Turnovers', away: awayTurnovers, home: homeTurnovers, higherBetter: false, format: 0 },
                ];

                const statsHtml = stats.map(stat => {
                    // Calculate percentage relative to max within this stat
                    const maxVal = Math.max(stat.away, stat.home) || 1;
                    const awayPct = (stat.away / maxVal) * 100;
                    const homePct = (stat.home / maxVal) * 100;
                    const awayBetter = stat.higherBetter ? stat.away > stat.home : stat.away < stat.home;
                    const homeBetter = !awayBetter && stat.away !== stat.home;
                    const suffix = stat.suffix || '';

                    return `
                        <div class="stat-comparison">
                            <div class="stat-label">${stat.label}</div>
                            <div class="stat-bars" style="--away-color: ${awayColor}; --home-color: ${homeColor};">
                                <span class="stat-value away ${awayBetter ? 'better' : ''}">${stat.away.toFixed(stat.format)}${suffix}</span>
                                <div class="stat-bar-container left">
                                    <div class="stat-bar away" style="width: ${awayPct}%;"></div>
                                </div>
                                <div class="stat-bar-container">
                                    <div class="stat-bar home" style="width: ${homePct}%;"></div>
                                </div>
                                <span class="stat-value home ${homeBetter ? 'better' : ''}">${stat.home.toFixed(stat.format)}${suffix}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                content.innerHTML = `
                    <div class="team-comparison" style="--away-color: ${awayColor}; --home-color: ${homeColor};">
                        <div class="comparison-header">
                            <div class="comparison-team">
                                <img src="${awayLogo}" alt="">
                                <span>${awayName.split(' ').pop()}</span>
                            </div>
                            <span class="comparison-vs">VS</span>
                            <div class="comparison-team">
                                <span>${homeName.split(' ').pop()}</span>
                                <img src="${homeLogo}" alt="">
                            </div>
                        </div>
                        ${statsHtml}
                    </div>
                `;

                content.classList.add('show');
                btn.classList.add('expanded');
            } catch (e) {
                console.error('Team comparison error:', e);
                content.innerHTML = '<div style="text-align:center;color:var(--accent-danger);padding:15px;">Failed to load team stats</div>';
                content.classList.add('show');
                btn.classList.add('expanded');
            }

            btn.querySelector('span:first-child').textContent = ' Team Comparison';
        }

        // Share functionality
        async function shareGame(awayName, homeName, awayScore, homeScore, status) {
            const scoreText = awayScore && homeScore ? `${awayScore} - ${homeScore}` : 'vs';
            const statusText = status || 'Upcoming';
            const shareText = `${awayName} ${scoreText} ${homeName} | ${statusText}`;
            const shareUrl = window.location.href;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'NFL Score',
                        text: shareText,
                        url: shareUrl
                    });
                } catch (e) {
                    if (e.name !== 'AbortError') {
                        fallbackShare(shareText);
                    }
                }
            } else {
                fallbackShare(shareText);
            }
        }

        function fallbackShare(text) {
            // Try to copy to clipboard
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showShareToast('Copied to clipboard!');
                }).catch(() => {
                    openTwitterShare(text);
                });
            } else {
                openTwitterShare(text);
            }
        }

        function openTwitterShare(text) {
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
            window.open(twitterUrl, '_blank', 'width=550,height=420');
        }

        function showShareToast(message) {
            const toast = document.getElementById('share-toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // Head to head history
        const h2hCache = {};

        async function toggleH2H(index, awayId, homeId, awayName, homeName, awayLogo, homeLogo) {
            const content = document.getElementById(`h2h-${index}`);
            const btn = content.previousElementSibling;

            if (content.classList.contains('show')) {
                content.classList.remove('show');
                btn.classList.remove('expanded');
                return;
            }

            btn.querySelector('span:first-child').textContent = ' Loading...';

            try {
                const cacheKey = `${awayId}-${homeId}`;
                let matchups = h2hCache[cacheKey];

                if (!matchups) {
                    // Fetch recent schedule for away team and filter for matchups against home team
                    // IDs from the API are strings, so convert to strings for comparison
                    const awayIdStr = String(awayId);
                    const homeIdStr = String(homeId);

                    const now = new Date();
                    // NFL season year: Sept-Dec = current year, Jan-Feb = previous year
                    const month = now.getMonth(); // 0-indexed
                    const nflSeason = month >= 8 ? now.getFullYear() : now.getFullYear() - 1;

                    const parseScore = (scoreVal) => {
                        if (typeof scoreVal === 'object' && scoreVal?.value !== undefined) {
                            return parseInt(scoreVal.value) || 0;
                        }
                        return parseInt(scoreVal) || 0;
                    };

                    const processEvents = (events) => {
                        const results = [];
                        if (!events) return results;

                        events.forEach(event => {
                            const comp = event.competitions?.[0];
                            const eventDate = new Date(event.date);
                            // Check if game is in the past (completed)
                            if (!comp || eventDate > now) return;

                            // Check if both teams are in this game
                            const hasTeamA = comp.competitors?.some(c => String(c.team?.id) === awayIdStr);
                            const hasTeamB = comp.competitors?.some(c => String(c.team?.id) === homeIdStr);

                            if (hasTeamA && hasTeamB) {
                                // Get actual home and away teams from THIS game
                                const actualAway = comp.competitors.find(c => c.homeAway === 'away');
                                const actualHome = comp.competitors.find(c => c.homeAway === 'home');

                                const awayScore = parseScore(actualAway?.score);
                                const homeScore = parseScore(actualHome?.score);

                                // Only include if game has scores (completed)
                                if (awayScore > 0 || homeScore > 0) {
                                    // Track which of our two teams (A or B) won
                                    const teamAWon = String(actualAway?.team?.id) === awayIdStr
                                        ? awayScore > homeScore
                                        : homeScore > awayScore;

                                    results.push({
                                        date: eventDate,
                                        // Store actual game data
                                        actualAwayName: actualAway?.team?.shortDisplayName || actualAway?.team?.displayName,
                                        actualHomeName: actualHome?.team?.shortDisplayName || actualHome?.team?.displayName,
                                        actualAwayScore: awayScore,
                                        actualHomeScore: homeScore,
                                        awayWon: awayScore > homeScore,
                                        // Track which of our two teams won (for summary)
                                        teamAWon: teamAWon
                                    });
                                }
                            }
                        });
                        return results;
                    };

                    // Fetch regular season only (seasontype=2) for current season only (2025-26)
                    const response = await fetch(`https://site.api.espn.com/apis/site/v2/sports/football/nfl/teams/${awayId}/schedule?season=${nflSeason}&seasontype=2`);
                    const data = await response.json();

                    matchups = processEvents(data.events);

                    matchups.sort((a, b) => b.date - a.date);
                    matchups = matchups.slice(0, 5);
                    h2hCache[cacheKey] = matchups;
                }

                const awayColor = teamColors[awayName]?.primary || '#666';
                const homeColor = teamColors[homeName]?.primary || '#666';

                // Calculate season label
                const now = new Date();
                const month = now.getMonth();
                const seasonYear = month >= 8 ? now.getFullYear() : now.getFullYear() - 1;
                const seasonLabel = `${seasonYear}-${String(seasonYear + 1).slice(-2)} Season`;

                if (matchups.length === 0) {
                    content.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:15px;">No matchups this season yet</div>';
                } else {
                    // Count wins for each team (teamA = awayId team, teamB = homeId team)
                    const teamAWins = matchups.filter(m => m.teamAWon).length;
                    const teamBWins = matchups.length - teamAWins;

                    const gamesHtml = matchups.map(m => {
                        const dateStr = m.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                        const winnerColor = m.awayWon ? '#4CAF50' : '#4CAF50'; // Green for winner

                        return `
                            <div class="h2h-game">
                                <span class="h2h-date">${dateStr}</span>
                                <span class="h2h-matchup">
                                    <span class="${m.awayWon ? 'h2h-winner' : 'h2h-loser'}">${m.actualAwayName}</span>
                                    <span style="color:var(--text-muted);"> @ </span>
                                    <span class="${!m.awayWon ? 'h2h-winner' : 'h2h-loser'}">${m.actualHomeName}</span>
                                </span>
                                <span class="h2h-score">${m.actualAwayScore} - ${m.actualHomeScore}</span>
                            </div>
                        `;
                    }).join('');

                    content.innerHTML = `
                        <div class="h2h-container">
                            <div class="h2h-summary">
                                <div class="h2h-team-record">
                                    <img src="${awayLogo}" alt="">
                                    <div class="h2h-wins" style="color: ${awayColor}">${teamAWins}</div>
                                    <div class="h2h-label">Wins</div>
                                </div>
                                <span class="h2h-vs">Last ${matchups.length} Games</span>
                                <div class="h2h-team-record">
                                    <img src="${homeLogo}" alt="">
                                    <div class="h2h-wins" style="color: ${homeColor}">${teamBWins}</div>
                                    <div class="h2h-label">Wins</div>
                                </div>
                            </div>
                            ${gamesHtml}
                        </div>
                    `;
                }

                content.classList.add('show');
                btn.classList.add('expanded');
            } catch (e) {
                console.error('H2H error:', e);
                content.innerHTML = '<div style="text-align:center;color:var(--accent-danger);padding:15px;">Failed to load history</div>';
                content.classList.add('show');
                btn.classList.add('expanded');
            }

            btn.querySelector('span:first-child').textContent = ' Head to Head';
        }

        // Player spotlight
        const playerCache = {};

        async function showPlayerSpotlight(playerId, teamName) {
            const modal = document.getElementById('player-modal');
            const content = document.getElementById('player-modal-content');

            modal.classList.add('show');
            content.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">Loading player stats...</div>';

            try {
                let data = playerCache[playerId];
                if (!data) {
                    const response = await fetch(`https://site.api.espn.com/apis/common/v3/sports/football/nfl/athletes/${playerId}`);
                    data = await response.json();
                    playerCache[playerId] = data;
                }

                const athlete = data.athlete;
                const teamColor = teamColors[teamName]?.primary || '#333';

                // Get stats - they're directly in statsSummary.statistics array
                const seasonStats = athlete.statsSummary?.statistics || [];
                const getStat = (name) => seasonStats.find(s => s.name === name);

                // Build stats display based on position
                const position = athlete.position?.abbreviation || '';
                let statsHtml = '';

                if (['QB'].includes(position)) {
                    const passYds = getStat('passingYards')?.displayValue || '0';
                    const passTD = getStat('passingTouchdowns')?.displayValue || '0';
                    const passInt = getStat('interceptions')?.displayValue || '0';
                    const qbr = getStat('adjQBR')?.displayValue || getStat('QBRating')?.displayValue || '0';

                    statsHtml = `
                        <div class="player-stat-box"><div class="player-stat-value">${passYds}</div><div class="player-stat-label">Pass Yds</div></div>
                        <div class="player-stat-box"><div class="player-stat-value">${passTD}</div><div class="player-stat-label">Pass TD</div></div>
                        <div class="player-stat-box"><div class="player-stat-value">${passInt}</div><div class="player-stat-label">INT</div></div>
                        <div class="player-stat-box"><div class="player-stat-value">${qbr}</div><div class="player-stat-label">QBR</div></div>
                    `;
                } else if (['RB', 'FB'].includes(position)) {
                    const rushYds = getStat('rushingYards')?.displayValue || '0';
                    const rushTD = getStat('rushingTouchdowns')?.displayValue || '0';
                    const ypc = getStat('yardsPerRushAttempt')?.displayValue || '0';
                    const recYds = getStat('receivingYards')?.displayValue || '0';

                    statsHtml = `
                        <div class="player-stat-box"><div class="player-stat-value">${rushYds}</div><div class="player-stat-label">Rush Yds</div></div>
                        <div class="player-stat-box"><div class="player-stat-value">${rushTD}</div><div class="player-stat-label">Rush TD</div></div>
                        <div class="player-stat-box"><div class="player-stat-value">${ypc}</div><div class="player-stat-label">YPC</div></div>
                        <div class="player-stat-box"><div class="player-stat-value">${recYds}</div><div class="player-stat-label">Rec Yds</div></div>
                    `;
                } else if (['WR', 'TE'].includes(position)) {
                    const recYds = getStat('receivingYards')?.displayValue || '0';
                    const recTD = getStat('receivingTouchdowns')?.displayValue || '0';
                    const receptions = getStat('receptions')?.displayValue || '0';
                    const ypr = getStat('yardsPerReception')?.displayValue || '0';

                    statsHtml = `
                        <div class="player-stat-box"><div class="player-stat-value">${recYds}</div><div class="player-stat-label">Rec Yds</div></div>
                        <div class="player-stat-box"><div class="player-stat-value">${recTD}</div><div class="player-stat-label">Rec TD</div></div>
                        <div class="player-stat-box"><div class="player-stat-value">${receptions}</div><div class="player-stat-label">Rec</div></div>
                        <div class="player-stat-box"><div class="player-stat-value">${ypr}</div><div class="player-stat-label">YPR</div></div>
                    `;
                } else {
                    // Defensive player or show all available stats
                    statsHtml = seasonStats.slice(0, 4).map(stat => `
                        <div class="player-stat-box">
                            <div class="player-stat-value">${stat.displayValue || '0'}</div>
                            <div class="player-stat-label">${stat.shortDisplayName || stat.name}</div>
                        </div>
                    `).join('');

                    if (statsHtml === '') {
                        statsHtml = '<div class="player-stat-box" style="grid-column: span 3;"><div class="player-stat-label">No stats available</div></div>';
                    }
                }

                const headshot = athlete.headshot?.href || '';
                const teamLogo = athlete.team?.logos?.[0]?.href || '';

                content.innerHTML = `
                    <div class="player-header" style="--team-color: ${teamColor}">
                        <img src="${headshot}" class="player-headshot" alt="" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%23333%22/></svg>'">
                        <div class="player-info">
                            <h3>${athlete.displayName}</h3>
                            <div class="player-meta">#${athlete.jersey || '?'}  ${position}  ${athlete.displayHeight || ''} ${athlete.displayWeight || ''}</div>
                            <div class="player-team-badge">
                                <img src="${teamLogo}" alt="">
                                <span>${athlete.team?.displayName || teamName}</span>
                            </div>
                        </div>
                    </div>
                    <div class="player-stats-grid">
                        ${statsHtml}
                    </div>
                `;
            } catch (e) {
                console.error('Player spotlight error:', e);
                content.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--accent-danger);">Failed to load player stats</div>';
            }
        }

        function closePlayerModal(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('player-modal').classList.remove('show');
        }

        // Game highlights - YouTube first, ESPN fallback for recently ended games
        async function toggleHighlights(index, eventId, awayTeam, homeTeam, gameDate) {
            const content = document.getElementById(`highlights-${index}`);
            const btn = content.previousElementSibling;

            if (content.classList.contains('show')) {
                content.classList.remove('show');
                btn.classList.remove('expanded');
                return;
            }

            btn.querySelector('span:first-child').textContent = ' Loading...';

            try {
                // Try YouTube first (official NFL highlights)
                const hasYouTube = await loadYouTubeHighlights(content, awayTeam, homeTeam, gameDate, 'highlights');

                // If no YouTube video yet (game just ended), fall back to ESPN
                if (!hasYouTube) {
                    await loadESPNHighlights(content, eventId);
                }
            } catch (e) {
                console.error('Highlights error:', e);
                content.innerHTML = '<div style="text-align:center;color:var(--accent-danger);padding:15px;">Failed to load highlights</div>';
            }

            content.classList.add('show');
            btn.classList.add('expanded');
            btn.querySelector('span:first-child').textContent = ' Highlights';
        }

        // Game preview for upcoming games
        async function togglePreview(index, awayTeam, homeTeam) {
            const content = document.getElementById(`preview-${index}`);
            const btn = content.previousElementSibling;

            if (content.classList.contains('show')) {
                content.classList.remove('show');
                btn.classList.remove('expanded');
                return;
            }

            btn.querySelector('span:first-child').textContent = ' Loading...';

            try {
                const hasPreview = await loadYouTubeHighlights(content, awayTeam, homeTeam, '', 'preview');
                if (!hasPreview) {
                    content.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:15px;">No preview available</div>';
                }
            } catch (e) {
                console.error('Preview error:', e);
                content.innerHTML = '<div style="text-align:center;color:var(--accent-danger);padding:15px;">Failed to load preview</div>';
            }

            content.classList.add('show');
            btn.classList.add('expanded');
            btn.querySelector('span:first-child').textContent = ' Game Preview';
        }

        // YouTube search via secure backend server - returns true if video found
        async function loadYouTubeHighlights(container, awayTeam, homeTeam, gameDate, type) {
            try {
                const url = `/api/youtube/search?awayTeam=${encodeURIComponent(awayTeam)}&homeTeam=${encodeURIComponent(homeTeam)}&gameDate=${encodeURIComponent(gameDate || '')}&type=${encodeURIComponent(type || 'highlights')}`;
                const response = await fetch(url);

                if (!response.ok) {
                    return false;
                }

                const data = await response.json();
                const videos = data.items || [];

                if (videos.length === 0) {
                    return false;
                }

                // Show single video
                const video = videos[0];
                const label = type === 'preview' ? 'NFL  Game Preview' : 'NFL  Watch on YouTube';
                container.innerHTML = `
                    <a href="https://www.youtube.com/watch?v=${video.id.videoId}" target="_blank" class="yt-single-video">
                        <div class="yt-single-thumb">
                            <img src="${video.snippet.thumbnails.high.url}" alt="">
                            <div class="yt-play-icon-lg"></div>
                        </div>
                        <div class="yt-single-info">
                            <div class="yt-single-title">${video.snippet.title}</div>
                            <div class="yt-single-channel">${label}</div>
                        </div>
                    </a>
                `;
                return true;
            } catch (e) {
                console.error('YouTube error:', e);
                return false;
            }
        }

        // ESPN highlights fallback for recently ended games
        async function loadESPNHighlights(container, eventId) {
            try {
                let data = scoringPlaysCache[eventId];
                if (!data) {
                    const response = await fetch(`https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=${eventId}`);
                    data = await response.json();
                    scoringPlaysCache[eventId] = data;
                }

                const videos = data.videos || [];

                if (videos.length === 0) {
                    container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:15px;">Highlights not yet available</div>';
                    return;
                }

                const formatDuration = (seconds) => {
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                };

                const highlightsHtml = videos.slice(0, 6).map(video => {
                    const thumbnail = video.thumbnail || video.posterImages?.default?.href || '';
                    const title = video.headline || video.title || 'Highlight';
                    const duration = video.duration || 0;
                    const link = video.links?.web?.href || video.links?.mobile?.href || '#';

                    return `
                        <a href="${link}" target="_blank" class="highlight-card">
                            <img src="${thumbnail}" class="highlight-thumbnail" alt="" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 160 90%22><rect fill=%22%23333%22 width=%22160%22 height=%2290%22/><text x=%2280%22 y=%2250%22 fill=%22%23666%22 text-anchor=%22middle%22>No Preview</text></svg>'">
                            <div class="highlight-play-btn"></div>
                            ${duration ? `<span class="highlight-duration">${formatDuration(duration)}</span>` : ''}
                            <div class="highlight-title">${title}</div>
                        </a>
                    `;
                }).join('');

                container.innerHTML = `<div class="highlights-grid">${highlightsHtml}</div>`;
            } catch (e) {
                console.error('ESPN highlights error:', e);
                container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:15px;">Highlights not yet available</div>';
            }
        }

        // Box Score - Full player stats
        const boxScoreCache = {};

        // Stat category configurations with compact and detailed stats
        const statCategories = {
            passing: {
                name: 'Passing',
                compactStats: ['C/ATT', 'YDS', 'TD'],
                detailStats: ['C/ATT', 'YDS', 'TD', 'INT', 'QBR', 'SACKS', 'RTG'],
                parseCompact: (stats, keys) => {
                    // ESPN uses combined key 'completions/passingAttempts'
                    const cmpAtt = stats[keys.indexOf('completions/passingAttempts')] || '0/0';
                    return [
                        { value: cmpAtt, label: 'C/ATT' },
                        { value: stats[keys.indexOf('passingYards')] || '0', label: 'YDS' },
                        { value: stats[keys.indexOf('passingTouchdowns')] || '0', label: 'TD' }
                    ];
                },
                parseDetail: (stats, keys) => {
                    const cmpAtt = stats[keys.indexOf('completions/passingAttempts')] || '0/0';
                    const sacks = stats[keys.indexOf('sacks-sackYardsLost')] || '0';
                    const sacksNum = sacks.split('-')[0] || '0';
                    return [
                        { value: cmpAtt, label: 'C/ATT' },
                        { value: stats[keys.indexOf('passingYards')] || '0', label: 'YDS' },
                        { value: stats[keys.indexOf('passingTouchdowns')] || '0', label: 'TD' },
                        { value: stats[keys.indexOf('interceptions')] || '0', label: 'INT' },
                        { value: stats[keys.indexOf('adjQBR')] || stats[keys.indexOf('QBRating')] || '-', label: 'QBR' },
                        { value: sacksNum, label: 'SACKS' },
                        { value: stats[keys.indexOf('QBRating')] || '-', label: 'RTG' }
                    ];
                }
            },
            rushing: {
                name: 'Rushing',
                compactStats: ['CAR', 'YDS', 'TD'],
                detailStats: ['CAR', 'YDS', 'TD', 'AVG', 'LONG'],
                parseCompact: (stats, keys) => [
                    { value: stats[keys.indexOf('rushingAttempts')] || '0', label: 'CAR' },
                    { value: stats[keys.indexOf('rushingYards')] || '0', label: 'YDS' },
                    { value: stats[keys.indexOf('rushingTouchdowns')] || '0', label: 'TD' }
                ],
                parseDetail: (stats, keys) => [
                    { value: stats[keys.indexOf('rushingAttempts')] || '0', label: 'CAR' },
                    { value: stats[keys.indexOf('rushingYards')] || '0', label: 'YDS' },
                    { value: stats[keys.indexOf('rushingTouchdowns')] || '0', label: 'TD' },
                    { value: stats[keys.indexOf('yardsPerRushAttempt')] || '-', label: 'AVG' },
                    { value: stats[keys.indexOf('longRushing')] || '-', label: 'LONG' }
                ]
            },
            fumbles: {
                name: 'Fumbles',
                compactStats: ['FUM', 'LOST', 'REC'],
                detailStats: ['FUM', 'LOST', 'REC'],
                parseCompact: (stats, keys) => [
                    { value: stats[keys.indexOf('fumbles')] || '0', label: 'FUM' },
                    { value: stats[keys.indexOf('fumblesLost')] || '0', label: 'LOST' },
                    { value: stats[keys.indexOf('fumblesRecovered')] || '0', label: 'REC' }
                ],
                parseDetail: (stats, keys) => [
                    { value: stats[keys.indexOf('fumbles')] || '0', label: 'FUM' },
                    { value: stats[keys.indexOf('fumblesLost')] || '0', label: 'LOST' },
                    { value: stats[keys.indexOf('fumblesRecovered')] || '0', label: 'REC' }
                ]
            },
            receiving: {
                name: 'Receiving',
                compactStats: ['REC', 'YDS', 'TD'],
                detailStats: ['REC', 'TGT', 'YDS', 'TD', 'AVG', 'LONG'],
                parseCompact: (stats, keys) => [
                    { value: stats[keys.indexOf('receptions')] || '0', label: 'REC' },
                    { value: stats[keys.indexOf('receivingYards')] || '0', label: 'YDS' },
                    { value: stats[keys.indexOf('receivingTouchdowns')] || '0', label: 'TD' }
                ],
                parseDetail: (stats, keys) => [
                    { value: stats[keys.indexOf('receptions')] || '0', label: 'REC' },
                    { value: stats[keys.indexOf('receivingTargets')] || '-', label: 'TGT' },
                    { value: stats[keys.indexOf('receivingYards')] || '0', label: 'YDS' },
                    { value: stats[keys.indexOf('receivingTouchdowns')] || '0', label: 'TD' },
                    { value: stats[keys.indexOf('yardsPerReception')] || '-', label: 'AVG' },
                    { value: stats[keys.indexOf('longReception')] || '-', label: 'LONG' }
                ]
            },
            defensive: {
                name: 'Defense',
                compactStats: ['TCKL', 'SACK', 'TFL'],
                detailStats: ['TOT', 'SOLO', 'SACK', 'TFL', 'QBH', 'PD', 'TD'],
                parseCompact: (stats, keys) => [
                    { value: stats[keys.indexOf('totalTackles')] || '0', label: 'TCKL' },
                    { value: stats[keys.indexOf('sacks')] || '0', label: 'SACK' },
                    { value: stats[keys.indexOf('tacklesForLoss')] || '0', label: 'TFL' }
                ],
                parseDetail: (stats, keys) => [
                    { value: stats[keys.indexOf('totalTackles')] || '0', label: 'TOT' },
                    { value: stats[keys.indexOf('soloTackles')] || '0', label: 'SOLO' },
                    { value: stats[keys.indexOf('sacks')] || '0', label: 'SACK' },
                    { value: stats[keys.indexOf('tacklesForLoss')] || '0', label: 'TFL' },
                    { value: stats[keys.indexOf('QBHits')] || '0', label: 'QBH' },
                    { value: stats[keys.indexOf('passesDefended')] || '0', label: 'PD' },
                    { value: stats[keys.indexOf('defensiveTouchdowns')] || '0', label: 'TD' }
                ]
            },
            interceptions: {
                name: 'Interceptions',
                compactStats: ['INT', 'YDS', 'TD'],
                detailStats: ['INT', 'YDS', 'TD'],
                parseCompact: (stats, keys) => [
                    { value: stats[keys.indexOf('interceptions')] || '0', label: 'INT' },
                    { value: stats[keys.indexOf('interceptionYards')] || '0', label: 'YDS' },
                    { value: stats[keys.indexOf('interceptionTouchdowns')] || '0', label: 'TD' }
                ],
                parseDetail: (stats, keys) => [
                    { value: stats[keys.indexOf('interceptions')] || '0', label: 'INT' },
                    { value: stats[keys.indexOf('interceptionYards')] || '0', label: 'YDS' },
                    { value: stats[keys.indexOf('interceptionTouchdowns')] || '0', label: 'TD' }
                ]
            },
            kicking: {
                name: 'Kicking',
                compactStats: ['FG', 'XP', 'PTS'],
                detailStats: ['FG', 'FG%', 'XP', 'LONG', 'PTS'],
                parseCompact: (stats, keys) => {
                    // ESPN uses combined keys like 'fieldGoalsMade/fieldGoalAttempts'
                    const fg = stats[keys.indexOf('fieldGoalsMade/fieldGoalAttempts')] || '0/0';
                    const xp = stats[keys.indexOf('extraPointsMade/extraPointAttempts')] || '0/0';
                    const pts = stats[keys.indexOf('totalKickingPoints')] || '0';
                    return [
                        { value: fg, label: 'FG' },
                        { value: xp, label: 'XP' },
                        { value: pts, label: 'PTS' }
                    ];
                },
                parseDetail: (stats, keys) => {
                    const fg = stats[keys.indexOf('fieldGoalsMade/fieldGoalAttempts')] || '0/0';
                    const xp = stats[keys.indexOf('extraPointsMade/extraPointAttempts')] || '0/0';
                    const pct = stats[keys.indexOf('fieldGoalPct')] || '-';
                    const pts = stats[keys.indexOf('totalKickingPoints')] || '0';
                    return [
                        { value: fg, label: 'FG' },
                        { value: pct + '%', label: 'FG%' },
                        { value: xp, label: 'XP' },
                        { value: stats[keys.indexOf('longFieldGoalMade')] || '-', label: 'LONG' },
                        { value: pts, label: 'PTS' }
                    ];
                }
            },
            punting: {
                name: 'Punting',
                compactStats: ['PUNTS', 'AVG', 'IN20'],
                detailStats: ['PUNTS', 'YDS', 'AVG', 'LONG', 'IN20', 'TB'],
                parseCompact: (stats, keys) => [
                    { value: stats[keys.indexOf('punts')] || '0', label: 'PUNTS' },
                    { value: stats[keys.indexOf('grossAvgPuntYards')] || '-', label: 'AVG' },
                    { value: stats[keys.indexOf('puntsInside20')] || '0', label: 'IN20' }
                ],
                parseDetail: (stats, keys) => [
                    { value: stats[keys.indexOf('punts')] || '0', label: 'PUNTS' },
                    { value: stats[keys.indexOf('puntYards')] || '0', label: 'YDS' },
                    { value: stats[keys.indexOf('grossAvgPuntYards')] || '-', label: 'AVG' },
                    { value: stats[keys.indexOf('longPunt')] || '-', label: 'LONG' },
                    { value: stats[keys.indexOf('puntsInside20')] || '0', label: 'IN20' },
                    { value: stats[keys.indexOf('touchbacks')] || '0', label: 'TB' }
                ]
            },
            kickReturns: {
                name: 'Kick Returns',
                compactStats: ['RET', 'YDS', 'AVG'],
                detailStats: ['RET', 'YDS', 'AVG', 'LONG', 'TD'],
                parseCompact: (stats, keys) => [
                    { value: stats[keys.indexOf('kickReturns')] || '0', label: 'RET' },
                    { value: stats[keys.indexOf('kickReturnYards')] || '0', label: 'YDS' },
                    { value: stats[keys.indexOf('yardsPerKickReturn')] || '-', label: 'AVG' }
                ],
                parseDetail: (stats, keys) => [
                    { value: stats[keys.indexOf('kickReturns')] || '0', label: 'RET' },
                    { value: stats[keys.indexOf('kickReturnYards')] || '0', label: 'YDS' },
                    { value: stats[keys.indexOf('yardsPerKickReturn')] || '-', label: 'AVG' },
                    { value: stats[keys.indexOf('longKickReturn')] || '-', label: 'LONG' },
                    { value: stats[keys.indexOf('kickReturnTouchdowns')] || '0', label: 'TD' }
                ]
            },
            puntReturns: {
                name: 'Punt Returns',
                compactStats: ['RET', 'YDS', 'AVG'],
                detailStats: ['RET', 'YDS', 'AVG', 'LONG', 'TD', 'FC'],
                parseCompact: (stats, keys) => [
                    { value: stats[keys.indexOf('puntReturns')] || '0', label: 'RET' },
                    { value: stats[keys.indexOf('puntReturnYards')] || '0', label: 'YDS' },
                    { value: stats[keys.indexOf('yardsPerPuntReturn')] || '-', label: 'AVG' }
                ],
                parseDetail: (stats, keys) => [
                    { value: stats[keys.indexOf('puntReturns')] || '0', label: 'RET' },
                    { value: stats[keys.indexOf('puntReturnYards')] || '0', label: 'YDS' },
                    { value: stats[keys.indexOf('yardsPerPuntReturn')] || '-', label: 'AVG' },
                    { value: stats[keys.indexOf('longPuntReturn')] || '-', label: 'LONG' },
                    { value: stats[keys.indexOf('puntReturnTouchdowns')] || '0', label: 'TD' },
                    { value: stats[keys.indexOf('fairCatches')] || '0', label: 'FC' }
                ]
            }
        };

        async function fetchBoxScore(eventId, index, awayTeam, homeTeam) {
            const container = document.getElementById(`boxscore-${index}`);
            if (!container) return;

            try {
                let data = boxScoreCache[eventId];
                if (!data) {
                    const response = await fetch(`https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=${eventId}`);
                    data = await response.json();
                    boxScoreCache[eventId] = data;
                }

                const boxscore = data.boxscore;
                if (!boxscore?.players || boxscore.players.length === 0) {
                    container.innerHTML = '<div class="boxscore-no-stats">No player stats available</div>';
                    return;
                }

                // Get team colors
                const awayColor = teamColors[awayTeam.team.displayName]?.primary || '#666';
                const homeColor = teamColors[homeTeam.team.displayName]?.primary || '#666';

                // Build HTML for team tabs
                let html = `
                    <div class="boxscore-team-tabs">
                        <button class="boxscore-team-tab active" style="--team-color: ${awayColor}" onclick="switchBoxScoreTeam(${index}, 'away')">
                            <img src="${awayTeam.team.logo}" alt="">
                            <span>${awayTeam.team.abbreviation}</span>
                        </button>
                        <button class="boxscore-team-tab" style="--team-color: ${homeColor}" onclick="switchBoxScoreTeam(${index}, 'home')">
                            <img src="${homeTeam.team.logo}" alt="">
                            <span>${homeTeam.team.abbreviation}</span>
                        </button>
                    </div>
                `;

                // Render box score for each team
                boxscore.players.forEach((teamData, teamIdx) => {
                    const isAway = teamIdx === 0;
                    const team = isAway ? awayTeam : homeTeam;
                    const teamName = team.team.displayName;

                    html += `<div class="boxscore-team-content ${isAway ? 'active' : ''}" id="boxscore-${index}-${isAway ? 'away' : 'home'}">`;

                    // Map category names to our config keys
                    const categoryMapping = {
                        'passing': 'passing',
                        'rushing': 'rushing',
                        'fumbles': 'fumbles',
                        'receiving': 'receiving',
                        'defensive': 'defensive',
                        'interceptions': 'interceptions',
                        'kicking': 'kicking',
                        'punting': 'punting',
                        'kickReturns': 'kickReturns',
                        'puntReturns': 'puntReturns'
                    };

                    // Process each stat category
                    teamData.statistics.forEach(statGroup => {
                        const categoryKey = categoryMapping[statGroup.name];
                        const categoryConfig = statCategories[categoryKey];
                        if (!categoryConfig) return;

                        // Filter out players with no meaningful stats
                        const players = (statGroup.athletes || []).filter(athlete => {
                            if (!athlete.stats || athlete.stats.length === 0) return false;
                            // Check if there are any non-zero stats
                            return athlete.stats.some(s => s !== '0' && s !== '-' && s !== '0.0');
                        });

                        if (players.length === 0) return;

                        const keys = statGroup.keys || [];

                        html += `
                            <div class="boxscore-category expanded" data-category="${categoryKey}">
                                <div class="boxscore-category-header" onclick="toggleBoxScoreCategory(this)">
                                    <span class="boxscore-category-title">${categoryConfig.name}</span>
                                    <span class="boxscore-category-arrow"></span>
                                </div>
                                <div class="boxscore-players">
                        `;

                        players.forEach((athlete, playerIdx) => {
                            const playerId = athlete.athlete?.id || '';
                            const playerName = athlete.athlete?.shortName || athlete.athlete?.displayName || 'Unknown';
                            const position = athlete.athlete?.position?.abbreviation || '';
                            const headshot = athlete.athlete?.headshot || '';
                            const stats = athlete.stats || [];

                            const compactStats = categoryConfig.parseCompact(stats, keys);
                            const detailStats = categoryConfig.parseDetail(stats, keys);

                            const compactHtml = compactStats.map(s => `
                                <div class="boxscore-compact-stat">
                                    <div class="boxscore-compact-stat-value">${s.value}</div>
                                    <div class="boxscore-compact-stat-label">${s.label}</div>
                                </div>
                            `).join('');

                            const detailHtml = detailStats.map(s => `
                                <div class="boxscore-detail-stat">
                                    <div class="boxscore-detail-value">${s.value}</div>
                                    <div class="boxscore-detail-label">${s.label}</div>
                                </div>
                            `).join('');

                            html += `
                                <div class="boxscore-player-row" onclick="toggleBoxScorePlayer(this, event, '${playerId}', '${teamName.replace(/'/g, "\\'")}')">
                                    <div class="boxscore-player-main">
                                        <img src="${headshot}" class="boxscore-player-headshot" alt="" onerror="this.style.display='none'">
                                        <div class="boxscore-player-info">
                                            <div class="boxscore-player-name">${playerName}</div>
                                            <div class="boxscore-player-position">${position}</div>
                                        </div>
                                        <div class="boxscore-player-compact-stats">
                                            ${compactHtml}
                                        </div>
                                        <span class="boxscore-player-expand-icon"></span>
                                    </div>
                                    <div class="boxscore-player-details">
                                        <div class="boxscore-detail-grid">
                                            ${detailHtml}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });

                        html += '</div></div>';
                    });

                    html += '</div>';
                });

                container.innerHTML = html;

            } catch (e) {
                console.error('Box score error:', e);
                container.innerHTML = '<div class="boxscore-no-stats">Failed to load player stats</div>';
            }
        }

        function switchBoxScoreTeam(index, team) {
            const container = document.getElementById(`boxscore-${index}`);
            if (!container) return;

            // Update tab buttons
            container.querySelectorAll('.boxscore-team-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Update content
            container.querySelectorAll('.boxscore-team-content').forEach(content => {
                content.classList.remove('active');
            });
            const targetContent = document.getElementById(`boxscore-${index}-${team}`);
            if (targetContent) {
                targetContent.classList.add('active');
            }
        }

        function toggleBoxScoreCategory(header) {
            const category = header.closest('.boxscore-category');
            category.classList.toggle('expanded');
            const players = category.querySelector('.boxscore-players');
            if (category.classList.contains('expanded')) {
                players.style.display = 'block';
            } else {
                players.style.display = 'none';
            }
        }

        function toggleBoxScorePlayer(row, event, playerId, teamName) {
            // Prevent toggling when clicking on expandable details
            if (event.target.closest('.boxscore-player-details')) return;

            row.classList.toggle('expanded');

            // Double-tap to open player spotlight
            if (row.dataset.lastTap && Date.now() - row.dataset.lastTap < 300 && playerId) {
                showPlayerSpotlight(playerId, teamName);
            }
            row.dataset.lastTap = Date.now();
        }

        // Injuries
        let injuriesCache = null;

        async function toggleInjuries(index, awayId, homeId) {
            const content = document.getElementById(`injuries-${index}`);
            const btn = content.previousElementSibling;

            if (content.classList.contains('show')) {
                content.classList.remove('show');
                btn.classList.remove('expanded');
                return;
            }

            btn.querySelector('span:first-child').textContent = ' Loading...';

            if (!injuriesCache) {
                try {
                    const response = await fetch('https://site.api.espn.com/apis/site/v2/sports/football/nfl/injuries');
                    injuriesCache = await response.json();
                } catch (e) {
                    content.innerHTML = '<div class="no-injuries">Unable to load injuries</div>';
                    content.classList.add('show');
                    btn.classList.add('expanded');
                    btn.querySelector('span:first-child').textContent = ' View Injuries';
                    return;
                }
            }

            const renderTeam = (teamId, name) => {
                const teamData = injuriesCache.injuries?.find(t => t.id === teamId);
                if (!teamData?.injuries?.length) {
                    return `<div class="injuries-team"><div class="injuries-team-name">${name}</div><div class="no-injuries">No reported injuries</div></div>`;
                }

                const significant = teamData.injuries.filter(i => ['Out', 'Doubtful', 'Questionable'].includes(i.status)).slice(0, 5);
                if (!significant.length) {
                    return `<div class="injuries-team"><div class="injuries-team-name">${name}</div><div class="no-injuries">No significant injuries</div></div>`;
                }

                const items = significant.map(i => `
                    <div class="injury-item">
                        <span class="injury-status ${i.status.toLowerCase()}">${i.status}</span>
                        <span class="injury-player">${i.athlete?.shortName || 'Unknown'}</span>
                        <span class="injury-position">${i.athlete?.position?.abbreviation || ''}</span>
                    </div>
                `).join('');

                return `<div class="injuries-team"><div class="injuries-team-name">${name}</div><div class="injury-list">${items}</div></div>`;
            };

            const awayTeam = injuriesCache.injuries?.find(t => t.id === awayId);
            const homeTeam = injuriesCache.injuries?.find(t => t.id === homeId);

            content.innerHTML = renderTeam(awayId, awayTeam?.displayName || 'Away') + renderTeam(homeId, homeTeam?.displayName || 'Home');
            content.classList.add('show');
            btn.classList.add('expanded');
            btn.querySelector('span:first-child').textContent = ' View Injuries';
        }

        // Standings
        let standingsData = null;
        let currentConference = 'AFC';

        async function fetchStandings() {
            const container = document.getElementById('standings-container');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading standings...</div>';

            try {
                const response = await fetch('https://site.api.espn.com/apis/v2/sports/football/nfl/standings');
                standingsData = await response.json();
                renderStandings();
            } catch (e) {
                container.innerHTML = '<div class="error">Error loading standings</div>';
            }
        }

        function renderStandings() {
            if (!standingsData) return;

            const container = document.getElementById('standings-container');
            const conf = standingsData.children.find(c => c.abbreviation === currentConference);

            if (!conf) {
                container.innerHTML = '<div class="error">Conference not found</div>';
                return;
            }

            const divOrder = currentConference === 'AFC'
                ? ['AFC East', 'AFC North', 'AFC South', 'AFC West']
                : ['NFC East', 'NFC North', 'NFC South', 'NFC West'];

            const divisions = {};
            if (conf.children) {
                conf.children.forEach(div => {
                    if (div.standings?.entries) divisions[div.name] = div.standings.entries;
                });
            }

            if (Object.keys(divisions).length === 0 && conf.standings) {
                const entries = [...conf.standings.entries].sort((a, b) => {
                    const seedA = a.stats.find(s => s.name === 'playoffSeed')?.value || 99;
                    const seedB = b.stats.find(s => s.name === 'playoffSeed')?.value || 99;
                    return seedA - seedB;
                });
                container.innerHTML = renderDivision(`${currentConference} Standings`, entries);
                return;
            }

            container.innerHTML = divOrder.map(name => divisions[name] ? renderDivision(name, divisions[name]) : '').join('');
        }

        function renderDivision(name, teams) {
            const sorted = [...teams].sort((a, b) => {
                const pctA = a.stats.find(s => s.name === 'winPercent')?.value || 0;
                const pctB = b.stats.find(s => s.name === 'winPercent')?.value || 0;
                return pctB - pctA;
            });

            const rows = sorted.map((entry, i) => {
                const team = entry.team;
                const stats = entry.stats;
                const getStat = name => stats.find(s => s.name === name);

                const wins = getStat('wins')?.displayValue || '0';
                const losses = getStat('losses')?.displayValue || '0';
                const ties = getStat('ties')?.value || 0;
                const pct = getStat('winPercent')?.displayValue || '.000';
                const diff = getStat('pointDifferential')?.value || 0;
                const clincher = getStat('clincher')?.displayValue || '';
                const streak = getStat('streak')?.displayValue || '-';
                const playoffSeed = getStat('playoffSeed')?.value || 0;

                const record = ties > 0 ? `${wins}-${losses}-${ties}` : `${wins}-${losses}`;

                let dotClass = '';
                let playoffLabel = '';
                // Clincher codes: z = division winner, y = playoff berth, x = playoff berth, e = eliminated
                if (clincher === 'z' && playoffSeed === 1) { dotClass = 'clinched'; playoffLabel = '<span class="playoff-indicator clinched-div">DIV + BYE</span>'; }
                else if (clincher === 'z') { dotClass = 'clinched'; playoffLabel = '<span class="playoff-indicator clinched-div">DIV</span>'; }
                else if (clincher === 'y' || clincher === 'x') { dotClass = 'clinched'; playoffLabel = '<span class="playoff-indicator clinched-playoff">PLAYOFF</span>'; }
                else if (clincher === 'e') { dotClass = 'eliminated'; playoffLabel = '<span class="playoff-indicator eliminated">OUT</span>'; }
                else if (i === 0) { dotClass = 'wildcard'; playoffLabel = '<span class="playoff-indicator in-hunt">LEADER</span>'; }

                const diffClass = diff > 0 ? 'diff-positive' : diff < 0 ? 'diff-negative' : '';

                return `
                    <tr>
                        <td>
                            <div class="standings-team">
                                ${dotClass ? `<span class="playoff-dot ${dotClass}"></span>` : ''}
                                <img src="${team.logos?.[0]?.href || ''}" class="standings-logo">
                                <span class="standings-name">${team.abbreviation}</span>
                                ${playoffLabel}
                            </div>
                        </td>
                        <td>${record}</td>
                        <td>${pct}</td>
                        <td class="${diffClass}">${diff > 0 ? '+' : ''}${diff}</td>
                        <td>${streak}</td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="division-card">
                    <div class="division-name">${name}</div>
                    <table class="standings-table">
                        <thead><tr><th>Team</th><th>W-L</th><th>PCT</th><th>DIFF</th><th>STRK</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        // Refresh
        function setupRefreshInterval() {
            if (refreshInterval) clearInterval(refreshInterval);
            if (!autoRefresh) {
                document.getElementById('refresh-status').textContent = 'Auto-refresh off';
                return;
            }

            const rate = hasLiveGames ? 60000 : 300000;
            document.getElementById('refresh-status').textContent = hasLiveGames ? 'Refreshing every minute' : 'Refreshing every 5 min';
            refreshInterval = setInterval(fetchScores, rate);
        }

        // Navigation
        document.getElementById('prev-day').addEventListener('click', () => {
            navigateToGameDay(-1);
        });

        document.getElementById('next-day').addEventListener('click', () => {
            navigateToGameDay(1);
        });

        // Swipe gestures
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });

        function handleSwipe() {
            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) > 80) {
                navigateToGameDay(diff > 0 ? 1 : -1);
            }
        }

        // Pull to refresh
        let pullStartY = 0;
        let isPulling = false;

        document.addEventListener('touchstart', e => {
            if (window.scrollY === 0) {
                pullStartY = e.touches[0].clientY;
                isPulling = true;
            }
        }, { passive: true });

        document.addEventListener('touchmove', e => {
            if (!isPulling) return;
            const pullDistance = e.touches[0].clientY - pullStartY;
            if (pullDistance > 60 && window.scrollY === 0) {
                document.getElementById('pull-indicator').classList.add('visible');
            }
        }, { passive: true });

        document.addEventListener('touchend', () => {
            if (document.getElementById('pull-indicator').classList.contains('visible')) {
                fetchScores();
                if (currentView === 'standings') fetchStandings();
            }
            document.getElementById('pull-indicator').classList.remove('visible');
            isPulling = false;
        }, { passive: true });

        // Quick buttons
        document.getElementById('refresh-btn').addEventListener('click', () => {
            fetchScores();
            if (currentView === 'standings') fetchStandings();
        });

        document.getElementById('live-only-btn').addEventListener('click', function() {
            showLiveOnly = !showLiveOnly;
            this.classList.toggle('active', showLiveOnly);
            fetchScores();
        });

        document.getElementById('auto-refresh-btn').addEventListener('click', function() {
            autoRefresh = !autoRefresh;
            localStorage.setItem('autoRefresh', autoRefresh);
            this.classList.toggle('active', autoRefresh);
            setupRefreshInterval();
        });

        // Bottom nav - updated to support bracket, stats views
        document.querySelectorAll('.nav-item[data-view]').forEach(item => {
            item.addEventListener('click', function() {
                const view = this.dataset.view;
                currentView = view;

                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                this.classList.add('active');

                document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
                document.getElementById(`${view}-view`).classList.add('active');

                if (view === 'standings' && !standingsData) {
                    fetchStandings();
                }
                // FEATURE 1: Load bracket when switching to bracket view
                if (view === 'bracket' && !bracketData) {
                    fetchPlayoffBracket();
                }
                // Load season stats when switching to stats view
                if (view === 'stats' && !seasonStatsData) {
                    fetchSeasonStats();
                }
            });
        });

        // Conference tabs
        document.querySelectorAll('.conf-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.conf-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentConference = this.dataset.conference;
                renderStandings();
            });
        });

        // Favorite team
        function initFavoriteTeam() {
            const select = document.getElementById('favorite-team');
            select.value = favoriteTeam;
            select.addEventListener('change', e => {
                favoriteTeam = e.target.value;
                if (favoriteTeam) localStorage.setItem('favoriteTeam', favoriteTeam);
                else localStorage.removeItem('favoriteTeam');
                fetchScores();
            });
        }

        // ============================================
        // FEATURE 1: PLAYOFF BRACKET VISUALIZATION
        // ============================================
        let bracketData = null;
        let eliminatedTeams = new Set();

        async function fetchPlayoffBracket() {
            const container = document.getElementById('bracket-container');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading playoff bracket...</div>';

            try {
                // Fetch playoff games from January through early February
                const now = new Date();
                const year = now.getMonth() >= 8 ? now.getFullYear() + 1 : now.getFullYear();
                const startDate = `${year}0101`;
                const endDate = `${year}0215`;

                const url = `https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard?dates=${startDate}-${endDate}&limit=100`;
                const response = await fetch(url);
                const data = await response.json();

                if (!data.events || data.events.length === 0) {
                    container.innerHTML = '<div class="no-games">No playoff games available yet</div>';
                    return;
                }

                bracketData = data;
                renderPlayoffBracket(data.events);
            } catch (e) {
                console.error('Bracket fetch error:', e);
                container.innerHTML = '<div class="error">Error loading playoff bracket</div>';
            }
        }

        function renderPlayoffBracket(events) {
            const container = document.getElementById('bracket-container');

            // Organize games by round and conference
            const playoffs = {
                AFC: { wildCard: [], divisional: [], conference: [], superBowl: null },
                NFC: { wildCard: [], divisional: [], conference: [], superBowl: null }
            };

            // Track eliminated teams
            eliminatedTeams.clear();

            events.forEach(event => {
                const comp = event.competitions[0];
                const notes = comp.notes?.[0]?.headline || event.name || '';
                const status = event.status.type;

                let round = '';
                let conference = '';

                // Determine round from game name/notes
                const lowerNotes = notes.toLowerCase();
                if (lowerNotes.includes('super bowl')) {
                    round = 'superBowl';
                    conference = 'SuperBowl';
                } else if (lowerNotes.includes('wild card') || lowerNotes.includes('wildcard')) {
                    round = 'wildCard';
                } else if (lowerNotes.includes('divisional')) {
                    round = 'divisional';
                } else if (lowerNotes.includes('conference') || lowerNotes.includes('championship')) {
                    round = 'conference';
                } else {
                    // Skip regular season games
                    return;
                }

                // Determine conference from teams
                const home = comp.competitors.find(c => c.homeAway === 'home');
                const away = comp.competitors.find(c => c.homeAway === 'away');

                if (round !== 'superBowl') {
                    // Check team IDs for AFC/NFC (simplified check)
                    const afcTeams = ['Buffalo Bills', 'Miami Dolphins', 'New England Patriots', 'New York Jets',
                                     'Baltimore Ravens', 'Cincinnati Bengals', 'Cleveland Browns', 'Pittsburgh Steelers',
                                     'Houston Texans', 'Indianapolis Colts', 'Jacksonville Jaguars', 'Tennessee Titans',
                                     'Denver Broncos', 'Kansas City Chiefs', 'Las Vegas Raiders', 'Los Angeles Chargers'];

                    const homeTeam = home?.team?.displayName || '';
                    conference = afcTeams.includes(homeTeam) ? 'AFC' : 'NFC';
                }

                // Track eliminated teams (losers of completed games)
                if (status.completed) {
                    const homeScore = parseInt(home?.score) || 0;
                    const awayScore = parseInt(away?.score) || 0;
                    if (homeScore > awayScore) {
                        eliminatedTeams.add(away?.team?.displayName);
                    } else if (awayScore > homeScore) {
                        eliminatedTeams.add(home?.team?.displayName);
                    }
                }

                const gameData = {
                    id: event.id,
                    date: new Date(event.date),
                    status: status,
                    home: home,
                    away: away,
                    notes: notes
                };

                if (round === 'superBowl') {
                    playoffs.AFC.superBowl = gameData;
                    playoffs.NFC.superBowl = gameData;
                } else {
                    playoffs[conference][round].push(gameData);
                }
            });

            // Render bracket HTML
            let html = `
                <div class="playoff-bracket-container">
                    <div class="bracket-header">
                        <h2>NFL Playoffs</h2>
                        <div class="bracket-subtitle">Bracket View</div>
                    </div>
                    <div class="brackets-wrapper">
            `;

            // Render AFC bracket
            html += renderConferenceBracket('AFC', playoffs.AFC);

            // Render NFC bracket
            html += renderConferenceBracket('NFC', playoffs.NFC);

            html += '</div>';

            // Super Bowl section
            if (playoffs.AFC.superBowl) {
                html += renderSuperBowl(playoffs.AFC.superBowl);
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function renderConferenceBracket(conf, data) {
            const confClass = conf.toLowerCase();
            let html = `
                <div class="conference-bracket">
                    <div class="conference-bracket-title ${confClass}">${conf} Bracket</div>
            `;

            // Wild Card Round
            if (data.wildCard.length > 0) {
                html += `<div class="bracket-round">
                    <div class="bracket-round-title">Wild Card</div>`;
                data.wildCard.forEach(game => {
                    html += renderBracketMatchup(game);
                });
                html += '</div>';
            }

            // Divisional Round
            if (data.divisional.length > 0) {
                html += `<div class="bracket-round">
                    <div class="bracket-round-title">Divisional</div>`;
                data.divisional.forEach(game => {
                    html += renderBracketMatchup(game);
                });
                html += '</div>';
            }

            // Conference Championship
            if (data.conference.length > 0) {
                html += `<div class="bracket-round">
                    <div class="bracket-round-title">${conf} Championship</div>`;
                data.conference.forEach(game => {
                    html += renderBracketMatchup(game);
                });
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        function renderBracketMatchup(game) {
            const home = game.home;
            const away = game.away;
            const status = game.status;
            const isCompleted = status.completed;
            const isLive = status.state === 'in';

            const homeScore = parseInt(home?.score) || 0;
            const awayScore = parseInt(away?.score) || 0;
            const homeWins = isCompleted && homeScore > awayScore;
            const awayWins = isCompleted && awayScore > homeScore;

            // Get seeds from record (playoff seed is usually in the API)
            const homeSeed = home?.curatedRank?.current || '';
            const awaySeed = away?.curatedRank?.current || '';

            let statusText = '';
            if (isCompleted) {
                statusText = 'Final';
            } else if (isLive) {
                statusText = status.shortDetail;
            } else {
                statusText = game.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }

            return `
                <div class="bracket-matchup ${isCompleted ? 'completed' : ''}">
                    <div class="bracket-team ${awayWins ? 'winner' : ''} ${homeWins ? 'loser' : ''}">
                        ${awaySeed ? `<span class="bracket-seed">${awaySeed}</span>` : ''}
                        <img src="${away?.team?.logo || ''}" class="bracket-team-logo" alt="">
                        <span class="bracket-team-name">${away?.team?.abbreviation || 'TBD'}</span>
                        <span class="bracket-score">${isCompleted || isLive ? awayScore : ''}</span>
                    </div>
                    <div class="bracket-vs">vs</div>
                    <div class="bracket-team ${homeWins ? 'winner' : ''} ${awayWins ? 'loser' : ''}">
                        ${homeSeed ? `<span class="bracket-seed">${homeSeed}</span>` : ''}
                        <img src="${home?.team?.logo || ''}" class="bracket-team-logo" alt="">
                        <span class="bracket-team-name">${home?.team?.abbreviation || 'TBD'}</span>
                        <span class="bracket-score">${isCompleted || isLive ? homeScore : ''}</span>
                    </div>
                    <div class="bracket-matchup-status">${isLive ? '<span class="live-dot"></span>' : ''} ${statusText}</div>
                </div>
            `;
        }

        function renderSuperBowl(game) {
            if (!game) return '';
            return `
                <div style="margin-top: 20px; text-align: center;">
                    <div style="font-size: 1.2rem; font-weight: 700; color: var(--accent-secondary); margin-bottom: 15px;">Super Bowl</div>
                    ${renderBracketMatchup(game)}
                </div>
            `;
        }

        // ============================================
        // FEATURE 7: SHAREABLE SCORE CARDS
        // ============================================
        function toggleShareMenu(index) {
            const menu = document.getElementById(`share-menu-${index}`);
            if (menu) {
                menu.classList.toggle('show');
                // Close menu when clicking elsewhere
                setTimeout(() => {
                    document.addEventListener('click', function closeMenu(e) {
                        if (!e.target.closest('.share-btn-enhanced') && !e.target.closest('.share-menu')) {
                            menu.classList.remove('show');
                            document.removeEventListener('click', closeMenu);
                        }
                    });
                }, 10);
            }
        }

        async function generateShareImage(awayTeam, homeTeam, awayScore, homeScore, awayLogo, homeLogo, statusText, gameDate) {
            const canvas = document.getElementById('share-canvas');
            const ctx = canvas.getContext('2d');

            // Clear canvas
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Add gradient background
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(1, '#16213e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw header
            ctx.fillStyle = '#feca57';
            ctx.font = 'bold 24px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('NFL SCORES', canvas.width / 2, 40);

            // Draw team names and scores
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 36px -apple-system, sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(awayTeam, 80, 150);
            ctx.fillText(awayScore, 80, 200);

            ctx.textAlign = 'right';
            ctx.fillText(homeTeam, canvas.width - 80, 150);
            ctx.fillText(homeScore, canvas.width - 80, 200);

            // Draw vs
            ctx.textAlign = 'center';
            ctx.fillStyle = '#a0aec0';
            ctx.font = '20px -apple-system, sans-serif';
            ctx.fillText('vs', canvas.width / 2, 175);

            // Draw status
            ctx.fillStyle = '#68d391';
            ctx.font = 'bold 18px -apple-system, sans-serif';
            ctx.fillText(statusText, canvas.width / 2, 280);

            // Draw date
            ctx.fillStyle = '#a0aec0';
            ctx.font = '14px -apple-system, sans-serif';
            ctx.fillText(gameDate, canvas.width / 2, 320);

            // Draw watermark
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.font = '12px -apple-system, sans-serif';
            ctx.fillText('NFL Scores App', canvas.width / 2, canvas.height - 20);

            return canvas.toDataURL('image/png');
        }

        async function shareScoreCard(index, awayTeam, homeTeam, awayScore, homeScore, awayLogo, homeLogo, statusText) {
            const gameDate = formatDate(currentDate);
            const shareText = `${awayTeam} ${awayScore} - ${homeScore} ${homeTeam} | ${statusText}`;

            // Close share menu
            const menu = document.getElementById(`share-menu-${index}`);
            if (menu) menu.classList.remove('show');

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'NFL Score',
                        text: shareText,
                        url: window.location.href
                    });
                } catch (e) {
                    if (e.name !== 'AbortError') {
                        fallbackShare(shareText);
                    }
                }
            } else {
                fallbackShare(shareText);
            }
        }

        async function downloadScoreCard(index, awayTeam, homeTeam, awayScore, homeScore, awayLogo, homeLogo, statusText) {
            const gameDate = formatDate(currentDate);

            // Close share menu
            const menu = document.getElementById(`share-menu-${index}`);
            if (menu) menu.classList.remove('show');

            try {
                const imageData = await generateShareImage(awayTeam, homeTeam, awayScore, homeScore, awayLogo, homeLogo, statusText, gameDate);

                // Create download link
                const link = document.createElement('a');
                link.download = `${awayTeam.replace(/\s+/g, '-')}-vs-${homeTeam.replace(/\s+/g, '-')}.png`;
                link.href = imageData;
                link.click();

                showShareToast('Image downloaded!');
            } catch (e) {
                console.error('Download error:', e);
                showShareToast('Failed to generate image');
            }
        }

        // ============================================
        // FEATURE 8: PLAYER COMPARISON TOOL
        // ============================================
        let comparisonPlayers = [];
        let comparisonMode = false;

        function startPlayerComparison(boxscoreIndex) {
            comparisonPlayers = [];
            comparisonMode = true;

            const container = document.getElementById(`boxscore-${boxscoreIndex}`);
            if (container) {
                container.classList.add('player-select-mode');
            }

            showShareToast('Select 2 players to compare');
        }

        function selectPlayerForComparison(playerId, playerName, teamName, position, stats, headshot) {
            if (!comparisonMode) return;

            // Check if already selected
            const existingIndex = comparisonPlayers.findIndex(p => p.id === playerId);
            if (existingIndex >= 0) {
                comparisonPlayers.splice(existingIndex, 1);
                return;
            }

            comparisonPlayers.push({
                id: playerId,
                name: playerName,
                team: teamName,
                position: position,
                stats: stats,
                headshot: headshot
            });

            if (comparisonPlayers.length === 2) {
                showPlayerComparison();
            }
        }

        async function showPlayerComparison() {
            const modal = document.getElementById('player-comparison-modal');
            const content = document.getElementById('comparison-modal-content');

            modal.classList.add('show');
            comparisonMode = false;

            // Remove selection mode from all boxscores
            document.querySelectorAll('.player-select-mode').forEach(el => {
                el.classList.remove('player-select-mode');
            });

            const p1 = comparisonPlayers[0];
            const p2 = comparisonPlayers[1];

            // Fetch full player data
            try {
                const [data1, data2] = await Promise.all([
                    fetch(`https://site.api.espn.com/apis/common/v3/sports/football/nfl/athletes/${p1.id}`).then(r => r.json()),
                    fetch(`https://site.api.espn.com/apis/common/v3/sports/football/nfl/athletes/${p2.id}`).then(r => r.json())
                ]);

                const a1 = data1.athlete;
                const a2 = data2.athlete;

                const color1 = teamColors[p1.team]?.primary || '#666';
                const color2 = teamColors[p2.team]?.primary || '#666';

                // Build comparison stats based on position
                const stats1 = a1.statsSummary?.statistics || [];
                const stats2 = a2.statsSummary?.statistics || [];

                const getStatValue = (stats, name) => {
                    const stat = stats.find(s => s.name === name);
                    return stat?.value || stat?.displayValue || '0';
                };

                // Determine which stats to compare based on position
                let compareStats = [];
                const pos1 = a1.position?.abbreviation || '';
                const pos2 = a2.position?.abbreviation || '';

                if (['QB'].includes(pos1) || ['QB'].includes(pos2)) {
                    compareStats = [
                        { name: 'passingYards', label: 'Pass Yards' },
                        { name: 'passingTouchdowns', label: 'Pass TD' },
                        { name: 'interceptions', label: 'INT', lowerBetter: true },
                        { name: 'adjQBR', label: 'QBR' }
                    ];
                } else if (['RB', 'FB'].includes(pos1) || ['RB', 'FB'].includes(pos2)) {
                    compareStats = [
                        { name: 'rushingYards', label: 'Rush Yards' },
                        { name: 'rushingTouchdowns', label: 'Rush TD' },
                        { name: 'receivingYards', label: 'Rec Yards' },
                        { name: 'yardsPerRushAttempt', label: 'YPC' }
                    ];
                } else if (['WR', 'TE'].includes(pos1) || ['WR', 'TE'].includes(pos2)) {
                    compareStats = [
                        { name: 'receptions', label: 'Receptions' },
                        { name: 'receivingYards', label: 'Rec Yards' },
                        { name: 'receivingTouchdowns', label: 'Rec TD' },
                        { name: 'yardsPerReception', label: 'YPR' }
                    ];
                } else {
                    // Defensive stats
                    compareStats = [
                        { name: 'totalTackles', label: 'Tackles' },
                        { name: 'sacks', label: 'Sacks' },
                        { name: 'interceptions', label: 'INT' },
                        { name: 'passesDefended', label: 'PD' }
                    ];
                }

                let statsHtml = compareStats.map(stat => {
                    const val1 = parseFloat(getStatValue(stats1, stat.name)) || 0;
                    const val2 = parseFloat(getStatValue(stats2, stat.name)) || 0;
                    const better1 = stat.lowerBetter ? val1 < val2 : val1 > val2;
                    const better2 = stat.lowerBetter ? val2 < val1 : val2 > val1;

                    return `
                        <div class="comparison-stat-row">
                            <div class="comparison-stat-value left ${better1 && val1 !== val2 ? 'better' : ''}">${val1}</div>
                            <div class="comparison-stat-label">${stat.label}</div>
                            <div class="comparison-stat-value right ${better2 && val1 !== val2 ? 'better' : ''}">${val2}</div>
                        </div>
                    `;
                }).join('');

                content.innerHTML = `
                    <div class="comparison-players">
                        <div class="comparison-player-card" style="--team-color: ${color1}">
                            <img src="${a1.headshot?.href || ''}" alt="" onerror="this.style.display='none'">
                            <h4>${a1.displayName}</h4>
                            <div class="position">${pos1} - ${p1.team}</div>
                        </div>
                        <div class="comparison-player-card" style="--team-color: ${color2}">
                            <img src="${a2.headshot?.href || ''}" alt="" onerror="this.style.display='none'">
                            <h4>${a2.displayName}</h4>
                            <div class="position">${pos2} - ${p2.team}</div>
                        </div>
                    </div>
                    <div class="comparison-stats">
                        ${statsHtml}
                    </div>
                `;
            } catch (e) {
                console.error('Comparison error:', e);
                content.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--accent-danger);">Failed to load player data</div>';
            }
        }

        function closeComparisonModal(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('player-comparison-modal').classList.remove('show');
            comparisonPlayers = [];
            comparisonMode = false;
            document.querySelectorAll('.player-select-mode').forEach(el => {
                el.classList.remove('player-select-mode');
            });
        }

        // ============================================
        // FEATURE 2: Check if team is eliminated (helper)
        // ============================================
        function isTeamEliminated(teamName) {
            return eliminatedTeams.has(teamName);
        }

        // ============================================
        // NEW FEATURE: PLAY-BY-PLAY FEED
        // ============================================
        const playByPlayCache = {};

        async function togglePlayByPlay(index, eventId) {
            const content = document.getElementById(`pbp-${index}`);
            const btn = content.previousElementSibling;

            if (content.classList.contains('show')) {
                content.classList.remove('show');
                btn.classList.remove('expanded');
                return;
            }

            btn.querySelector('span:first-child').textContent = 'Loading...';

            try {
                let data = playByPlayCache[eventId];
                if (!data) {
                    const response = await fetch(`https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=${eventId}`);
                    data = await response.json();
                    playByPlayCache[eventId] = data;
                }

                const drives = data.drives?.previous || [];
                const currentDrive = data.drives?.current;
                const header = data.header;

                // Get team info
                const teams = {};
                if (header?.competitions?.[0]) {
                    header.competitions[0].competitors.forEach(c => {
                        teams[c.id] = {
                            abbr: c.team.abbreviation,
                            name: c.team.displayName,
                            logo: c.team.logos?.[0]?.href || '',
                            color: teamColors[c.team.displayName]?.primary || '#666'
                        };
                    });
                }

                let html = '<div class="play-by-play-container">';

                // Current drive plays (most recent)
                if (currentDrive?.plays?.length > 0) {
                    html += '<div class="pbp-live-indicator"><span class="live-dot"></span> Live Drive</div>';
                    currentDrive.plays.slice().reverse().slice(0, 10).forEach(play => {
                        html += renderPlay(play, teams, currentDrive.team?.id);
                    });
                }

                // Previous drives
                const recentDrives = drives.slice().reverse().slice(0, 3);
                recentDrives.forEach(drive => {
                    if (drive.plays?.length > 0) {
                        const resultText = drive.result || drive.displayResult || '';
                        html += `<div class="pbp-quarter-header">Drive Result: ${resultText}</div>`;
                        drive.plays.slice().reverse().slice(0, 5).forEach(play => {
                            html += renderPlay(play, teams, drive.team?.id);
                        });
                    }
                });

                if (html === '<div class="play-by-play-container">') {
                    html += '<div style="text-align:center;color:var(--text-muted);padding:20px;">No play data available yet</div>';
                }

                html += '</div>';
                content.innerHTML = html;
                content.classList.add('show');
                btn.classList.add('expanded');
            } catch (e) {
                console.error('Play-by-play error:', e);
                content.innerHTML = '<div style="text-align:center;color:var(--accent-danger);padding:15px;">Failed to load plays</div>';
                content.classList.add('show');
                btn.classList.add('expanded');
            }

            btn.querySelector('span:first-child').textContent = 'Play-by-Play';
        }

        function renderPlay(play, teams, teamId) {
            const team = teams[teamId] || { logo: '', color: '#666' };
            const isScoring = play.scoringPlay || play.type?.text?.toLowerCase().includes('touchdown') || play.type?.text?.toLowerCase().includes('field goal');
            const isTurnover = play.type?.text?.toLowerCase().includes('interception') || play.type?.text?.toLowerCase().includes('fumble');

            const yardsGained = play.statYardage || 0;
            const yardsClass = yardsGained < 0 ? 'negative' : '';

            return `
                <div class="pbp-play ${isScoring ? 'scoring' : ''} ${isTurnover ? 'turnover' : ''}" style="--play-color: ${team.color}">
                    <div class="pbp-time">${play.clock?.displayValue || ''}<br>Q${play.period?.number || ''}</div>
                    <img src="${team.logo}" class="pbp-team-logo" alt="" onerror="this.style.display='none'">
                    <div class="pbp-text">
                        ${play.start?.down ? `<span class="pbp-down">${play.start.down}${getOrdinal(play.start.down)} & ${play.start.distance}</span>` : ''}
                        ${play.text || play.type?.text || 'Play'}
                        ${yardsGained !== 0 ? ` <span class="pbp-yards ${yardsClass}">(${yardsGained > 0 ? '+' : ''}${yardsGained} yds)</span>` : ''}
                    </div>
                </div>
            `;
        }

        // ============================================
        // NEW FEATURE: SCORING NOTIFICATIONS
        // ============================================
        let notificationsEnabled = localStorage.getItem('notificationsEnabled') === 'true';
        let lastNotifiedScores = JSON.parse(localStorage.getItem('lastNotifiedScores') || '{}');

        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showShareToast('Notifications not supported');
                return;
            }

            if (Notification.permission === 'granted') {
                notificationsEnabled = !notificationsEnabled;
                localStorage.setItem('notificationsEnabled', notificationsEnabled);
                updateNotificationButton();
                showShareToast(notificationsEnabled ? 'Score alerts enabled!' : 'Score alerts disabled');
            } else if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    notificationsEnabled = true;
                    localStorage.setItem('notificationsEnabled', 'true');
                    updateNotificationButton();
                    showShareToast('Score alerts enabled!');
                }
            } else {
                // Notifications were denied - open settings modal to show help
                openSettingsModal();
            }
        }

        function updateNotificationButton() {
            const btn = document.getElementById('notifications-btn');
            if (btn) {
                btn.classList.toggle('active', notificationsEnabled);
                btn.querySelector('span:last-child').textContent = notificationsEnabled ? 'Alerts On' : 'Alerts';
            }
        }

        function checkAndNotifyScores(events) {
            if (!notificationsEnabled || Notification.permission !== 'granted') return;

            const watchedTeams = getWatchlist();
            if (watchedTeams.length === 0 && !favoriteTeam) return;

            events.forEach(event => {
                const comp = event.competitions[0];
                const home = comp.competitors.find(c => c.homeAway === 'home');
                const away = comp.competitors.find(c => c.homeAway === 'away');
                const status = event.status.type;

                if (status.state !== 'in') return; // Only live games

                const homeScore = parseInt(home.score) || 0;
                const awayScore = parseInt(away.score) || 0;
                const homeTeamName = home.team.displayName;
                const awayTeamName = away.team.displayName;

                // Check if this is a watched team
                const isWatched = watchedTeams.includes(homeTeamName) ||
                                  watchedTeams.includes(awayTeamName) ||
                                  homeTeamName === favoriteTeam ||
                                  awayTeamName === favoriteTeam;

                if (!isWatched) return;

                const eventId = event.id;
                const prevScores = lastNotifiedScores[eventId];

                if (prevScores) {
                    if (homeScore > prevScores.home) {
                        sendScoreNotification(homeTeamName, homeScore, awayTeamName, awayScore, home.team.logo);
                    }
                    if (awayScore > prevScores.away) {
                        sendScoreNotification(awayTeamName, awayScore, homeTeamName, homeScore, away.team.logo);
                    }
                }

                lastNotifiedScores[eventId] = { home: homeScore, away: awayScore };
            });

            localStorage.setItem('lastNotifiedScores', JSON.stringify(lastNotifiedScores));
        }

        function sendScoreNotification(scoringTeam, scoringTeamScore, otherTeam, otherTeamScore, logo) {
            if (Notification.permission === 'granted') {
                const notification = new Notification(`${scoringTeam} Scores!`, {
                    body: `${scoringTeam} ${scoringTeamScore} - ${otherTeamScore} ${otherTeam}`,
                    icon: logo,
                    badge: logo,
                    tag: `score-${scoringTeam}-${Date.now()}`,
                    requireInteraction: false
                });
                setTimeout(() => notification.close(), 5000);
            }
        }

        // ============================================
        // NEW FEATURE: GAME CAST MINI-VIEW
        // ============================================
        let gameCastEventId = null;
        let gameCastInterval = null;

        function showGameCastMini(eventId, awayTeam, homeTeam, awayLogo, homeLogo, awayScore, homeScore, quarter) {
            gameCastEventId = eventId;
            const mini = document.getElementById('game-cast-mini');
            const teamsEl = document.getElementById('mini-teams');
            const statusEl = document.getElementById('mini-quarter');

            teamsEl.innerHTML = `
                <img src="${awayLogo}" alt="">
                <span class="game-cast-mini-score">${awayScore} - ${homeScore}</span>
                <img src="${homeLogo}" alt="">
            `;
            statusEl.textContent = quarter;

            mini.classList.add('visible');

            // Start polling for updates
            if (gameCastInterval) clearInterval(gameCastInterval);
            gameCastInterval = setInterval(() => updateGameCastMini(eventId), 15000);
            updateGameCastMini(eventId);
        }

        async function updateGameCastMini(eventId) {
            try {
                const response = await fetch(`https://site.api.espn.com/apis/site/v2/sports/football/nfl/summary?event=${eventId}`);
                const data = await response.json();

                const situation = data.situation;
                const header = data.header;

                if (!header?.competitions?.[0]) return;

                const comp = header.competitions[0];
                const home = comp.competitors.find(c => c.homeAway === 'home');
                const away = comp.competitors.find(c => c.homeAway === 'away');

                const teamsEl = document.getElementById('mini-teams');
                const statusEl = document.getElementById('mini-quarter');
                const playEl = document.getElementById('mini-play');

                teamsEl.innerHTML = `
                    <img src="${away.team.logos?.[0]?.href || ''}" alt="">
                    <span class="game-cast-mini-score">${away.score || 0} - ${home.score || 0}</span>
                    <img src="${home.team.logos?.[0]?.href || ''}" alt="">
                `;

                statusEl.textContent = comp.status?.type?.shortDetail || 'Live';

                if (situation?.lastPlay?.text) {
                    playEl.textContent = situation.lastPlay.text;
                } else {
                    playEl.textContent = 'Waiting for next play...';
                }

                // Stop if game ended
                if (comp.status?.type?.completed) {
                    closeGameCastMini();
                }
            } catch (e) {
                console.error('Game cast mini update error:', e);
            }
        }

        function closeGameCastMini() {
            document.getElementById('game-cast-mini').classList.remove('visible');
            if (gameCastInterval) {
                clearInterval(gameCastInterval);
                gameCastInterval = null;
            }
            gameCastEventId = null;
        }

        // ============================================
        // NEW FEATURE: SEASON STATS DASHBOARD
        // ============================================
        let seasonStatsData = null;
        let currentStatCategory = 'passing';

        async function fetchSeasonStats() {
            const container = document.getElementById('season-stats-content');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading stats...</div>';

            try {
                // Fetch league leaders through our proxy to avoid CORS
                const response = await fetch('/api/stats');
                seasonStatsData = await response.json();
                renderSeasonStats();
            } catch (e) {
                console.error('Season stats error:', e);
                container.innerHTML = '<div style="text-align:center;color:var(--accent-danger);padding:20px;">Failed to load stats</div>';
            }
        }

        function switchStatCategory(category) {
            currentStatCategory = category;

            // Update tabs
            document.querySelectorAll('.season-stat-tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent.toLowerCase() === category);
            });

            renderSeasonStats();
        }

        function renderSeasonStats() {
            const container = document.getElementById('season-stats-content');
            if (!seasonStatsData) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">No stats available</div>';
                return;
            }

            const categories = seasonStatsData.leaders?.categories || [];
            let targetCategory = null;

            // Find the appropriate category
            switch (currentStatCategory) {
                case 'passing':
                    targetCategory = categories.find(c => c.name === 'passingYards' || c.displayName?.toLowerCase().includes('passing'));
                    break;
                case 'rushing':
                    targetCategory = categories.find(c => c.name === 'rushingYards' || c.displayName?.toLowerCase().includes('rushing'));
                    break;
                case 'receiving':
                    targetCategory = categories.find(c => c.name === 'receivingYards' || c.displayName?.toLowerCase().includes('receiving'));
                    break;
                case 'defense':
                    targetCategory = categories.find(c => c.name === 'totalTackles' || c.name === 'sacks' || c.displayName?.toLowerCase().includes('tackle'));
                    break;
            }

            if (!targetCategory?.leaders?.length) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">No stats available for this category</div>';
                return;
            }

            const leaders = targetCategory.leaders.slice(0, 10);
            const statLabel = targetCategory.displayName || targetCategory.name;

            let html = `<div class="season-stat-category active">`;
            leaders.forEach((leader, index) => {
                const athlete = leader.athlete;
                const value = leader.displayValue || leader.value || '0';

                html += `
                    <div class="season-stat-item" onclick="showPlayerSpotlight('${athlete.id}', '${(athlete.team?.displayName || '').replace(/'/g, "\\'")}')">
                        <div class="season-stat-rank ${index < 3 ? 'top-3' : ''}">${index + 1}</div>
                        <div class="season-stat-player">
                            <img src="${athlete.headshot?.href || ''}" class="season-stat-headshot" alt="" onerror="this.style.display='none'">
                            <div class="season-stat-info">
                                <div class="season-stat-name">${athlete.shortName || athlete.displayName}</div>
                                <div class="season-stat-team">${athlete.team?.abbreviation || ''} - ${athlete.position?.abbreviation || ''}</div>
                            </div>
                        </div>
                        <div class="season-stat-value">${value}</div>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        // ============================================
        // NEW FEATURE: GAME PREDICTIONS
        // ============================================
        let predictions = JSON.parse(localStorage.getItem('gamePredictions') || '{}');

        function makePrediction(eventId, teamName, teamLogo, awayTeam, homeTeam) {
            predictions[eventId] = {
                predictedWinner: teamName,
                awayTeam: awayTeam,
                homeTeam: homeTeam,
                teamLogo: teamLogo,
                timestamp: Date.now()
            };
            localStorage.setItem('gamePredictions', JSON.stringify(predictions));
            updatePredictionStats();

            // Instantly update the UI without refresh
            const section = document.getElementById('prediction-' + eventId);
            if (section) {
                section.innerHTML = `
                    <div class="prediction-locked">
                        <div class="prediction-locked-header">Your Pick</div>
                        <div class="prediction-locked-team">
                            <img src="${teamLogo}" alt="">
                            <span>${teamName}</span>
                        </div>
                        <div class="prediction-locked-status">Locked In</div>
                    </div>
                `;
            }
        }

        function getPrediction(eventId) {
            return predictions[eventId] || null;
        }

        function updatePredictionUI(eventId) {
            const pred = predictions[eventId];
            if (!pred) return;

            const btns = document.querySelectorAll(`[data-prediction-event="${eventId}"]`);
            btns.forEach(btn => {
                const team = btn.dataset.predictionTeam;
                btn.classList.toggle('selected', team === pred.predictedWinner);
            });
        }

        function checkPredictionResult(eventId, winnerTeam) {
            const pred = predictions[eventId];
            if (!pred || pred.result !== undefined) return null;

            const isCorrect = pred.predictedWinner === winnerTeam;
            predictions[eventId].result = isCorrect;
            predictions[eventId].actualWinner = winnerTeam;
            localStorage.setItem('gamePredictions', JSON.stringify(predictions));
            updatePredictionStats();
            return isCorrect;
        }

        function updatePredictionStats() {
            const completed = Object.values(predictions).filter(p => p.result !== undefined);
            const correct = completed.filter(p => p.result === true).length;
            const total = completed.length;
            const pct = total > 0 ? Math.round((correct / total) * 100) : 0;

            document.getElementById('pred-correct').textContent = correct;
            document.getElementById('pred-total').textContent = total;
            document.getElementById('pred-pct').textContent = `${pct}%`;

            // Show/hide stats section
            const section = document.getElementById('prediction-stats-section');
            if (section) {
                section.style.display = total > 0 ? 'block' : 'none';
            }
        }

        function renderPredictionSection(eventId, away, home, isUpcoming, isCompleted) {
            const pred = getPrediction(eventId);

            if (isCompleted && pred) {
                // Show result
                const awayScore = parseInt(away.score) || 0;
                const homeScore = parseInt(home.score) || 0;
                const actualWinner = awayScore > homeScore ? away.team.displayName : home.team.displayName;
                const isCorrect = checkPredictionResult(eventId, actualWinner);

                if (isCorrect !== null) {
                    return `
                        <div class="prediction-section">
                            <div class="prediction-result ${isCorrect ? 'correct' : 'incorrect'}">
                                ${isCorrect ? 'You predicted correctly!' : `You predicted ${pred.predictedWinner} - ${actualWinner} won`}
                            </div>
                        </div>
                    `;
                }
            }

            if (!isUpcoming) return '';

            // If prediction already made, show locked-in state
            if (pred) {
                const predictedTeam = pred.predictedWinner === away.team.displayName ? away : home;
                return `
                    <div class="prediction-section">
                        <div class="prediction-locked">
                            <div class="prediction-locked-header">Your Pick</div>
                            <div class="prediction-locked-team">
                                <img src="${predictedTeam.team.logo}" alt="">
                                <span>${predictedTeam.team.displayName}</span>
                            </div>
                            <div class="prediction-locked-status">Locked In</div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="prediction-section" id="prediction-${eventId}">
                    <div class="prediction-title">Pick the Winner</div>
                    <div class="prediction-buttons">
                        <button class="prediction-btn"
                                onclick="makePrediction('${eventId}', '${away.team.displayName.replace(/'/g, "\\'")}', '${away.team.logo}', '${away.team.displayName.replace(/'/g, "\\'")}', '${home.team.displayName.replace(/'/g, "\\'")}')">
                            <img src="${away.team.logo}" alt="">
                            <span>${away.team.abbreviation}</span>
                        </button>
                        <button class="prediction-btn"
                                onclick="makePrediction('${eventId}', '${home.team.displayName.replace(/'/g, "\\'")}', '${home.team.logo}', '${away.team.displayName.replace(/'/g, "\\'")}', '${home.team.displayName.replace(/'/g, "\\'")}')">
                            <img src="${home.team.logo}" alt="">
                            <span>${home.team.abbreviation}</span>
                        </button>
                    </div>
                </div>
            `;
        }

        // ============================================
        // NEW FEATURE: FAVORITES/WATCHLIST (Multi-team)
        // ============================================
        let watchlist = JSON.parse(localStorage.getItem('teamWatchlist') || '[]');

        function getWatchlist() {
            return watchlist;
        }

        function addToWatchlist(teamName) {
            if (!watchlist.includes(teamName)) {
                watchlist.push(teamName);
                localStorage.setItem('teamWatchlist', JSON.stringify(watchlist));
                renderWatchlist();
            }
        }

        function removeFromWatchlist(teamName) {
            watchlist = watchlist.filter(t => t !== teamName);
            localStorage.setItem('teamWatchlist', JSON.stringify(watchlist));
            renderWatchlist();
        }

        function renderWatchlist() {
            const section = document.getElementById('watchlist-section');
            const container = document.getElementById('watchlist-teams');

            if (watchlist.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            // Get team logos
            const teamLogos = {
                'Arizona Cardinals': 'https://a.espncdn.com/i/teamlogos/nfl/500/ari.png',
                'Atlanta Falcons': 'https://a.espncdn.com/i/teamlogos/nfl/500/atl.png',
                'Baltimore Ravens': 'https://a.espncdn.com/i/teamlogos/nfl/500/bal.png',
                'Buffalo Bills': 'https://a.espncdn.com/i/teamlogos/nfl/500/buf.png',
                'Carolina Panthers': 'https://a.espncdn.com/i/teamlogos/nfl/500/car.png',
                'Chicago Bears': 'https://a.espncdn.com/i/teamlogos/nfl/500/chi.png',
                'Cincinnati Bengals': 'https://a.espncdn.com/i/teamlogos/nfl/500/cin.png',
                'Cleveland Browns': 'https://a.espncdn.com/i/teamlogos/nfl/500/cle.png',
                'Dallas Cowboys': 'https://a.espncdn.com/i/teamlogos/nfl/500/dal.png',
                'Denver Broncos': 'https://a.espncdn.com/i/teamlogos/nfl/500/den.png',
                'Detroit Lions': 'https://a.espncdn.com/i/teamlogos/nfl/500/det.png',
                'Green Bay Packers': 'https://a.espncdn.com/i/teamlogos/nfl/500/gb.png',
                'Houston Texans': 'https://a.espncdn.com/i/teamlogos/nfl/500/hou.png',
                'Indianapolis Colts': 'https://a.espncdn.com/i/teamlogos/nfl/500/ind.png',
                'Jacksonville Jaguars': 'https://a.espncdn.com/i/teamlogos/nfl/500/jax.png',
                'Kansas City Chiefs': 'https://a.espncdn.com/i/teamlogos/nfl/500/kc.png',
                'Las Vegas Raiders': 'https://a.espncdn.com/i/teamlogos/nfl/500/lv.png',
                'Los Angeles Chargers': 'https://a.espncdn.com/i/teamlogos/nfl/500/lac.png',
                'Los Angeles Rams': 'https://a.espncdn.com/i/teamlogos/nfl/500/lar.png',
                'Miami Dolphins': 'https://a.espncdn.com/i/teamlogos/nfl/500/mia.png',
                'Minnesota Vikings': 'https://a.espncdn.com/i/teamlogos/nfl/500/min.png',
                'New England Patriots': 'https://a.espncdn.com/i/teamlogos/nfl/500/ne.png',
                'New Orleans Saints': 'https://a.espncdn.com/i/teamlogos/nfl/500/no.png',
                'New York Giants': 'https://a.espncdn.com/i/teamlogos/nfl/500/nyg.png',
                'New York Jets': 'https://a.espncdn.com/i/teamlogos/nfl/500/nyj.png',
                'Philadelphia Eagles': 'https://a.espncdn.com/i/teamlogos/nfl/500/phi.png',
                'Pittsburgh Steelers': 'https://a.espncdn.com/i/teamlogos/nfl/500/pit.png',
                'San Francisco 49ers': 'https://a.espncdn.com/i/teamlogos/nfl/500/sf.png',
                'Seattle Seahawks': 'https://a.espncdn.com/i/teamlogos/nfl/500/sea.png',
                'Tampa Bay Buccaneers': 'https://a.espncdn.com/i/teamlogos/nfl/500/tb.png',
                'Tennessee Titans': 'https://a.espncdn.com/i/teamlogos/nfl/500/ten.png',
                'Washington Commanders': 'https://a.espncdn.com/i/teamlogos/nfl/500/wsh.png'
            };

            let html = watchlist.map(team => {
                const logo = teamLogos[team] || '';
                const shortName = team.split(' ').pop();
                return `
                    <div class="watchlist-team">
                        <img src="${logo}" alt="">
                        <span>${shortName}</span>
                        <button class="remove-btn" onclick="removeFromWatchlist('${team.replace(/'/g, "\\'")}')">&times;</button>
                    </div>
                `;
            }).join('');

            html += `<button class="watchlist-add-btn" onclick="openWatchlistModal()">+ Add Team</button>`;
            container.innerHTML = html;
        }

        function toggleWatchlistEdit() {
            const section = document.getElementById('watchlist-section');
            const btn = section.querySelector('.watchlist-edit-btn');
            section.classList.toggle('editing');
            btn.textContent = section.classList.contains('editing') ? 'Done' : 'Edit';
        }

        function openWatchlistModal() {
            const modal = document.getElementById('watchlist-modal');
            const container = document.getElementById('watchlist-modal-teams');

            const allTeams = Object.keys(teamColors);
            const teamLogos = {
                'Arizona Cardinals': 'https://a.espncdn.com/i/teamlogos/nfl/500/ari.png',
                'Atlanta Falcons': 'https://a.espncdn.com/i/teamlogos/nfl/500/atl.png',
                'Baltimore Ravens': 'https://a.espncdn.com/i/teamlogos/nfl/500/bal.png',
                'Buffalo Bills': 'https://a.espncdn.com/i/teamlogos/nfl/500/buf.png',
                'Carolina Panthers': 'https://a.espncdn.com/i/teamlogos/nfl/500/car.png',
                'Chicago Bears': 'https://a.espncdn.com/i/teamlogos/nfl/500/chi.png',
                'Cincinnati Bengals': 'https://a.espncdn.com/i/teamlogos/nfl/500/cin.png',
                'Cleveland Browns': 'https://a.espncdn.com/i/teamlogos/nfl/500/cle.png',
                'Dallas Cowboys': 'https://a.espncdn.com/i/teamlogos/nfl/500/dal.png',
                'Denver Broncos': 'https://a.espncdn.com/i/teamlogos/nfl/500/den.png',
                'Detroit Lions': 'https://a.espncdn.com/i/teamlogos/nfl/500/det.png',
                'Green Bay Packers': 'https://a.espncdn.com/i/teamlogos/nfl/500/gb.png',
                'Houston Texans': 'https://a.espncdn.com/i/teamlogos/nfl/500/hou.png',
                'Indianapolis Colts': 'https://a.espncdn.com/i/teamlogos/nfl/500/ind.png',
                'Jacksonville Jaguars': 'https://a.espncdn.com/i/teamlogos/nfl/500/jax.png',
                'Kansas City Chiefs': 'https://a.espncdn.com/i/teamlogos/nfl/500/kc.png',
                'Las Vegas Raiders': 'https://a.espncdn.com/i/teamlogos/nfl/500/lv.png',
                'Los Angeles Chargers': 'https://a.espncdn.com/i/teamlogos/nfl/500/lac.png',
                'Los Angeles Rams': 'https://a.espncdn.com/i/teamlogos/nfl/500/lar.png',
                'Miami Dolphins': 'https://a.espncdn.com/i/teamlogos/nfl/500/mia.png',
                'Minnesota Vikings': 'https://a.espncdn.com/i/teamlogos/nfl/500/min.png',
                'New England Patriots': 'https://a.espncdn.com/i/teamlogos/nfl/500/ne.png',
                'New Orleans Saints': 'https://a.espncdn.com/i/teamlogos/nfl/500/no.png',
                'New York Giants': 'https://a.espncdn.com/i/teamlogos/nfl/500/nyg.png',
                'New York Jets': 'https://a.espncdn.com/i/teamlogos/nfl/500/nyj.png',
                'Philadelphia Eagles': 'https://a.espncdn.com/i/teamlogos/nfl/500/phi.png',
                'Pittsburgh Steelers': 'https://a.espncdn.com/i/teamlogos/nfl/500/pit.png',
                'San Francisco 49ers': 'https://a.espncdn.com/i/teamlogos/nfl/500/sf.png',
                'Seattle Seahawks': 'https://a.espncdn.com/i/teamlogos/nfl/500/sea.png',
                'Tampa Bay Buccaneers': 'https://a.espncdn.com/i/teamlogos/nfl/500/tb.png',
                'Tennessee Titans': 'https://a.espncdn.com/i/teamlogos/nfl/500/ten.png',
                'Washington Commanders': 'https://a.espncdn.com/i/teamlogos/nfl/500/wsh.png'
            };

            container.innerHTML = allTeams.sort().map(team => {
                const isSelected = watchlist.includes(team);
                const logo = teamLogos[team] || '';
                return `
                    <div class="watchlist-modal-team ${isSelected ? 'selected' : ''}" onclick="toggleWatchlistTeam('${team.replace(/'/g, "\\'")}', this)">
                        <img src="${logo}" alt="">
                        <span>${team}</span>
                        <span class="check">&#10003;</span>
                    </div>
                `;
            }).join('');

            modal.classList.add('show');
        }

        function toggleWatchlistTeam(teamName, el) {
            if (watchlist.includes(teamName)) {
                removeFromWatchlist(teamName);
                el.classList.remove('selected');
            } else {
                addToWatchlist(teamName);
                el.classList.add('selected');
            }
        }

        function closeWatchlistModal(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('watchlist-modal').classList.remove('show');
        }

        // ============================================
        // FEATURE: SETTINGS MODAL
        // ============================================
        // Render notification control based on permission state
        function renderNotificationControl() {
            const container = document.getElementById('notifications-control');
            const desc = document.getElementById('notifications-desc');
            const notice = document.getElementById('notification-permission-notice');

            if (Notification.permission === 'granted') {
                // Show toggle for granted permission
                desc.textContent = 'Get notified when your teams score';
                container.innerHTML = `
                    <label class="settings-toggle">
                        <input type="checkbox" id="settings-notifications" ${notificationsEnabled ? 'checked' : ''}>
                        <span class="settings-toggle-slider"></span>
                    </label>
                `;
                notice.style.display = 'none';

                // Add toggle listener
                const toggle = document.getElementById('settings-notifications');
                toggle.addEventListener('change', function() {
                    notificationsEnabled = this.checked;
                    localStorage.setItem('notificationsEnabled', notificationsEnabled);
                    updateNotificationButton();
                    showShareToast(notificationsEnabled ? 'Score alerts enabled!' : 'Score alerts disabled');
                });
            } else if (Notification.permission === 'default') {
                // Show button to request permission
                desc.textContent = 'Allow notifications to get score alerts';
                container.innerHTML = `
                    <button class="settings-btn" id="enable-notifications-btn" style="width: auto; padding: 8px 16px;">
                        Enable
                    </button>
                `;
                notice.style.display = 'none';

                // Add button listener - closes modal first
                document.getElementById('enable-notifications-btn').addEventListener('click', async function() {
                    // Close modal completely
                    closeSettingsModal();

                    // Small delay to ensure modal is gone
                    await new Promise(r => setTimeout(r, 300));

                    // Request permission
                    const permission = await Notification.requestPermission();

                    if (permission === 'granted') {
                        notificationsEnabled = true;
                        localStorage.setItem('notificationsEnabled', 'true');
                        updateNotificationButton();
                        showShareToast('Score alerts enabled!');
                    } else {
                        showShareToast('Notifications blocked by browser');
                    }

                    // Reopen settings modal with updated state
                    setTimeout(() => openSettingsModal(), 300);
                });
            } else {
                // Permission denied - show message
                desc.textContent = 'Notifications are blocked by your browser';
                container.innerHTML = `<span style="color: var(--text-muted); font-size: 0.8rem;">Blocked</span>`;
                notice.style.display = 'flex';
            }
        }

        function openSettingsModal() {
            const modal = document.getElementById('settings-modal');
            const autorefreshToggle = document.getElementById('settings-autorefresh');
            const favoriteTeamSelect = document.getElementById('settings-favorite-team');

            // Populate favorite team dropdown
            const allTeams = Object.keys(teamColors).sort();
            favoriteTeamSelect.innerHTML = '<option value="">None</option>';
            allTeams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                favoriteTeamSelect.appendChild(option);
            });

            // Set current values
            autorefreshToggle.checked = autoRefresh;
            favoriteTeamSelect.value = favoriteTeam;

            // Render notification control based on current permission state
            renderNotificationControl();

            modal.classList.add('show');
        }

        function closeSettingsModal(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('settings-modal').classList.remove('show');
        }

        function initSettingsListeners() {
            // Auto-refresh toggle
            document.getElementById('settings-autorefresh').addEventListener('change', function() {
                autoRefresh = this.checked;
                localStorage.setItem('autoRefresh', autoRefresh);
                document.getElementById('auto-refresh-btn').classList.toggle('active', autoRefresh);
                setupRefreshInterval();
            });

            // Favorite team select
            document.getElementById('settings-favorite-team').addEventListener('change', function() {
                favoriteTeam = this.value;
                if (favoriteTeam) {
                    localStorage.setItem('favoriteTeam', favoriteTeam);
                } else {
                    localStorage.removeItem('favoriteTeam');
                }
                document.getElementById('favorite-team').value = favoriteTeam;
                fetchScores();
            });

            // Settings button click
            document.getElementById('settings-btn').addEventListener('click', openSettingsModal);
        }

        async function requestNotificationPermissionFromSettings() {
            // Close modal so browser permission popup is visible
            closeSettingsModal();

            await new Promise(r => setTimeout(r, 300));

            const permission = await Notification.requestPermission();

            if (permission === 'granted') {
                notificationsEnabled = true;
                localStorage.setItem('notificationsEnabled', 'true');
                updateNotificationButton();
                showShareToast('Score alerts enabled!');
            } else {
                showShareToast('Notifications still blocked - check browser settings');
            }

            // Reopen modal with updated state
            setTimeout(() => openSettingsModal(), 300);
            return false;
        }

        // ============================================
        // NEW FEATURE: GAME CALENDAR EXPORT
        // ============================================
        function exportToCalendar(eventId, awayTeam, homeTeam, gameDate, venue) {
            const startDate = new Date(gameDate);
            const endDate = new Date(startDate.getTime() + 3.5 * 60 * 60 * 1000); // 3.5 hours later

            const formatICSDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };

            const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//NFL Scores App//EN
BEGIN:VEVENT
UID:${eventId}@nfl-scores-app
DTSTART:${formatICSDate(startDate)}
DTEND:${formatICSDate(endDate)}
SUMMARY:${awayTeam} @ ${homeTeam}
DESCRIPTION:NFL Game - ${awayTeam} vs ${homeTeam}
LOCATION:${venue || 'TBD'}
END:VEVENT
END:VCALENDAR`;

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${awayTeam.replace(/\s+/g, '-')}-vs-${homeTeam.replace(/\s+/g, '-')}.ics`;
            link.click();
            URL.revokeObjectURL(link.href);

            showShareToast('Calendar event downloaded!');
        }

        // Initialize notifications button
        document.getElementById('notifications-btn').addEventListener('click', requestNotificationPermission);

        // Init
        initFavoriteTeam();
        initSettingsListeners();
        updateDateDisplay();
        fetchScores();
        setupRefreshInterval();
        renderWatchlist();
        updatePredictionStats();
        updateNotificationButton();
    </script>

<!-- Version Footer - Auto-updated by pre-commit hook -->
<footer id="version-footer" data-version-footer data-version="v1.0.0-27-g6a8532b (6a8532b)" data-commit-time="Commit: 2026-01-14  2:02 PM CST" data-build-time="Build: 2026-01-14  2:03 PM CST" style="
    background: #1a1a2e;
    color: #888;
    font-size: 11px;
    padding: 8px 12px;
    font-family: monospace;
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 20px;
">
    <span class="version"></span>
    <span class="commit-time"></span>
    <span class="build-time"></span>
</footer>
<script>
(function() {
    const footer = document.getElementById('version-footer');
    if (footer) {
        const v = footer.dataset.version;
        const ct = footer.dataset.commitTime;
        const bt = footer.dataset.buildTime;
        footer.querySelector('.version').textContent = v || 'v0.0.0';
        footer.querySelector('.commit-time').textContent = ct || '';
        footer.querySelector('.build-time').textContent = bt || '';
    }
})();
</script>

</body>
</html>
